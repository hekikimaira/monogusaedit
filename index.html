<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>„ÇÇ„ÅÆ„Åê„Åï„Ç∑„Éï„Éà„Ç´„É¨„É≥„ÉÄ„Éº</title>
  
  <!-- PWAÂØæÂøú -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#3498db">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="„ÇÇ„ÅÆ„Åê„Åï">
  <link rel="apple-touch-icon" href="icon192.webp">
  
  <!-- OGP -->
  <meta name="description" content="„Ç∑„É≥„Éó„É´„Åß‰Ωø„ÅÑ„ÇÑ„Åô„ÅÑÁ∏¶Âûã„Ç∑„Éï„Éà„Ç´„É¨„É≥„ÉÄ„Éº„ÄÇ„Ç∑„Éï„ÉàËá™ÂãïÂÖ•Âäõ„ÄÅÁ•ùÊó•ÂØæÂøú„ÄÅ„Ç™„Éï„É©„Ç§„É≥ÂØæÂøú„ÄÇ">
  <meta property="og:title" content="„ÇÇ„ÅÆ„Åê„Åï„Ç∑„Éï„Éà„Ç´„É¨„É≥„ÉÄ„Éº">
  <meta property="og:description" content="„Ç∑„É≥„Éó„É´„Åß‰Ωø„ÅÑ„ÇÑ„Åô„ÅÑÁ∏¶Âûã„Ç∑„Éï„Éà„Ç´„É¨„É≥„ÉÄ„Éº">
  <meta property="og:type" content="website">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;
      background: var(--bg-color, #f0f0f0);
      min-height: 100vh;
    }

    :root {
      --primary-color: #3498db;
      --header-color: #2c3e50;
      --bg-color: #f0f0f0;
      --card-bg: #ffffff;
      --text-color: #333333;
      --sub-text: #666666;
      --font-size: 14px;
      --input-padding: 10px 12px;
      --row-height: 44px;
      --memo-height: 44px;
    }

    .page {
      display: none;
    }
    .page.active {
      display: block;
    }

    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: linear-gradient(135deg, var(--header-color), color-mix(in srgb, var(--header-color) 80%, white));
      color: #fff;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .header button {
      background: rgba(255,255,255,0.2);
      color: #fff;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .header button:hover {
      background: rgba(255,255,255,0.3);
    }

    .header .year-display {
      font-size: 24px;
      font-weight: bold;
      min-width: 120px;
      text-align: center;
      letter-spacing: 2px;
    }

    .edit-mode-btn {
      background: rgba(255,255,255,0.2) !important;
      width: auto !important;
      padding: 0 16px !important;
      font-size: 13px !important;
      border-radius: 20px !important;
    }

    .edit-mode-btn.active {
      background: #e74c3c !important;
    }

    .history-btn {
      font-size: 18px !important;
      position: relative;
    }
    .history-btn span {
      font-size: 10px;
      position: absolute;
      top: 2px;
      right: 2px;
      background: #e74c3c;
      color: white;
      border-radius: 50%;
      min-width: 16px;
      height: 16px;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .history-btn span:not(:empty) { display: flex; }

    /* „Ç∑„Éï„ÉàÂ±•Ê≠¥„Ç™„Éº„Éê„Éº„É¨„Ç§ */
    .shift-history-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      display: flex;
      justify-content: center;
      padding-top: 60px;
    }
    .shift-history-panel {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 70vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .shift-history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid #ddd;
      font-weight: bold;
      color: #333;
    }
    .shift-history-close {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #666;
      padding: 5px 10px;
    }
    .shift-history-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }
    .shift-history-item {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .shift-history-item:hover {
      border-color: #4CAF50;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .shift-history-date {
      font-size: 12px;
      color: #888;
      margin-bottom: 4px;
    }
    .shift-history-type {
      font-size: 11px;
      color: #4CAF50;
      margin-bottom: 4px;
    }
    .shift-history-preview {
      font-size: 13px;
      color: #333;
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
      background: var(--card-bg);
      min-height: calc(100vh - 85px);
    }

    .month-header {
      background: var(--primary-color);
      color: #fff;
      padding: 10px 16px;
      font-size: 18px;
      font-weight: bold;
      position: sticky;
      top: 64px;
      z-index: 50;
    }

    .day-row {
      display: grid;
      grid-template-columns: 44px 36px 1fr;
      border-bottom: 1px solid color-mix(in srgb, var(--text-color) 15%, transparent);
      min-height: var(--row-height);
    }

    .day-date {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: bold;
      color: var(--text-color);
      background: color-mix(in srgb, var(--bg-color) 50%, var(--card-bg));
      border-right: 1px solid color-mix(in srgb, var(--text-color) 15%, transparent);
      cursor: pointer;
      user-select: none;
      transition: filter 0.1s;
    }

    .day-date:active {
      filter: brightness(0.95);
    }

    .day-weekday {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: bold;
      color: var(--sub-text);
      background: color-mix(in srgb, var(--bg-color) 50%, var(--card-bg));
      border-right: 1px solid color-mix(in srgb, var(--text-color) 15%, transparent);
      cursor: pointer;
      user-select: none;
      transition: filter 0.1s;
    }

    .day-weekday:active {
      filter: brightness(0.95);
    }

    .day-row.sunday .day-date,
    .day-row.sunday .day-weekday {
      color: #e74c3c;
      background: color-mix(in srgb, #e74c3c 8%, var(--card-bg));
    }

    .day-row.saturday .day-date,
    .day-row.saturday .day-weekday {
      color: #3498db;
      background: color-mix(in srgb, #3498db 8%, var(--card-bg));
    }

    .day-row.holiday .day-date,
    .day-row.holiday .day-weekday {
      color: #e74c3c;
      background: color-mix(in srgb, #e74c3c 8%, var(--card-bg));
    }

    .day-row.today {
      background: color-mix(in srgb, #f1c40f 15%, var(--card-bg));
    }

    .day-row.today .day-date,
    .day-row.today .day-weekday {
      background: color-mix(in srgb, #f1c40f 25%, var(--card-bg));
    }

    .memos-container {
      display: flex;
      flex-direction: column;
      min-height: var(--row-height);
    }

    .memo-item {
      display: flex;
      align-items: stretch;
      border-bottom: 1px dashed color-mix(in srgb, var(--text-color) 10%, transparent);
      position: relative;
    }

    .memo-item:last-child {
      border-bottom: none;
    }

    .memo-input {
      flex: 1;
      padding: var(--input-padding);
      font-size: var(--font-size);
      border: none;
      outline: none;
      background: transparent;
      min-height: var(--memo-height);
      line-height: 1.4;
      color: var(--memo-text-color, var(--text-color));
    }

    .memo-input::placeholder {
      color: var(--sub-text);
      opacity: 0.6;
    }

    .memo-input:focus {
      background: color-mix(in srgb, var(--primary-color) 8%, transparent);
    }

    .memo-input.holiday-auto {
      color: #e74c3c;
      font-weight: 500;
    }

    .edit-mode .memo-item:first-child .memo-input {
      background: #e8f5e9;
      cursor: pointer;
    }

    .edit-mode .memo-item:first-child .memo-input:hover {
      background: #c8e6c9;
    }

    .memo-menu-btn {
      width: 32px;
      background: transparent;
      border: none;
      color: var(--memo-text-color, #bbb);
      font-size: 16px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .memo-item:hover .memo-menu-btn,
    .memo-item:focus-within .memo-menu-btn {
      opacity: 1;
    }

    .memo-menu-btn:hover {
      color: var(--memo-text-color, #666);
    }

    .floating-menu {
      position: fixed;
      right: 16px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.25);
      overflow: hidden;
      z-index: 200;
      display: none;
    }

    .floating-menu.show {
      display: block;
    }

    .floating-menu button {
      display: block;
      width: 100%;
      padding: 14px 24px;
      border: none;
      background: #fff;
      font-size: 15px;
      cursor: pointer;
      text-align: left;
    }

    .floating-menu button:hover {
      background: #f5f5f5;
    }

    .floating-menu button.add {
      color: #27ae60;
    }

    .floating-menu button.delete {
      color: #e74c3c;
    }

    .floating-menu button + button {
      border-top: 1px solid #eee;
    }

    /* „Ç™„Éó„Ç∑„Éß„É≥„É°„Éã„É•„Éº */
    .options-menu {
      position: fixed;
      top: 48px;
      right: -280px;
      width: 280px;
      height: calc(100% - 48px);
      background: #fff;
      box-shadow: -2px 0 8px rgba(0,0,0,0.2);
      z-index: 250;
      transition: right 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .options-menu.show {
      right: 0;
    }

    .options-menu-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
      background: var(--header-color, #2c3e50);
      color: #fff;
    }

    .options-menu-header h2 {
      margin: 0;
      font-size: 1rem;
      font-weight: 500;
    }


    .options-menu-list {
      flex: 1;
      overflow-y: auto;
    }

    .options-menu button {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
      padding: 16px 20px;
      border: none;
      background: #fff;
      font-size: 15px;
      cursor: pointer;
      text-align: left;
    }

    .options-menu button:hover {
      background: #f5f5f5;
    }

    .options-menu button + button {
      border-top: 1px solid #eee;
    }

    .options-menu .icon {
      font-size: 18px;
      width: 24px;
      text-align: center;
    }

    .menu-section-label {
      padding: 10px 20px 6px;
      font-size: 11px;
      font-weight: bold;
      color: #888;
      background: #f5f5f5;
      border-top: 1px solid #eee;
      border-bottom: 1px solid #eee;
    }

    /* „Çø„ÉñÂà•„É°„Éã„É•„ÉºË°®Á§∫Âà∂Âæ° */
    .options-menu-list .menu-shift-only,
    .options-menu-list .menu-kakeibo-only,
    .options-menu-list .menu-memo-only {
      display: none !important;
    }
    body.current-tab-shift .options-menu-list .menu-shift-only {
      display: flex !important;
    }
    body.current-tab-shift .options-menu-list .menu-section-label.menu-shift-only {
      display: block !important;
    }
    body.current-tab-kakeibo .options-menu-list .menu-kakeibo-only {
      display: flex !important;
    }
    body.current-tab-kakeibo .options-menu-list .menu-section-label.menu-kakeibo-only {
      display: block !important;
    }
    body.current-tab-memo .options-menu-list .menu-memo-only {
      display: flex !important;
    }
    body.current-tab-memo .options-menu-list .menu-section-label.menu-memo-only {
      display: block !important;
    }

    .today-btn {
      position: fixed;
      bottom: 100px;
      right: 20px;
      background: var(--primary-color);
      color: #fff;
      border: none;
      padding: 12px 20px;
      border-radius: 24px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(52,152,219,0.4);
      z-index: 100;
    }

    .today-btn:hover {
      filter: brightness(0.9);
    }

    .pattern-float-btn {
      position: fixed;
      bottom: 150px;
      right: 20px;
      background: #27ae60;
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(39,174,96,0.4);
      z-index: 100;
      display: none;
    }

    .pattern-float-btn.show {
      display: block;
    }

    .pattern-float-btn:hover {
      background: #219a52;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 300;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: #fff;
      border-radius: 12px;
      width: 100%;
      max-width: 400px;
      max-height: 80vh;
      overflow: auto;
    }

    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid #eee;
      font-size: 18px;
      font-weight: bold;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .modal label {
      display: block;
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 8px;
      color: #333;
    }

    .modal select,
    .modal input[type="number"],
    .modal input[type="text"] {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .modal select:focus,
    .modal input:focus {
      outline: none;
      border-color: #3498db;
    }

    .modal .hint {
      font-size: 12px;
      color: #888;
      margin-top: -12px;
      margin-bottom: 16px;
    }

    .modal-btn {
      padding: 10px 24px;
      border: none;
      border-radius: 6px;
      font-size: 15px;
      cursor: pointer;
    }

    .modal-btn.cancel {
      background: #eee;
      color: #333;
    }

    .modal-btn.primary {
      background: var(--primary-color);
      color: #fff;
    }

    .modal-btn.danger {
      background: #e74c3c;
      color: #fff;
    }

    .confirm-text {
      font-size: 15px;
      line-height: 1.6;
      margin-bottom: 16px;
    }

    .confirm-date {
      background: #f5f5f5;
      padding: 12px 16px;
      border-radius: 8px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 16px;
    }

    .confirm-info {
      background: #e8f5e9;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
    }

    .confirm-info div {
      margin: 4px 0;
    }

    .edit-banner {
      background: #27ae60;
      color: #fff;
      padding: 12px 16px;
      text-align: center;
      font-size: 14px;
      display: none;
    }

    .edit-banner.show {
      display: block;
    }

    .edit-banner button {
      background: rgba(255,255,255,0.2);
      border: none;
      color: #fff;
      padding: 6px 16px;
      border-radius: 4px;
      margin-left: 12px;
      cursor: pointer;
    }

    /* „Éá„Ç∂„Ç§„É≥Ë®≠ÂÆö */
    .theme-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 20px;
      max-height: 300px;
      overflow-y: auto;
    }

    .theme-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border: 2px solid #eee;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .theme-option:hover {
      border-color: #ccc;
    }

    .theme-option.selected {
      border-color: #333;
      background: #f8f8f8;
    }

    .theme-preview {
      display: flex;
      width: 60px;
      height: 36px;
      border-radius: 4px;
      overflow: hidden;
      flex-shrink: 0;
    }

    .theme-preview-header {
      width: 20px;
    }

    .theme-preview-body {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .theme-preview-row {
      flex: 1;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .theme-name {
      font-weight: bold;
      font-size: 14px;
    }

    .theme-desc {
      font-size: 12px;
      color: #888;
    }

    .design-section {
      margin-bottom: 20px;
    }

    .design-section label {
      display: block;
      margin-bottom: 12px;
    }

    .size-options {
      display: flex;
      gap: 8px;
    }

    .size-option {
      flex: 1;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      font-size: 13px;
    }

    .size-option.selected {
      border-color: #333;
      background: #f0f0f0;
    }

    /* Âïè„ÅÑÂêà„Çè„Åõ„É¢„Éº„ÉÄ„É´ */
    .contact-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .contact-btn {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fff;
      font-size: 16px;
      cursor: pointer;
      text-decoration: none;
      color: #333;
    }

    .contact-btn:hover {
      background: #f5f5f5;
    }

    .contact-btn .icon {
      font-size: 24px;
    }

    /* Ë®≠ÂÆö„Éö„Éº„Ç∏ */
    .settings-page {
      background: #fff;
      min-height: 100vh;
    }

    .settings-header {
      background: linear-gradient(135deg, #8e44ad, #9b59b6);
      color: #fff;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .settings-header h1 {
      font-size: 20px;
      flex: 1;
    }

    .back-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: #fff;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
    }

    .pattern-list {
      padding: 16px;
    }

    .pattern-card {
      background: #f8f9fa;
      border-radius: 12px;
      margin-bottom: 16px;
      overflow: hidden;
      border: 2px solid transparent;
    }

    .pattern-card.selected {
      border-color: #27ae60;
    }

    .pattern-card-header {
      background: #fff;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #eee;
    }

    .pattern-name {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }

    .pattern-badge {
      background: #27ae60;
      color: #fff;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      display: none;
    }

    .pattern-card.selected .pattern-badge {
      display: inline-block;
    }

    .pattern-card-body {
      padding: 16px;
    }

    .pattern-card textarea {
      width: 100%;
      height: 100px;
      padding: 12px;
      font-size: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      resize: vertical;
      font-family: inherit;
    }

    .pattern-card textarea:focus {
      outline: none;
      border-color: #9b59b6;
    }

    .pattern-hint {
      font-size: 12px;
      color: #888;
      margin-top: 8px;
    }

    .pattern-preview {
      margin-top: 12px;
      padding: 10px 12px;
      background: #fff;
      border-radius: 6px;
      font-size: 13px;
      color: #666;
    }

    .pattern-preview span {
      display: inline-block;
      background: #e8e8e8;
      padding: 2px 8px;
      border-radius: 4px;
      margin: 2px;
    }

    .settings-footer {
      padding: 16px;
      border-top: 1px solid #eee;
      background: #fff;
      position: sticky;
      bottom: 0;
    }

    .save-all-btn {
      width: 100%;
      padding: 14px;
      background: #9b59b6;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }

    .save-all-btn:hover {
      background: #8e44ad;
    }

    /* „Éà„Éº„Çπ„ÉàÈÄöÁü• */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 400;
      display: none;
    }

    .toast.show {
      display: block;
      animation: fadeInOut 2s ease;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
      15% { opacity: 1; transform: translateX(-50%) translateY(0); }
      85% { opacity: 1; transform: translateX(-50%) translateY(0); }
      100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
    }

    /* „Éï„Ç°„Ç§„É´ÂÖ•Âäõ„ÇíÈö†„Åô */
    #importInput {
      display: none;
    }

    /* PROÁâàÁâπÂÖ∏„É™„Çπ„Éà */
    .pro-benefits {
      background: linear-gradient(135deg, #fff9e6, #fff3cd);
      border-radius: 8px;
      padding: 16px;
    }

    .pro-benefit-item {
      padding: 8px 0;
      font-size: 15px;
    }

    .pro-benefit-item + .pro-benefit-item {
      border-top: 1px dashed #e0d5b0;
    }

    .pro-code-box {
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      font-family: monospace;
      font-size: 12px;
      word-break: break-all;
      text-align: center;
      color: #333;
    }

    .pro-purchase-btn {
      display: block;
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #34a853, #0f9d58);
      color: #fff;
      text-align: center;
      text-decoration: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(15, 157, 88, 0.3);
    }

    .pro-purchase-btn:hover {
      filter: brightness(1.05);
    }

    /* „Ç§„É≥„Éù„Éº„Éà„É¢„Éº„ÉâÈÅ∏Êäû */
    .import-mode-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .import-mode-btn {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      background: #fff;
      cursor: pointer;
      text-align: left;
      transition: all 0.2s;
    }

    .import-mode-btn:hover {
      border-color: var(--primary-color);
      background: color-mix(in srgb, var(--primary-color) 5%, white);
    }

    .import-mode-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .import-mode-title {
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }

    .import-mode-desc {
      font-size: 13px;
      color: #666;
      margin-top: 4px;
    }

    /* „Çπ„ÉÜ„Éº„Çø„Çπ„Ç´„É©„ÉºË®≠ÂÆö */
    .status-color-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .status-color-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: #fff;
    }

    .status-color-preview {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      border: 1px solid #ddd;
      flex-shrink: 0;
    }

    .status-color-name {
      flex: 1;
      font-size: 14px;
    }

    .status-color-toggle {
      position: relative;
      width: 48px;
      height: 26px;
      background: #ddd;
      border-radius: 13px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .status-color-toggle.on {
      background: var(--primary-color);
    }

    .status-color-toggle::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 20px;
      height: 20px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.2s;
    }

    .status-color-toggle.on::after {
      transform: translateX(22px);
    }

    .status-color-item.disabled {
      opacity: 0.5;
    }

    .status-color-item:first-child .status-color-toggle {
      display: none;
    }

    .status-color-item:first-child::after {
      content: 'Â∏∏„Å´ON';
      font-size: 11px;
      color: #888;
    }

    /* ========== „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ ========== */
    .main-tab-nav {
      display: flex;
      background: #2c3e50;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .main-tab-btn {
      flex: 1;
      padding: 12px 8px;
      border: none;
      background: #2c3e50;
      color: #7f8c8d;
      font-size: 13px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      border-bottom: 3px solid transparent;
    }
    .main-tab-btn:hover { background: #34495e; color: #bdc3c7; }
    .main-tab-btn.active { background: #34495e; color: #fff; }
    .main-tab-btn.active.shift-tab { border-bottom-color: #3498db; }
    .main-tab-btn.active.kakeibo-tab { border-bottom-color: #4CAF50; }
    .main-tab-btn.active.memo-tab { border-bottom-color: #60a5fa; }
    .global-menu-btn {
      padding: 12px 16px;
      border: none;
      background: #2c3e50;
      color: #fff;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      z-index: 1001;
    }
    .global-menu-btn:hover { background: #34495e; }
    .main-tab-content { display: none; }
    .main-tab-content.active { display: block; }

    /* „Ç∑„Éï„Éà„Çø„Éñ„Åå„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™ÊôÇ„ÅÆ„Éò„ÉÉ„ÉÄ„Éº‰ΩçÁΩÆË™øÊï¥Ôºà„Çø„Éñ48pxÔºâ */
    .shift-tab-content .header { top: 48px; }
    .shift-tab-content .month-header { top: 112px; }
    .shift-tab-content .settings-header { top: 48px; }

    /* ========== ÂÆ∂Ë®àÁ∞ø„Çπ„Çø„Ç§„É´ ========== */
    .kakeibo-app { background: var(--bg-color, #f5f5f5); padding: 10px; min-height: calc(100vh - 85px); }
    .kakeibo-container { max-width: 700px; margin: 0 auto; background: var(--card-bg, white); border: 1px solid color-mix(in srgb, var(--text-color, #333) 15%, transparent); padding: 15px; border-radius: 8px; }
    
    /* ÂÆ∂Ë®àÁ∞ø Ë°å„É¨„Ç§„Ç¢„Ç¶„Éà */
    .kakeibo-row { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; align-items: center; }
    .kakeibo-name-input { 
      flex: 1; min-width: 150px; padding: 10px 12px; font-size: var(--font-size, 14px); 
      border: 1px solid color-mix(in srgb, var(--text-color, #333) 30%, transparent); border-radius: 6px;
      background: var(--card-bg, white); color: var(--text-color, #333);
    }
    .kakeibo-name-input:focus { outline: none; border-color: var(--primary-color, #4CAF50); }
    .kakeibo-select { padding: 10px 12px; font-size: var(--font-size, 14px); border: 1px solid color-mix(in srgb, var(--text-color, #333) 30%, transparent); border-radius: 6px; background: var(--card-bg, white); color: var(--text-color, #333); cursor: pointer; min-width: 100px; }
    .kakeibo-select-wide { flex: 1; min-width: 150px; padding: 10px 12px; font-size: var(--font-size, 14px); border: 1px solid color-mix(in srgb, var(--text-color, #333) 30%, transparent); border-radius: 6px; background: var(--card-bg, white); color: var(--text-color, #333); cursor: pointer; }
    .kakeibo-btn { 
      padding: 10px 16px; font-size: var(--font-size, 14px); border: 1px solid color-mix(in srgb, var(--text-color, #333) 30%, transparent); 
      background: var(--card-bg, white); color: var(--text-color, #333); cursor: pointer; border-radius: 6px; white-space: nowrap;
    }
    .kakeibo-btn:hover { background: color-mix(in srgb, var(--primary-color, #4CAF50) 10%, var(--card-bg, white)); }
    .kakeibo-btn-primary { background: var(--primary-color, #4CAF50); color: white; border-color: var(--primary-color, #4CAF50); }
    .kakeibo-btn-primary:hover { background: color-mix(in srgb, var(--primary-color, #4CAF50) 80%, black); }
    .kakeibo-btn-small { padding: 6px 12px; font-size: 12px; border: 1px solid color-mix(in srgb, var(--text-color, #333) 30%, transparent); background: var(--card-bg, white); color: var(--text-color, #333); cursor: pointer; border-radius: 4px; }
    
    /* Â±•Ê≠¥„Çπ„É©„Ç§„ÉÄ„Éº */
    .kakeibo-history-slider {
      background: color-mix(in srgb, var(--bg-color, #f5f5f5) 80%, var(--card-bg, white)); border: 1px solid color-mix(in srgb, var(--text-color, #333) 15%, transparent); border-radius: 8px;
      margin-bottom: 15px; overflow: hidden;
    }
    .kakeibo-history-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 15px; background: color-mix(in srgb, var(--primary-color, #4CAF50) 15%, var(--card-bg, white)); border-bottom: 1px solid color-mix(in srgb, var(--text-color, #333) 15%, transparent);
      font-size: 13px; font-weight: bold; color: var(--text-color, #555);
    }
    .kakeibo-history-scroll {
      display: flex; overflow-x: auto; padding: 10px; gap: 10px;
      scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch;
    }
    .kakeibo-history-scroll::-webkit-scrollbar { height: 6px; }
    .kakeibo-history-scroll::-webkit-scrollbar-thumb { background: color-mix(in srgb, var(--text-color, #333) 30%, transparent); border-radius: 3px; }
    .kakeibo-history-item {
      flex: 0 0 200px; scroll-snap-align: start;
      background: var(--card-bg, white); border: 1px solid color-mix(in srgb, var(--text-color, #333) 20%, transparent); border-radius: 6px;
      padding: 10px; cursor: pointer; transition: all 0.2s;
    }
    .kakeibo-history-item:hover { border-color: var(--primary-color, #4CAF50); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .kakeibo-history-date { font-size: 11px; color: var(--sub-text, #888); margin-bottom: 4px; }
    .kakeibo-history-type { font-size: 10px; color: var(--primary-color, #4CAF50); margin-bottom: 4px; }
    .kakeibo-history-balance { font-size: 14px; font-weight: bold; color: var(--text-color, #333); }
    .kakeibo-history-name { font-size: 11px; color: var(--sub-text, #666); margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    
    .kakeibo-app .balance { background: #ffebee; color: #c62828; padding: 12px; text-align: center; margin-bottom: 15px; font-weight: bold; font-size: 20px; cursor: pointer; border-radius: 6px; }
    .kakeibo-app .balance.positive { background: #e8f5e9; color: #2e7d32; }
    .kakeibo-app .section { margin-bottom: 12px; }
    .kakeibo-app .section h3 { font-size: var(--font-size, 14px); margin-bottom: 5px; padding: 5px 0; border-bottom: 2px solid var(--primary-color, #333); color: var(--text-color, #333); }
    .kakeibo-app textarea { width: 100%; padding: 10px; font-size: var(--font-size, 14px); font-family: monospace; border: 1px solid color-mix(in srgb, var(--text-color, #333) 30%, transparent); border-radius: 6px; resize: vertical; background: var(--card-bg, white); color: var(--text-color, #333); }
    .kakeibo-app textarea:focus { outline: none; border-color: var(--primary-color, #4CAF50); }
    .kakeibo-app .income-area { min-height: 100px; }
    .kakeibo-app .expense-area { min-height: 150px; }
    .kakeibo-app .template-area { min-height: 80px; }
    .kakeibo-app .total { background: color-mix(in srgb, var(--bg-color, #f5f5f5) 50%, var(--card-bg, white)); padding: 8px 10px; margin-top: 5px; text-align: right; font-size: var(--font-size, 14px); font-weight: bold; border-radius: 4px; color: var(--text-color, #333); }
    .kakeibo-app .template-buttons { display: flex; gap: 8px; margin-top: 8px; }
    .kakeibo-app .template-buttons button { flex: 1; padding: 10px; border-radius: 6px; background: var(--card-bg, white); color: var(--text-color, #333); border: 1px solid color-mix(in srgb, var(--text-color, #333) 30%, transparent); }
    .kakeibo-app .template-buttons button:hover { background: color-mix(in srgb, var(--primary-color, #4CAF50) 10%, var(--card-bg, white)); }
    .kakeibo-app .help-section { border-top: 1px solid color-mix(in srgb, var(--text-color, #333) 20%, transparent); margin-top: 20px; padding-top: 15px; font-size: 12px; color: var(--sub-text, #666); }
    .kakeibo-app .help-section h4 { margin-bottom: 8px; font-size: 13px; color: var(--text-color, #333); }
    .kakeibo-app .help-section ul { margin-left: 20px; line-height: 1.8; }

    /* ========== ‰∏ãÈÉ®ÈÄöÁü•„ÉªÂ∫ÉÂëä„Éê„Éº ========== */
    .bottom-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 80px;
      background: #fff;
      border-top: 1px solid #ddd;
      z-index: 200;
      display: flex;
      flex-direction: column;
    }
    .bottom-bar-notice {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 16px;
      font-size: 13px;
      color: #666;
      background: #f9f9f9;
    }
    .bottom-bar-notice.warning {
      background: #fff3cd;
      color: #856404;
    }
    .bottom-bar-notice.success {
      background: #d4edda;
      color: #155724;
    }
    .bottom-bar-notice.error {
      background: #f8d7da;
      color: #721c24;
    }
    .bottom-bar-ad {
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #eee;
      font-size: 11px;
      color: #999;
    }
    /* „Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆ‰∏ãÈÉ®‰ΩôÁôΩË™øÊï¥ */
    .container {
      padding-bottom: 90px;
    }
    .kakeibo-app, .memo-app-new {
      padding-bottom: 90px;
    }

    /* ========== „É°„Éã„É•„ÉºÂÜÖË™çË®º„Çª„ÇØ„Ç∑„Éß„É≥ ========== */
    .menu-auth-section {
      padding: 16px;
      background: #f5f5f5;
      border-bottom: 1px solid #ddd;
    }
    .menu-auth-section.logged-in {
      background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
    }
    .menu-auth-section.not-logged-in {
      background: linear-gradient(135deg, #fff3e0, #ffe0b2);
    }
    .menu-auth-status {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .menu-auth-email {
      font-size: 13px;
      font-weight: 500;
      color: #333;
      margin-bottom: 8px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .menu-auth-btn {
      width: 100%;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .menu-auth-btn.google {
      background: #fff;
      color: #333;
      border: 1px solid #ddd;
    }
    .menu-auth-btn.logout {
      background: #e74c3c;
      color: #fff;
    }
    .menu-sync-status {
      font-size: 11px;
      color: #888;
      margin-top: 8px;
      text-align: center;
    }

    /* ========== „É°„É¢„Çπ„Çø„Ç§„É´ÔºàÊñ∞Ôºâ ========== */
    .memo-app-new { background: var(--bg-color, #f5f5f5); padding: 10px; min-height: calc(100vh - 85px); }
    .memo-container-new { max-width: 700px; margin: 0 auto; background: var(--card-bg, white); border: 1px solid color-mix(in srgb, var(--text-color, #333) 15%, transparent); padding: 15px; border-radius: 8px; }
    
    /* „É°„É¢ Ë°å„É¨„Ç§„Ç¢„Ç¶„Éà */
    .memo-row { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; align-items: center; }
    .memo-name-input { 
      flex: 1; min-width: 150px; padding: 10px 12px; font-size: var(--font-size, 14px); 
      border: 1px solid color-mix(in srgb, var(--text-color, #333) 30%, transparent); border-radius: 6px;
      background: var(--card-bg, white); color: var(--text-color, #333);
    }
    .memo-name-input:focus { outline: none; border-color: var(--primary-color, #60a5fa); }
    .memo-select { padding: 10px 12px; font-size: var(--font-size, 14px); border: 1px solid color-mix(in srgb, var(--text-color, #333) 30%, transparent); border-radius: 6px; background: var(--card-bg, white); color: var(--text-color, #333); cursor: pointer; min-width: 100px; }
    .memo-select-wide { flex: 1; min-width: 150px; padding: 10px 12px; font-size: var(--font-size, 14px); border: 1px solid color-mix(in srgb, var(--text-color, #333) 30%, transparent); border-radius: 6px; background: var(--card-bg, white); color: var(--text-color, #333); cursor: pointer; }
    .memo-btn { 
      padding: 10px 16px; font-size: var(--font-size, 14px); border: 1px solid color-mix(in srgb, var(--text-color, #333) 30%, transparent); 
      background: var(--card-bg, white); color: var(--text-color, #333); cursor: pointer; border-radius: 6px; white-space: nowrap;
    }
    .memo-btn:hover { background: color-mix(in srgb, var(--primary-color, #60a5fa) 10%, var(--card-bg, white)); }
    .memo-btn-primary { background: var(--primary-color, #60a5fa); color: white; border-color: var(--primary-color, #60a5fa); }
    .memo-btn-primary:hover { background: color-mix(in srgb, var(--primary-color, #60a5fa) 80%, black); }
    .memo-btn-small { padding: 6px 12px; font-size: 12px; border: 1px solid color-mix(in srgb, var(--text-color, #333) 30%, transparent); background: var(--card-bg, white); color: var(--text-color, #333); cursor: pointer; border-radius: 4px; }
    .memo-btn-clear { margin-left: auto; }
    
    /* „É°„É¢Â±•Ê≠¥„Çπ„É©„Ç§„ÉÄ„Éº */
    .memo-history-slider {
      background: color-mix(in srgb, var(--bg-color, #f5f5f5) 80%, var(--card-bg, white)); border: 1px solid color-mix(in srgb, var(--text-color, #333) 15%, transparent); border-radius: 8px;
      margin-bottom: 15px; overflow: hidden;
    }
    .memo-history-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 15px; background: color-mix(in srgb, var(--primary-color, #60a5fa) 15%, var(--card-bg, white)); border-bottom: 1px solid color-mix(in srgb, var(--text-color, #333) 15%, transparent);
      font-size: 13px; font-weight: bold; color: var(--text-color, #555);
    }
    .memo-history-scroll {
      display: flex; overflow-x: auto; padding: 10px; gap: 10px;
      scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch;
    }
    .memo-history-scroll::-webkit-scrollbar { height: 6px; }
    .memo-history-scroll::-webkit-scrollbar-thumb { background: color-mix(in srgb, var(--text-color, #333) 30%, transparent); border-radius: 3px; }
    .memo-history-item {
      flex: 0 0 200px; scroll-snap-align: start;
      background: var(--card-bg, white); border: 1px solid color-mix(in srgb, var(--text-color, #333) 20%, transparent); border-radius: 6px;
      padding: 10px; cursor: pointer; transition: all 0.2s;
    }
    .memo-history-item:hover { border-color: var(--primary-color, #60a5fa); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .memo-history-date { font-size: 11px; color: var(--sub-text, #888); margin-bottom: 4px; }
    .memo-history-type { font-size: 10px; color: var(--primary-color, #60a5fa); margin-bottom: 4px; }
    .memo-history-preview { font-size: 12px; color: var(--text-color, #333); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .memo-history-name { font-size: 11px; color: var(--sub-text, #666); margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    
    /* „É°„É¢Ëâ≤Â§âÊõ¥„Éú„Çø„É≥ */
    .memo-color-row { margin-bottom: 10px; }
    .memo-color-label { font-size: 13px; color: var(--sub-text, #666); margin-right: 4px; }
    .memo-color-btn {
      padding: 6px 14px; font-size: 13px; border: 2px solid color-mix(in srgb, var(--text-color, #333) 20%, transparent); border-radius: 6px;
      background: var(--card-bg, white); cursor: pointer; font-weight: bold; transition: all 0.2s;
    }
    .memo-color-btn.memo-color-red { color: #dc2626; }
    .memo-color-btn.memo-color-red:hover, .memo-color-btn.memo-color-red.active { background: #dc2626; color: white; border-color: #dc2626; }
    .memo-color-btn.memo-color-blue { color: #2563eb; }
    .memo-color-btn.memo-color-blue:hover, .memo-color-btn.memo-color-blue.active { background: #2563eb; color: white; border-color: #2563eb; }
    .memo-color-btn.memo-color-green { color: #16a34a; }
    .memo-color-btn.memo-color-green:hover, .memo-color-btn.memo-color-green.active { background: #16a34a; color: white; border-color: #16a34a; }
    .memo-color-btn.memo-color-black { color: var(--text-color, #333); }
    .memo-color-btn.memo-color-black:hover, .memo-color-btn.memo-color-black.active { background: var(--text-color, #333); color: var(--card-bg, white); border-color: var(--text-color, #333); }
    
    /* „É°„É¢„Ç®„Éá„Ç£„Çø */
    .memo-editor-wrapper { border: 1px solid color-mix(in srgb, var(--text-color, #333) 30%, transparent); border-radius: 6px; overflow: hidden; }
    .memo-editor {
      width: 100%; min-height: calc(100vh - 380px); padding: 15px;
      border: none; outline: none; font-size: var(--font-size, 15px); line-height: 1.8;
      background: var(--card-bg, #fff); color: var(--text-color, #222);
    }
    .memo-editor[data-empty="true"]:before { content: '„Åì„Åì„Å´„É°„É¢„ÇíÂÖ•Âäõ...'; color: var(--sub-text, #aaa); pointer-events: none; }
    .memo-editor:focus[data-empty="true"]:before { content: ''; }
    
    /* „É°„É¢‰øùÂ≠ò„Çπ„ÉÜ„Éº„Çø„Çπ */
    .memo-save-status { font-size: 12px; color: var(--sub-text, #888); }
    .memo-save-status.saving { color: #d97706; }
    .memo-save-status.saved { color: #22c55e; }
    
    /* „É°„É¢„Éò„É´„Éó„Çª„ÇØ„Ç∑„Éß„É≥ */
    .memo-help-section { border-top: 1px solid color-mix(in srgb, var(--text-color, #333) 20%, transparent); margin-top: 15px; padding-top: 12px; font-size: 12px; color: var(--sub-text, #666); }
    .memo-help-section h4 { margin-bottom: 6px; font-size: 13px; color: var(--text-color, #333); }
    .memo-help-section ul { margin-left: 20px; line-height: 1.8; }
    .memo-help-section a { color: var(--primary-color, #2196F3); }
  </style>
</head>
<body class="current-tab-shift">
  <!-- ========== „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ ========== -->
  <nav class="main-tab-nav">
    <button class="main-tab-btn shift-tab active" onclick="switchMainTab('shift')">üìÖ „Ç∑„Éï„Éà</button>
    <button class="main-tab-btn kakeibo-tab" onclick="switchMainTab('kakeibo')">üí∞ ÂÆ∂Ë®àÁ∞ø</button>
    <button class="main-tab-btn memo-tab" onclick="switchMainTab('memo')">üìù „É°„É¢</button>
    <button class="global-menu-btn" onclick="toggleOptionsMenu()">‚ò∞</button>
  </nav>

  <!-- ========== „Ç∑„Éï„Éà„Ç´„É¨„É≥„ÉÄ„Éº„Çø„Éñ ========== -->
  <div id="shift-tab" class="main-tab-content shift-tab-content active">

  <!-- ========== Ë®≠ÂÆöÂÄ§Ôºà„Åì„Åì„ÇíÂ§âÊõ¥„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ ========== -->
  <script>
    // „Ç¢„Éó„É™„Éê„Éº„Ç∏„Éß„É≥
    const APP_VERSION = '1.0.0';
    
    // Âïè„ÅÑÂêà„Çè„ÅõÂÖàË®≠ÂÆö
    const CONTACT_EMAIL = 'renakaede@gmail.com';
    const CONTACT_FORM_URL = 'https://forms.gle/a22rER5VdhJkbL8N6';
    
    // PROË™çË®ºAPIÔºàGoogle Apps Script„ÅÆ„Éá„Éó„É≠„Ç§URLÔºâ
    const PRO_API_URL = '';  // GAS„Éá„Éó„É≠„Ç§Âæå„Å´Ë®≠ÂÆö
    
    // PROË™çË®º„Ç≥„Éº„ÉâÔºà‰∫àÂÆöÊ¨Ñ„Å´ÂÖ•ÂäõÔºâ
    const PRO_CODE = 'pro32756591473826593614723936';
    
    // „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâËµ∑Âãï„Ç≥„Éº„ÉâÔºà‰∫àÂÆöÊ¨Ñ„Å´ÂÖ•ÂäõÔºâ
    const DEBUG_CODE = 'annko626206238506900';
    
    // „É¶„Éº„Ç∂„ÉºÁî®„Çµ„Éù„Éº„Éà„Ç≥„Éº„ÉâÔºà‰∫àÂÆöÊ¨Ñ„Å´ÂÖ•ÂäõÔºâ
    const SUPPORT_CODE = 'debug241531464135';
  </script>

  <!-- ========== „É°„Ç§„É≥„Éö„Éº„Ç∏ ========== -->
  <div class="page active" id="mainPage">
    <div class="header">
      <button onclick="changeYear(-1)">‚óÄ</button>
      <div class="year-display" id="yearDisplay">2026Âπ¥</div>
      <button onclick="changeYear(1)">‚ñ∂</button>
      <button class="edit-mode-btn" id="editModeBtn" onclick="toggleEditMode()">„Ç∑„Éï„Éà</button>
      <button class="history-btn" onclick="ShiftHistory.toggle()">üìú<span id="shiftHistoryCount"></span></button>
    </div>

    <!-- „Ç∑„Éï„ÉàÂ±•Ê≠¥„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div class="shift-history-overlay" id="shiftHistoryOverlay" style="display:none;">
      <div class="shift-history-panel">
        <div class="shift-history-header">
          <span>Êõ¥Êñ∞Â±•Ê≠¥Ôºà50‰ª∂„Åæ„ÅßÔºâ</span>
          <button class="shift-history-close" onclick="ShiftHistory.toggle()">‚úï</button>
        </div>
        <div class="shift-history-scroll" id="shiftHistoryScroll"></div>
      </div>
    </div>

    <div class="edit-banner" id="editBanner">
      üìÖ „Ç∑„Éï„ÉàÊåøÂÖ•„É¢„Éº„ÉâÔºöÈñãÂßã„Åô„ÇãÊó•„Çí„Çø„ÉÉ„Éó
    </div>

    <div class="container" id="container"></div>
    
    <div class="floating-menu" id="floatingMenu">
      <button class="add" onclick="addMemo()">Ôºã ËøΩÂä†</button>
      <button onclick="copyMemo()">üìã „Ç≥„Éî„Éº</button>
      <button class="delete" onclick="deleteMemo()">ÂâäÈô§</button>
    </div>

    <button class="today-btn" onclick="goToToday()">‰ªäÊó•</button>
    <button class="pattern-float-btn" id="patternFloatBtn" onclick="openSettingsPage()">„Éë„Çø„Éº„É≥Ë®≠ÂÆö</button>

    <input type="file" id="importInput" accept=".json" onchange="handleImport(event)">

    <!-- „Ç∑„Éï„ÉàÊåøÂÖ•Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
    <div class="modal-overlay" id="shiftSelectModal">
      <div class="modal">
        <div class="modal-header">„Ç∑„Éï„ÉàÊåøÂÖ•Ë®≠ÂÆö</div>
        <div class="modal-body">
          <label>‰ΩøÁî®„Åô„Çã„Éë„Çø„Éº„É≥</label>
          <select id="patternSelect" onchange="updateStartPositionOptions()">
            <option value="0">„Éë„Çø„Éº„É≥A</option>
            <option value="1">„Éë„Çø„Éº„É≥B</option>
            <option value="2">„Éë„Çø„Éº„É≥C</option>
            <option value="3">„Éë„Çø„Éº„É≥D</option>
          </select>

          <label>ÈñãÂßã‰ΩçÁΩÆ</label>
          <select id="startPosition"></select>
          <div class="hint">„Éë„Çø„Éº„É≥„ÅÆ‰ΩïÁï™ÁõÆ„Åã„ÇâÂßã„ÇÅ„Çã„Åã</div>

          <label>Áπ∞„ÇäËøî„ÅóÂõûÊï∞</label>
          <input type="number" id="repeatCount" value="1" min="1" max="100">
          <div class="hint">„Éë„Çø„Éº„É≥„Çí‰ΩïÂõûÁπ∞„ÇäËøî„Åô„ÅãÔºà1Âõû = „Éë„Çø„Éº„É≥1Âë®ÂàÜÔºâ</div>
        </div>
        <div class="modal-footer">
          <button class="modal-btn cancel" onclick="closeShiftSelectModal()">„Ç≠„É£„É≥„Çª„É´</button>
          <button class="modal-btn primary" onclick="confirmShiftSettings()">Ê¨°„Å∏</button>
        </div>
      </div>
    </div>

    <!-- „Ç∑„Éï„ÉàÊåøÂÖ•Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´ -->
    <div class="modal-overlay" id="confirmModal">
      <div class="modal">
        <div class="modal-header">„Ç∑„Éï„ÉàÊåøÂÖ•Á¢∫Ë™ç</div>
        <div class="modal-body">
          <div class="confirm-text">„Åì„ÅÆÊó•„Åã„Çâ„Ç∑„Éï„Éà„ÇíÊåøÂÖ•„Åó„Åæ„Åô„ÅãÔºü</div>
          <div class="confirm-date" id="confirmDate">2026Âπ¥1Êúà1Êó•</div>
          <div class="confirm-info">
            <div>üìã „Éë„Çø„Éº„É≥: <strong id="confirmPattern">A</strong></div>
            <div>‚ñ∂Ô∏è ÈñãÂßã‰ΩçÁΩÆ: <strong id="confirmStartPos">1Áï™ÁõÆ</strong></div>
            <div>üîÅ Áπ∞„ÇäËøî„Åó: <strong id="confirmRepeat">1</strong>Âõû</div>
            <div>üìÖ ÊåøÂÖ•Êó•Êï∞: <strong id="confirmDays">5</strong>Êó•ÂàÜ</div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="modal-btn cancel" onclick="closeConfirmModal()">„Ç≠„É£„É≥„Çª„É´</button>
          <button class="modal-btn danger" onclick="executeShiftInsert()">ÊåøÂÖ•„Åô„Çã</button>
        </div>
      </div>
    </div>

    <!-- „Çπ„ÉÜ„Éº„Çø„Çπ„Ç´„É©„ÉºË®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
    <div class="modal-overlay" id="statusColorModal">
      <div class="modal">
        <div class="modal-header">üéØ „Çπ„ÉÜ„Éº„Çø„ÇπËâ≤Ë®≠ÂÆö</div>
        <div class="modal-body">
          <p style="font-size: 13px; color: #666; margin-bottom: 16px;">Êó•‰ªò/ÊõúÊó•„Çí„Çø„ÉÉ„Éó„Åô„Çã„Å®„ÄÅON„ÅÆËâ≤„ÅåÈ†ÜÁï™„Å´Âàá„ÇäÊõø„Çè„Çä„Åæ„Åô</p>
          <div class="status-color-list" id="statusColorList"></div>
        </div>
        <div class="modal-footer">
          <button class="modal-btn cancel" onclick="closeStatusColorModal()">„Ç≠„É£„É≥„Çª„É´</button>
          <button class="modal-btn primary" onclick="saveStatusColorSettings()">‰øùÂ≠ò</button>
        </div>
      </div>
    </div>

    <!-- „Ç§„É≥„Éù„Éº„Éà„É¢„Éº„ÉâÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ -->
    <div class="modal-overlay" id="importModeModal">
      <div class="modal">
        <div class="modal-header">üìÅ „Ç§„É≥„Éù„Éº„ÉàÊñπÊ≥ï„ÇíÈÅ∏Êäû</div>
        <div class="modal-body">
          <div class="import-mode-options">
            <button class="import-mode-btn" onclick="executeImport('diff')">
              <span class="import-mode-icon">üîÑ</span>
              <span class="import-mode-title">Â∑ÆÂàÜÂ§âÊõ¥</span>
              <span class="import-mode-desc">Êó¢Â≠ò„Éá„Éº„Çø„Å®Áï∞„Å™„ÇãÈÉ®ÂàÜ„ÅÆ„Åø‰∏äÊõ∏„ÅçÊõ¥Êñ∞</span>
            </button>
            <button class="import-mode-btn" onclick="executeImport('append')">
              <span class="import-mode-icon">‚ûï</span>
              <span class="import-mode-title">Êñ∞Ë¶èËøΩÂä†</span>
              <span class="import-mode-desc">Êó¢Â≠ò„Éá„Éº„Çø„ÅÆÂæå„Çç„Å´Êñ∞„Åó„ÅÑÊû†„Å®„Åó„Å¶ËøΩÂä†</span>
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button class="modal-btn cancel" onclick="closeImportModeModal()">„Ç≠„É£„É≥„Çª„É´</button>
        </div>
      </div>
    </div>

    <!-- Âïè„ÅÑÂêà„Çè„Åõ„É¢„Éº„ÉÄ„É´ -->
    <!-- „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉÄ„É´ -->
    <div class="modal-overlay" id="debugModal">
      <div class="modal" style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">üîß „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ</div>
        <div class="modal-body" style="font-size: 13px;">
          
          <!-- PROÁâà„Çª„ÇØ„Ç∑„Éß„É≥ -->
          <div style="margin-bottom: 16px; padding: 12px; background: #f9f9f9; border-radius: 8px;">
            <label style="font-weight: bold;">PROÁâà„Çπ„ÉÜ„Éº„Çø„Çπ</label>
            <div id="proStatusDisplay" style="margin-top: 8px; font-size: 14px;"></div>
            <div style="display: flex; gap: 8px; margin-top: 8px;">
              <button class="modal-btn primary" style="flex:1" onclick="toggleProStatus(true)">PRO ON</button>
              <button class="modal-btn cancel" style="flex:1" onclick="toggleProStatus(false)">PRO OFF</button>
            </div>
          </div>
          
          <!-- „Ç∑„Çπ„ÉÜ„É†ÊÉÖÂ†±„Çª„ÇØ„Ç∑„Éß„É≥ -->
          <div style="margin-bottom: 16px; padding: 12px; background: #f0f7ff; border-radius: 8px;">
            <label style="font-weight: bold;">üì± „Ç∑„Çπ„ÉÜ„É†ÊÉÖÂ†±</label>
            <div id="debugSystemInfo" style="margin-top: 8px; font-family: monospace; font-size: 11px; line-height: 1.6;"></div>
          </div>
          
          <!-- FirebaseÊÉÖÂ†±„Çª„ÇØ„Ç∑„Éß„É≥ -->
          <div style="margin-bottom: 16px; padding: 12px; background: #fff8e1; border-radius: 8px;">
            <label style="font-weight: bold;">‚òÅÔ∏è Firebase / „ÇØ„É©„Ç¶„Éâ</label>
            <div id="debugFirebaseInfo" style="margin-top: 8px; font-family: monospace; font-size: 11px; line-height: 1.6;"></div>
            <div style="display: flex; gap: 8px; margin-top: 8px;">
              <button class="modal-btn primary" style="flex:1; font-size: 12px;" onclick="debugForceSync()">Âº∑Âà∂ÂêåÊúü</button>
              <button class="modal-btn cancel" style="flex:1; font-size: 12px;" onclick="debugShowCloudData()">„ÇØ„É©„Ç¶„Éâ„Éá„Éº„ÇøÁ¢∫Ë™ç</button>
            </div>
          </div>
          
          <!-- „Çπ„Éà„É¨„Éº„Ç∏ÊÉÖÂ†±„Çª„ÇØ„Ç∑„Éß„É≥ -->
          <div style="margin-bottom: 16px; padding: 12px; background: #e8f5e9; border-radius: 8px;">
            <label style="font-weight: bold;">üíæ „Çπ„Éà„É¨„Éº„Ç∏</label>
            <div id="debugStorageInfo" style="margin-top: 8px; font-family: monospace; font-size: 11px; line-height: 1.6;"></div>
            <div style="display: flex; gap: 8px; margin-top: 8px;">
              <button class="modal-btn cancel" style="flex:1; font-size: 12px;" onclick="debugExportRawData()">Áîü„Éá„Éº„ÇøÂá∫Âäõ</button>
              <button class="modal-btn cancel" style="flex:1; font-size: 12px;" onclick="debugShowStorageKeys()">„Ç≠„Éº‰∏ÄË¶ß</button>
            </div>
          </div>
          
          <!-- PWAÊÉÖÂ†±„Çª„ÇØ„Ç∑„Éß„É≥ -->
          <div style="margin-bottom: 16px; padding: 12px; background: #fce4ec; border-radius: 8px;">
            <label style="font-weight: bold;">üì¶ PWA / Service Worker</label>
            <div id="debugPWAInfo" style="margin-top: 8px; font-family: monospace; font-size: 11px; line-height: 1.6;"></div>
            <div style="display: flex; gap: 8px; margin-top: 8px;">
              <button class="modal-btn danger" style="flex:1; font-size: 12px;" onclick="clearServiceWorkerCache()">„Ç≠„É£„ÉÉ„Ç∑„É•ÂâäÈô§</button>
              <button class="modal-btn cancel" style="flex:1; font-size: 12px;" onclick="debugReloadSW()">SWÂÜçÁôªÈå≤</button>
            </div>
          </div>
          
          <!-- Âç±Èô∫„Å™Êìç‰Ωú„Çª„ÇØ„Ç∑„Éß„É≥ -->
          <div style="margin-bottom: 16px; padding: 12px; background: #ffebee; border-radius: 8px;">
            <label style="font-weight: bold; color: #c62828;">‚ö†Ô∏è Âç±Èô∫„Å™Êìç‰Ωú</label>
            <div style="display: flex; gap: 8px; margin-top: 8px;">
              <button class="modal-btn danger" style="flex:1; font-size: 12px;" onclick="clearAllData()">ÂÖ®„Éá„Éº„ÇøÂâäÈô§</button>
              <button class="modal-btn danger" style="flex:1; font-size: 12px;" onclick="debugResetPro()">PROÁä∂ÊÖã„É™„Çª„ÉÉ„Éà</button>
            </div>
            <div style="margin-top: 8px; font-size: 11px; color: #888;">‚Äª„Åì„Çå„Çâ„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì</div>
          </div>
          
          <!-- „É≠„Ç∞„Çª„ÇØ„Ç∑„Éß„É≥ -->
          <div>
            <label style="font-weight: bold;">üìã Êìç‰Ωú„É≠„Ç∞ÔºàÊúÄÊñ∞30‰ª∂Ôºâ</label>
            <textarea id="debugLogOutput" readonly style="width:100%; height:120px; font-size:11px; font-family:monospace; margin-top:8px; background:#1e1e1e; color:#d4d4d4; border:none; border-radius:4px; padding:8px;"></textarea>
            <div style="display: flex; gap: 8px; margin-top: 8px;">
              <button class="modal-btn cancel" style="flex:1; font-size: 12px;" onclick="copyDebugLog()">„Ç≥„Éî„Éº</button>
              <button class="modal-btn cancel" style="flex:1; font-size: 12px;" onclick="debugClearLog()">„É≠„Ç∞„ÇØ„É™„Ç¢</button>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="modal-btn cancel" onclick="closeDebugModal()">Èñâ„Åò„Çã</button>
        </div>
      </div>
    </div>

    <!-- „É¶„Éº„Ç∂„ÉºÁî®„Çµ„Éù„Éº„Éà„É¢„Éº„ÉÄ„É´ -->
    <div class="modal-overlay" id="supportModal">
      <div class="modal" style="max-width: 400px;">
        <div class="modal-header">üõ†Ô∏è „Çµ„Éù„Éº„ÉàÊÉÖÂ†±</div>
        <div class="modal-body" style="font-size: 13px;">
          <p style="margin-bottom: 12px; color: #666; line-height: 1.5;">
            ÂïèÈ°å„ÅåÁô∫Áîü„Åó„ÅüÂ†¥Âêà„ÄÅ‰ª•‰∏ã„ÅÆÊÉÖÂ†±„Çí<br>„Çµ„Éù„Éº„Éà„Å´„ÅäÈÄÅ„Çä„Åè„Å†„Åï„ÅÑ„ÄÇ
          </p>
          
          <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
            <label style="font-weight: bold; font-size: 12px; color: #888;">Ë®∫Êñ≠ÊÉÖÂ†±</label>
            <textarea id="supportInfoText" readonly style="width:100%; height:150px; font-size:11px; font-family:monospace; margin-top:8px; background:#fff; border:1px solid #ddd; border-radius:4px; padding:8px; resize:none;"></textarea>
          </div>
          
          <div style="display: flex; gap: 8px;">
            <button class="modal-btn primary" style="flex:1" onclick="copySupportInfo()">üìã „Ç≥„Éî„Éº</button>
            <button class="modal-btn cancel" style="flex:1" onclick="shareSupportInfo()">üì§ ÂÖ±Êúâ</button>
          </div>
          
          <p style="margin-top: 12px; font-size: 11px; color: #999; text-align: center;">
            ‚Äª ÂÄã‰∫∫„Éá„Éº„Çø„ÅØÂê´„Åæ„Çå„Åæ„Åõ„Çì
          </p>
        </div>
        <div class="modal-footer">
          <button class="modal-btn cancel" onclick="closeSupportModal()">Èñâ„Åò„Çã</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== „Éë„Çø„Éº„É≥Ë®≠ÂÆö„Éö„Éº„Ç∏ ========== -->
  <div class="page" id="settingsPage">
    <div class="settings-header">
      <button class="back-btn" onclick="closeSettingsPage()">‚Üê</button>
      <h1>„Ç∑„Éï„Éà„Éë„Çø„Éº„É≥Ë®≠ÂÆö</h1>
    </div>

    <div class="pattern-list" id="patternList"></div>

    <div class="settings-footer">
      <button class="save-all-btn" onclick="saveAllPatterns()">‰øùÂ≠ò„Åó„Å¶„Ç´„É¨„É≥„ÉÄ„Éº„Å´Êàª„Çã</button>
    </div>
  </div>

  <!-- „Éà„Éº„Çπ„ÉàÈÄöÁü• -->
  <div class="toast" id="toast"></div>

  <script>
    const WEEKDAYS = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
    const PATTERN_NAMES = ['„Éë„Çø„Éº„É≥A', '„Éë„Çø„Éº„É≥B', '„Éë„Çø„Éº„É≥C', '„Éë„Çø„Éº„É≥D'];
    const PATTERN_COLORS = ['#3498db', '#27ae60', '#e67e22', '#9b59b6'];

    // ========== Á•ùÊó•ÂèñÂæó ==========
    let holidaysCache = {};

    // holidays-jp API„Åã„ÇâÁ•ùÊó•„ÇíÂèñÂæó
    async function fetchHolidaysFromAPI() {
      try {
        const response = await fetch('https://holidays-jp.github.io/api/v1/date.json');
        if (!response.ok) throw new Error('API error');
        const data = await response.json();
        // „Ç≠„É£„ÉÉ„Ç∑„É•„Å´‰øùÂ≠ò
        localStorage.setItem('holidaysCache', JSON.stringify({
          data: data,
          fetchedAt: Date.now()
        }));
        return data;
      } catch (e) {
        console.log('APIÂèñÂæóÂ§±Êïó„ÄÅ„Ç≠„É£„ÉÉ„Ç∑„É•„Åæ„Åü„ÅØË®àÁÆóÂºè„Çí‰ΩøÁî®');
        return null;
      }
    }

    // „Ç≠„É£„ÉÉ„Ç∑„É•„Åã„ÇâÁ•ùÊó•„ÇíÂèñÂæó
    function getHolidaysFromCache() {
      const cached = localStorage.getItem('holidaysCache');
      if (cached) {
        const { data } = JSON.parse(cached);
        return data;
      }
      return null;
    }

    // Ë®àÁÆóÂºè„Å´„Çà„ÇãÁ•ùÊó•Ôºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
    function calculateHolidays(year) {
      const holidays = {};
      
      holidays[`${year}-01-01`] = 'ÂÖÉÊó•';
      holidays[`${year}-02-11`] = 'Âª∫ÂõΩË®òÂøµ„ÅÆÊó•';
      holidays[`${year}-02-23`] = 'Â§©ÁöáË™ïÁîüÊó•';
      holidays[`${year}-04-29`] = 'Êò≠Âíå„ÅÆÊó•';
      holidays[`${year}-05-03`] = 'ÊÜ≤Ê≥ïË®òÂøµÊó•';
      holidays[`${year}-05-04`] = '„Åø„Å©„Çä„ÅÆÊó•';
      holidays[`${year}-05-05`] = '„Åì„Å©„ÇÇ„ÅÆÊó•';
      holidays[`${year}-08-11`] = 'Â±±„ÅÆÊó•';
      holidays[`${year}-11-03`] = 'ÊñáÂåñ„ÅÆÊó•';
      holidays[`${year}-11-23`] = 'Âã§Âä¥ÊÑüË¨ù„ÅÆÊó•';
      
      const pad = n => String(n).padStart(2, '0');
      holidays[`${year}-01-${pad(getNthWeekday(year, 0, 1, 2))}`] = 'Êàê‰∫∫„ÅÆÊó•';
      holidays[`${year}-07-${pad(getNthWeekday(year, 6, 1, 3))}`] = 'Êµ∑„ÅÆÊó•';
      holidays[`${year}-09-${pad(getNthWeekday(year, 8, 1, 3))}`] = 'Êï¨ËÄÅ„ÅÆÊó•';
      holidays[`${year}-10-${pad(getNthWeekday(year, 9, 1, 2))}`] = '„Çπ„Éù„Éº„ÉÑ„ÅÆÊó•';
      
      const shunbun = Math.floor(20.8431 + 0.242194 * (year - 1980) - Math.floor((year - 1980) / 4));
      holidays[`${year}-03-${pad(shunbun)}`] = 'Êò•ÂàÜ„ÅÆÊó•';
      
      const shubun = Math.floor(23.2488 + 0.242194 * (year - 1980) - Math.floor((year - 1980) / 4));
      holidays[`${year}-09-${pad(shubun)}`] = 'ÁßãÂàÜ„ÅÆÊó•';
      
      return holidays;
    }
    
    function getNthWeekday(year, month, weekday, n) {
      let count = 0;
      for (let day = 1; day <= 31; day++) {
        const date = new Date(year, month, day);
        if (date.getMonth() !== month) break;
        if (date.getDay() === weekday) {
          count++;
          if (count === n) return day;
        }
      }
      return null;
    }

    // Âπ¥„ÅÆÁ•ùÊó•„ÇíÂèñÂæóÔºàAPI„Ç≠„É£„ÉÉ„Ç∑„É•ÂÑ™ÂÖà„ÄÅ„Å™„Åë„Çå„Å∞Ë®àÁÆóÂºèÔºâ
    function getHolidays(year) {
      const apiHolidays = getHolidaysFromCache();
      if (apiHolidays) {
        // API„Éá„Éº„Çø„Åã„ÇâË©≤ÂΩìÂπ¥„ÇíÊäΩÂá∫
        const holidays = {};
        const yearStr = String(year);
        for (const [date, name] of Object.entries(apiHolidays)) {
          if (date.startsWith(yearStr)) {
            holidays[date] = name;
          }
        }
        if (Object.keys(holidays).length > 0) {
          return holidays;
        }
      }
      // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
      return calculateHolidays(year);
    }

    // Á•ùÊó•„ÇíÊâãÂãïÊõ¥Êñ∞
    async function updateHolidays() {
      closeOptionsMenu();
      showToast('Á•ùÊó•„ÇíÊõ¥Êñ∞‰∏≠...');
      const data = await fetchHolidaysFromAPI();
      if (data) {
        holidays = getHolidays(currentYear);
        renderSchedule();
        showToast('Á•ùÊó•„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„ÅüÔºÅ');
      } else {
        showToast('Êõ¥Êñ∞Â§±ÊïóÔºà„Ç™„Éï„É©„Ç§„É≥ÔºüÔºâ');
      }
    }

    let currentYear = new Date().getFullYear();
    let memoData = {};
    let holidays = {};
    let activeMenuTarget = null;
    let editMode = false;
    
    let shiftPatterns = [
      ['A', '-', 'B', '-', '‚óØ'],
      ['Êó•Âã§', 'Â§úÂã§', 'Êòé„Åë', '‰ºë„Åø'],
      ['Êó©Áï™', 'ÈÅÖÁï™', '‰ºë„Åø'],
      ['1', '2', '3', '4', '5', '‰ºë', '‰ºë']
    ];
    
    let selectedPatternIndex = 0;
    let selectedRepeatCount = 1;
    let selectedStartPosition = 0;
    let pendingShiftStart = null;
    const MAX_PATTERN_ITEMS = 90;

    // PROÁâàÈñ¢ÈÄ£
    let isPro = false;

    // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞
    let debugLog = [];

    // „Çπ„ÉÜ„Éº„Çø„Çπ„Ç´„É©„ÉºË®≠ÂÆö
    const STATUS_COLORS = [
      { id: 'none', color: 'transparent', name: 'ÁÑ°Ëâ≤', enabled: true },
      { id: 'red', color: '#ffebee', name: 'Ëµ§ÔºàÊú™ÂÆå‰∫ÜÔºâ', enabled: true },
      { id: 'yellow', color: '#fffde7', name: 'ÈªÑÔºàÈÄ≤Ë°å‰∏≠Ôºâ', enabled: true },
      { id: 'green', color: '#e8f5e9', name: 'Á∑ëÔºàÂÆå‰∫ÜÔºâ', enabled: true },
      { id: 'blue', color: '#e3f2fd', name: 'ÈùíÔºà‰∫àÂÆöÔºâ', enabled: true },
      { id: 'purple', color: '#f3e5f5', name: 'Á¥´Ôºà‰øùÁïôÔºâ', enabled: true },
    ];

    let statusColorSettings = STATUS_COLORS.map(c => ({ id: c.id, enabled: c.enabled }));
    let dayStatusColors = {}; // { '2026-1-15': 'green', ... }

    // „Éá„Ç∂„Ç§„É≥Ë®≠ÂÆö
    const THEMES = [
      { id: 'light', name: '„É©„Ç§„Éà', desc: 'Êòé„Çã„Åè„Ç∑„É≥„Éó„É´', header: '#3498db', primary: '#3498db', bg: '#f5f5f5', cardBg: '#ffffff', text: '#333333', subText: '#666666' },
      { id: 'dark', name: '„ÉÄ„Éº„ÇØ', desc: 'ÁõÆ„Å´ÂÑ™„Åó„ÅÑÊöóËâ≤', header: '#1a1a2e', primary: '#4a69bd', bg: '#16213e', cardBg: '#1a1a2e', text: '#eaeaea', subText: '#a0a0a0' },
      { id: 'chic', name: '„Ç∑„ÉÉ„ÇØ', desc: 'ËêΩ„Å°ÁùÄ„ÅÑ„ÅüÂ§ß‰∫∫Âêë„Åë', header: '#2c3e50', primary: '#34495e', bg: '#ecf0f1', cardBg: '#ffffff', text: '#2c3e50', subText: '#7f8c8d' },
      { id: 'nature', name: '„Éä„ÉÅ„É•„É©„É´', desc: 'Ëá™ÁÑ∂„ÅßÊ∏©„Åã„Åø', header: '#27ae60', primary: '#2ecc71', bg: '#f0f9f4', cardBg: '#ffffff', text: '#2d3436', subText: '#636e72' },
      { id: 'ocean', name: '„Ç™„Éº„Ç∑„É£„É≥', desc: 'ÁàΩ„ÇÑ„Åã„Å™Êµ∑Ëâ≤', header: '#0984e3', primary: '#74b9ff', bg: '#e8f4fd', cardBg: '#ffffff', text: '#2d3436', subText: '#636e72' },
      { id: 'sunset', name: '„Çµ„É≥„Çª„ÉÉ„Éà', desc: 'Êöñ„Åã„ÅÑÂ§ïÊöÆ„Çå', header: '#e17055', primary: '#fab1a0', bg: '#fef5f3', cardBg: '#ffffff', text: '#2d3436', subText: '#636e72' },
      { id: 'lavender', name: '„É©„Éô„É≥„ÉÄ„Éº', desc: 'ÂÑ™„Åó„ÅÑÁ¥´', header: '#6c5ce7', primary: '#a29bfe', bg: '#f5f3ff', cardBg: '#ffffff', text: '#2d3436', subText: '#636e72' },
      { id: 'monochrome', name: '„É¢„Éé„ÇØ„É≠', desc: '„Ç∑„É≥„Éó„É´ÁôΩÈªí', header: '#2d3436', primary: '#636e72', bg: '#f5f5f5', cardBg: '#ffffff', text: '#2d3436', subText: '#636e72' },
      { id: 'sakura', name: '„Çµ„ÇØ„É©', desc: 'Êò•„ÅÆÊ°úËâ≤', header: '#ff6b81', primary: '#ff9ff3', bg: '#fff5f7', cardBg: '#ffffff', text: '#2d3436', subText: '#636e72' },
      { id: 'midnight', name: '„Éü„ÉÉ„Éâ„Éä„Ç§„Éà', desc: 'Ê∑±Â§ú„ÅÆÈùôÂØÇ', header: '#0c0c1e', primary: '#5f27cd', bg: '#1e1e2f', cardBg: '#2a2a3d', text: '#e0e0e0', subText: '#9090a0' },
    ];

    const SIZE_CONFIG = {
      small: { fontSize: '12px', inputPadding: '8px 10px' },
      medium: { fontSize: '14px', inputPadding: '10px 12px' },
      large: { fontSize: '16px', inputPadding: '12px 14px' }
    };

    const HEIGHT_CONFIG = {
      compact: { rowHeight: '38px', memoHeight: '38px' },
      normal: { rowHeight: '44px', memoHeight: '44px' },
      relaxed: { rowHeight: '52px', memoHeight: '52px' }
    };

    let designSettings = {
      theme: 'light',
      size: 'medium',
      height: 'normal'
    };

    // ========== IndexedDB ==========
    const DB_NAME = 'MonogusaScheduleDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'appData';
    let db = null;

    // DBÂàùÊúüÂåñ
    function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => {
          addDebugLog('IndexedDBÂàùÊúüÂåñÂ§±Êïó');
          reject(request.error);
        };
        
        request.onsuccess = () => {
          db = request.result;
          addDebugLog('IndexedDBÂàùÊúüÂåñÊàêÂäü');
          resolve(db);
        };
        
        request.onupgradeneeded = (event) => {
          const database = event.target.result;
          if (!database.objectStoreNames.contains(STORE_NAME)) {
            database.createObjectStore(STORE_NAME, { keyPath: 'id' });
            addDebugLog('IndexedDB„Çπ„Éà„Ç¢‰ΩúÊàê');
          }
        };
      });
    }

    // IndexedDB„Åã„Çâ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
    function loadFromDB(key) {
      return new Promise((resolve, reject) => {
        if (!db) {
          resolve(null);
          return;
        }
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.get(key);
        
        request.onsuccess = () => resolve(request.result?.data || null);
        request.onerror = () => reject(request.error);
      });
    }

    // IndexedDB„Å´„Éá„Éº„Çø‰øùÂ≠ò
    function saveToDB(key, data) {
      return new Promise((resolve, reject) => {
        if (!db) {
          reject(new Error('DB not initialized'));
          return;
        }
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.put({ id: key, data: data });
        
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    // IndexedDB„Åã„Çâ„Éá„Éº„ÇøÂâäÈô§
    function deleteFromDB(key) {
      return new Promise((resolve, reject) => {
        if (!db) {
          resolve();
          return;
        }
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.delete(key);
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    // IndexedDB„Åã„ÇâÊåáÂÆö„Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ„ÅÆ„Ç≠„Éº„ÇíÂÖ®ÂèñÂæó
    function getAllKeysFromDB(prefix) {
      return new Promise((resolve, reject) => {
        if (!db) {
          resolve([]);
          return;
        }
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.getAllKeys();
        request.onsuccess = () => {
          const keys = request.result.filter(k => k.startsWith(prefix));
          resolve(keys);
        };
        request.onerror = () => reject(request.error);
      });
    }

    // LocalStorage„Åã„ÇâÁßªË°å
    async function migrateFromLocalStorage() {
      const oldData = localStorage.getItem('scheduleData_v5');
      if (oldData) {
        try {
          const data = JSON.parse(oldData);
          await saveToDB('scheduleData', data);
          localStorage.removeItem('scheduleData_v5');
          addDebugLog('LocalStorage‚ÜíIndexedDBÁßªË°åÂÆå‰∫Ü');
        } catch (e) {
          addDebugLog('ÁßªË°å„Ç®„É©„Éº: ' + e.message);
        }
      }
    }

    // „Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÔºàÈùûÂêåÊúüÔºâ
    async function loadData() {
      try {
        await initDB();
        await migrateFromLocalStorage();
        
        const data = await loadFromDB('scheduleData');
        if (data) {
          memoData = data.memos || {};
          currentYear = data.lastYear || new Date().getFullYear();
          shiftPatterns = data.shiftPatterns || shiftPatterns;
          designSettings = data.designSettings || designSettings;
          isPro = data.isPro || false;
          statusColorSettings = data.statusColorSettings || statusColorSettings;
          dayStatusColors = data.dayStatusColors || {};
        }
        
        // PROÁä∂ÊÖã„ÅØLocalStorage„Å´„ÇÇ‰øùÊåÅÔºà‰ªñ„Ç¢„Éó„É™„Å®ÂÖ±ÊúâÁî®Ôºâ
        const proCode = localStorage.getItem('ntrr_pro_code');
        if (proCode) isPro = true;
        
      } catch (e) {
        addDebugLog('„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº: ' + e.message);
      }
      
      applyDesign();
      updateProUI();
      addDebugLog('„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü');
    }

    // ========== „Ç∑„Éï„ÉàÂ±•Ê≠¥ÁÆ°ÁêÜ ==========
    const ShiftHistory = {
      history: [],
      saveTimeout: null,
      visible: false,
      
      async load() {
        this.history = await loadFromDB('shift_history') || [];
        this.updateCount();
      },
      async save() {
        while (this.history.length > 50) this.history.pop();
        await saveToDB('shift_history', this.history);
        this.updateCount();
        if (this.visible) this.render();
      },
      updateCount() {
        const el = document.getElementById('shiftHistoryCount');
        el.textContent = this.history.length > 0 ? this.history.length : '';
      },
      async addHistory(type) {
        const data = {
          memos: JSON.parse(JSON.stringify(memoData)),
          shiftPatterns: JSON.parse(JSON.stringify(shiftPatterns)),
          dayStatusColors: JSON.parse(JSON.stringify(dayStatusColors))
        };
        // ÂâçÂõû„Å®„ÅÆÂ∑ÆÂàÜ„ÇíÊ§úÂá∫
        const prevMemos = this.history.length > 0 ? this.history[0].data.memos : {};
        const changedKeys = [];
        // Â§âÊõ¥„ÉªËøΩÂä†„Åï„Çå„ÅüÊó•
        for (const key in data.memos) {
          const curr = (data.memos[key] || []).join('|');
          const prev = (prevMemos[key] || []).join('|');
          if (curr !== prev && data.memos[key].some(m => m && m.trim())) {
            changedKeys.push(key);
          }
        }
        // ÂâäÈô§„Åï„Çå„ÅüÊó•
        for (const key in prevMemos) {
          if (!data.memos[key] && prevMemos[key].some(m => m && m.trim())) {
            changedKeys.push(key);
          }
        }
        // Â§âÊõ¥„Åå„Å™„Åë„Çå„Å∞„Çπ„Ç≠„ÉÉ„Éó
        if (changedKeys.length === 0) return;
        this.history.unshift({
          date: new Date().toISOString(),
          type: type,
          changedKeys: changedKeys,
          data: data
        });
        await this.save();
      },
      scheduleBackup() {
        clearTimeout(this.saveTimeout);
        this.saveTimeout = setTimeout(() => this.addHistory('input'), 1000);
      },
      toggle() {
        this.visible = !this.visible;
        const overlay = document.getElementById('shiftHistoryOverlay');
        overlay.style.display = this.visible ? 'flex' : 'none';
        if (this.visible) this.render();
      },
      render() {
        const scroll = document.getElementById('shiftHistoryScroll');
        if (this.history.length === 0) {
          scroll.innerHTML = '<div style="padding:20px;color:#888;text-align:center;">Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
          return;
        }
        scroll.innerHTML = this.history.map((item, idx) => {
          const d = new Date(item.date);
          const dateStr = d.toLocaleString('ja-JP', { month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit' });
          const typeLabel = {input:'‚úèÔ∏èÂÖ•Âäõ', paste:'üìã„Éö„Éº„Çπ„Éà', shift:'üìÖ„Ç∑„Éï„ÉàÊåøÂÖ•'}[item.type] || item.type;
          // Â§âÊõ¥„Åï„Çå„ÅüÊó•„ÇíË°®Á§∫
          let changedStr = '';
          if (item.changedKeys && item.changedKeys.length > 0) {
            const sorted = item.changedKeys.sort();
            if (sorted.length <= 3) {
              changedStr = sorted.map(k => {
                const [y,m,d] = k.split('-');
                return `${m}/${d}`;
              }).join(', ');
            } else {
              changedStr = sorted.slice(0,2).map(k => {
                const [y,m,d] = k.split('-');
                return `${m}/${d}`;
              }).join(', ') + ` ‰ªñ${sorted.length - 2}Êó•`;
            }
          }
          return `<div class="shift-history-item" onclick="ShiftHistory.restore(${idx})">
            <div class="shift-history-date">${dateStr}</div>
            <div class="shift-history-type">${typeLabel}</div>
            <div class="shift-history-preview">${changedStr || '(Ë©≥Á¥∞„Å™„Åó)'}</div>
          </div>`;
        }).join('');
      },
      async restore(idx) {
        if (!this.history[idx]) return;
        if (!confirm('„Åì„ÅÆÂ±•Ê≠¥„Å´Êàª„Åó„Åæ„Åô„ÅãÔºüÁèæÂú®„ÅÆ„Éá„Éº„Çø„ÅØÂ±•Ê≠¥„Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åô„ÄÇ')) return;
        // ÁèæÂú®„ÅÆ„Éá„Éº„Çø„Çí„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó
        await this.addHistory('input');
        // Âæ©ÂÖÉ
        const data = this.history[idx].data;
        memoData = data.memos || {};
        shiftPatterns = data.shiftPatterns || shiftPatterns;
        dayStatusColors = data.dayStatusColors || {};
        await saveData(true); // Â±•Ê≠¥‰øùÂ≠ò„Çí„Çπ„Ç≠„ÉÉ„Éó
        renderSchedule();
        this.toggle();
        showToast('Âæ©ÂÖÉ„Åó„Åæ„Åó„Åü');
      }
    };

    // „Éá„Éº„Çø‰øùÂ≠òÔºàÈùûÂêåÊúüÔºâ
    async function saveData(skipHistory = false) {
      try {
        await saveToDB('scheduleData', {
          memos: memoData,
          lastYear: currentYear,
          lastScroll: window.scrollY,
          shiftPatterns: shiftPatterns,
          designSettings: designSettings,
          isPro: isPro,
          statusColorSettings: statusColorSettings,
          dayStatusColors: dayStatusColors
        });
        addDebugLog('„Éá„Éº„Çø‰øùÂ≠ò');
        // Â±•Ê≠¥„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí„Çπ„Ç±„Ç∏„É•„Éº„É´
        if (!skipHistory) {
          ShiftHistory.scheduleBackup();
        }
        // FirebaseÂêåÊúü„Çí„Çπ„Ç±„Ç∏„É•„Éº„É´
        FirebaseSync.scheduleBackup();
      } catch (e) {
        addDebugLog('„Éá„Éº„Çø‰øùÂ≠ò„Ç®„É©„Éº: ' + e.message);
        showToast('‰øùÂ≠ò„Ç®„É©„Éº');
      }
    }

    async function saveScroll() {
      try {
        const data = await loadFromDB('scheduleData') || {};
        data.lastScroll = window.scrollY;
        data.lastYear = currentYear;
        await saveToDB('scheduleData', data);
      } catch (e) {
        // „Çπ„ÇØ„É≠„Éº„É´‰øùÂ≠òÂ§±Êïó„ÅØÁÑ°Ë¶ñ
      }
    }

    async function restoreScroll() {
      try {
        const data = await loadFromDB('scheduleData');
        if (data && data.lastScroll && data.lastYear === currentYear) {
          setTimeout(() => window.scrollTo(0, data.lastScroll), 50);
        }
      } catch (e) {
        // „Çπ„ÇØ„É≠„Éº„É´Âæ©ÂÖÉÂ§±Êïó„ÅØÁÑ°Ë¶ñ
      }
    }

    // ========== „Éá„Ç∂„Ç§„É≥ ==========
    function applyDesign() {
      const theme = THEMES.find(t => t.id === designSettings.theme) || THEMES[0];
      const size = SIZE_CONFIG[designSettings.size] || SIZE_CONFIG.medium;
      const height = HEIGHT_CONFIG[designSettings.height] || HEIGHT_CONFIG.normal;

      document.documentElement.style.setProperty('--primary-color', theme.primary);
      document.documentElement.style.setProperty('--header-color', theme.header);
      document.documentElement.style.setProperty('--bg-color', theme.bg);
      document.documentElement.style.setProperty('--card-bg', theme.cardBg);
      document.documentElement.style.setProperty('--text-color', theme.text);
      document.documentElement.style.setProperty('--sub-text', theme.subText);
      document.documentElement.style.setProperty('--font-size', size.fontSize);
      document.documentElement.style.setProperty('--input-padding', size.inputPadding);
      document.documentElement.style.setProperty('--row-height', height.rowHeight);
      document.documentElement.style.setProperty('--memo-height', height.memoHeight);
    }

    function renderThemeOptions() {
      const container = document.getElementById('themeOptions');
      container.innerHTML = '';
      
      THEMES.forEach(theme => {
        const div = document.createElement('div');
        div.className = 'theme-option' + (designSettings.theme === theme.id ? ' selected' : '');
        div.dataset.theme = theme.id;
        div.onclick = () => selectTheme(div);
        div.innerHTML = `
          <div class="theme-preview">
            <div class="theme-preview-header" style="background: ${theme.header}"></div>
            <div class="theme-preview-body" style="background: ${theme.cardBg}">
              <div class="theme-preview-row" style="background: ${theme.bg}"></div>
              <div class="theme-preview-row" style="background: ${theme.cardBg}"></div>
              <div class="theme-preview-row" style="background: ${theme.bg}"></div>
            </div>
          </div>
          <div>
            <div class="theme-name">${theme.name}</div>
            <div class="theme-desc">${theme.desc}</div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function openDesignModal() {
      closeOptionsMenu();
      renderThemeOptions();
      
      // ÁèæÂú®„ÅÆÈÅ∏Êäû„ÇíÂèçÊò†
      document.querySelectorAll('.size-option[data-size]').forEach(el => {
        el.classList.toggle('selected', el.dataset.size === designSettings.size);
      });
      document.querySelectorAll('.size-option[data-height]').forEach(el => {
        el.classList.toggle('selected', el.dataset.height === designSettings.height);
      });
      
      document.getElementById('designModal').classList.add('show');
    }

    function closeDesignModal() {
      document.getElementById('designModal').classList.remove('show');
    }

    function selectTheme(el) {
      document.querySelectorAll('.theme-option').forEach(e => e.classList.remove('selected'));
      el.classList.add('selected');
    }

    function selectSize(el) {
      document.querySelectorAll('.size-option[data-size]').forEach(e => e.classList.remove('selected'));
      el.classList.add('selected');
    }

    function selectHeight(el) {
      document.querySelectorAll('.size-option[data-height]').forEach(e => e.classList.remove('selected'));
      el.classList.add('selected');
    }

    function saveDesign() {
      const selectedTheme = document.querySelector('.theme-option.selected');
      const selectedSize = document.querySelector('.size-option[data-size].selected');
      const selectedHeight = document.querySelector('.size-option[data-height].selected');
      
      if (selectedTheme) designSettings.theme = selectedTheme.dataset.theme;
      if (selectedSize) designSettings.size = selectedSize.dataset.size;
      if (selectedHeight) designSettings.height = selectedHeight.dataset.height;
      
      applyDesign();
      saveData();
      closeDesignModal();
      renderSchedule();
      showToast('„Éá„Ç∂„Ç§„É≥„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
    }

    // ========== „Ç§„É≥„Éù„Éº„Éà/„Ç®„ÇØ„Çπ„Éù„Éº„Éà ==========
    let pendingImportData = null;

    function triggerImport() {
      closeOptionsMenu();
      document.getElementById('importInput').click();
    }

    function handleImport(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          pendingImportData = JSON.parse(e.target.result);
          openImportModeModal();
        } catch (err) {
          showToast('„Ç§„É≥„Éù„Éº„ÉàÂ§±Êïó: „Éï„Ç°„Ç§„É´ÂΩ¢Âºè„Ç®„É©„Éº');
          addDebugLog('„Ç§„É≥„Éù„Éº„Éà„Ç®„É©„Éº: ' + err.message);
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    function openImportModeModal() {
      document.getElementById('importModeModal').classList.add('show');
    }

    function closeImportModeModal() {
      document.getElementById('importModeModal').classList.remove('show');
      pendingImportData = null;
    }

    function executeImport(mode) {
      if (!pendingImportData || !pendingImportData.memos) {
        showToast('„Ç§„É≥„Éù„Éº„Éà„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
        closeImportModeModal();
        return;
      }

      const importedMemos = pendingImportData.memos;
      let changeCount = 0;

      if (mode === 'diff') {
        // Â∑ÆÂàÜÂ§âÊõ¥„É¢„Éº„ÉâÔºöÂêå„Åò‰ΩçÁΩÆ„ÅßÂÄ§„ÅåÈÅï„ÅÜÂ†¥Âêà„ÅÆ„Åø‰∏äÊõ∏„Åç
        for (const [key, values] of Object.entries(importedMemos)) {
          if (!memoData[key]) {
            memoData[key] = [''];
          }
          for (let i = 0; i < values.length; i++) {
            const newVal = values[i];
            const oldVal = memoData[key][i];
            // ÂÄ§„Åå„ÅÇ„Çä„ÄÅ„Åã„Å§Êó¢Â≠ò„Å®Áï∞„Å™„ÇãÂ†¥Âêà„ÅÆ„ÅøÊõ¥Êñ∞
            if (newVal && newVal.trim() !== '' && newVal !== oldVal) {
              // Êû†„ÅåË∂≥„Çä„Å™„Åë„Çå„Å∞Êã°Âºµ
              while (memoData[key].length <= i) {
                memoData[key].push('');
              }
              memoData[key][i] = newVal;
              changeCount++;
            }
          }
        }
        addDebugLog(`Â∑ÆÂàÜ„Ç§„É≥„Éù„Éº„Éà: ${changeCount}‰ª∂Êõ¥Êñ∞`);
        showToast(`Â∑ÆÂàÜ„Ç§„É≥„Éù„Éº„ÉàÂÆå‰∫ÜÔºà${changeCount}‰ª∂Êõ¥Êñ∞Ôºâ`);
      } else if (mode === 'append') {
        // Êñ∞Ë¶èËøΩÂä†„É¢„Éº„ÉâÔºöÊó¢Â≠ò„ÅÆÊû†„ÅÆÂæå„Çç„Å´Êñ∞„Åó„ÅÑÊû†„Å®„Åó„Å¶ËøΩÂä†
        for (const [key, values] of Object.entries(importedMemos)) {
          if (!memoData[key]) {
            memoData[key] = [''];
          }
          for (const value of values) {
            if (value && value.trim() !== '') {
              // Êó¢Â≠ò„Éá„Éº„Çø„Å´Âêå„ÅòÂÄ§„Åå„Å™„Åë„Çå„Å∞ËøΩÂä†
              if (!memoData[key].includes(value)) {
                // ÊúÄÂàù„ÅÆÊû†„ÅåÁ©∫„Å™„Çâ‰∏äÊõ∏„Åç„ÄÅ„Åù„ÅÜ„Åß„Å™„Åë„Çå„Å∞ËøΩÂä†
                if (memoData[key].length === 1 && memoData[key][0] === '') {
                  memoData[key][0] = value;
                } else {
                  memoData[key].push(value);
                }
                changeCount++;
              }
            }
          }
        }
        addDebugLog(`Êñ∞Ë¶èËøΩÂä†„Ç§„É≥„Éù„Éº„Éà: ${changeCount}‰ª∂ËøΩÂä†`);
        showToast(`Êñ∞Ë¶èËøΩÂä†ÂÆå‰∫ÜÔºà${changeCount}‰ª∂ËøΩÂä†Ôºâ`);
      }

      // „Ç∑„Éï„Éà„Éë„Çø„Éº„É≥„Åå„ÅÇ„Çå„Å∞‰∏äÊõ∏„Åç
      if (pendingImportData.shiftPatterns) {
        shiftPatterns = pendingImportData.shiftPatterns;
        addDebugLog('„Ç∑„Éï„Éà„Éë„Çø„Éº„É≥„Çí„Ç§„É≥„Éù„Éº„Éà');
      }

      saveData();
      closeImportModeModal();
      renderSchedule();
    }

    function exportData() {
      closeOptionsMenu();
      const exportObj = {
        memos: memoData,
        shiftPatterns: shiftPatterns,
        exportedAt: new Date().toISOString()
      };

      const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `schedule_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„Åü');
    }

    // ========== Âïè„ÅÑÂêà„Çè„Åõ ==========
    function openContactModal() {
      closeOptionsMenu();
      document.getElementById('contactEmail').href = `mailto:${CONTACT_EMAIL}`;
      
      // „Éï„Ç©„Éº„É†URL„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çå„Å∞Ë°®Á§∫
      const formLink = document.getElementById('contactForm');
      if (CONTACT_FORM_URL) {
        formLink.href = CONTACT_FORM_URL;
        formLink.style.display = '';
      } else {
        formLink.style.display = 'none';
      }
      
      document.getElementById('contactModal').classList.add('show');
    }

    function closeContactModal() {
      document.getElementById('contactModal').classList.remove('show');
    }

    // ========== „Çπ„ÉÜ„Éº„Çø„Çπ„Ç´„É©„Éº ==========
    function getEnabledStatusColors() {
      return STATUS_COLORS.filter(c => {
        const setting = statusColorSettings.find(s => s.id === c.id);
        return setting ? setting.enabled : c.enabled;
      });
    }

    function cycleStatusColor(key) {
      const enabledColors = getEnabledStatusColors();
      const currentColorId = dayStatusColors[key] || 'none';
      const currentIndex = enabledColors.findIndex(c => c.id === currentColorId);
      const nextIndex = (currentIndex + 1) % enabledColors.length;
      const nextColorId = enabledColors[nextIndex].id;
      
      if (nextColorId === 'none') {
        delete dayStatusColors[key];
      } else {
        dayStatusColors[key] = nextColorId;
      }
      
      saveData();
      renderSchedule();
    }

    function getStatusColorForDay(key) {
      const colorId = dayStatusColors[key] || 'none';
      const colorObj = STATUS_COLORS.find(c => c.id === colorId);
      return colorObj ? colorObj.color : 'transparent';
    }

    function openStatusColorModal() {
      closeOptionsMenu();
      renderStatusColorSettings();
      document.getElementById('statusColorModal').classList.add('show');
    }

    function closeStatusColorModal() {
      document.getElementById('statusColorModal').classList.remove('show');
    }

    function renderStatusColorSettings() {
      const list = document.getElementById('statusColorList');
      list.innerHTML = '';

      STATUS_COLORS.forEach((color, index) => {
        const setting = statusColorSettings.find(s => s.id === color.id);
        const enabled = setting ? setting.enabled : color.enabled;
        
        const item = document.createElement('div');
        item.className = 'status-color-item' + (index === 0 || enabled ? '' : ' disabled');
        item.innerHTML = `
          <div class="status-color-preview" style="background: ${color.color === 'transparent' ? '#fff' : color.color}"></div>
          <span class="status-color-name">${color.name}</span>
          <div class="status-color-toggle ${enabled ? 'on' : ''}" data-id="${color.id}" onclick="toggleStatusColor(this)"></div>
        `;
        list.appendChild(item);
      });
    }

    function toggleStatusColor(el) {
      const id = el.dataset.id;
      if (id === 'none') return; // ÁÑ°Ëâ≤„ÅØÂ∏∏„Å´ON
      
      el.classList.toggle('on');
      const item = el.closest('.status-color-item');
      item.classList.toggle('disabled', !el.classList.contains('on'));
    }

    function saveStatusColorSettings() {
      const toggles = document.querySelectorAll('.status-color-toggle');
      statusColorSettings = Array.from(toggles).map(toggle => ({
        id: toggle.dataset.id,
        enabled: toggle.classList.contains('on')
      }));
      
      // ÁÑ°Ëâ≤„ÅØÂ∏∏„Å´ON
      const noneIdx = statusColorSettings.findIndex(s => s.id === 'none');
      if (noneIdx >= 0) statusColorSettings[noneIdx].enabled = true;
      
      saveData();
      closeStatusColorModal();
      showToast('„Çπ„ÉÜ„Éº„Çø„ÇπËâ≤Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
    }

    // ========== PROÁâà ==========
    function updateProUI() {
      const menuItem = document.getElementById('proMenuItem');
      if (isPro) {
        menuItem.innerHTML = '<span class="icon">üéâ</span>ÊîØÊè¥Ê∏à„Åø';
      } else {
        menuItem.innerHTML = '<span class="icon">‚ú®</span>ÊîØÊè¥';
      }
    }

    function openProModal() {
      closeOptionsMenu();
      if (isPro) {
        document.getElementById('proThanksModal').classList.add('show');
      } else {
        document.getElementById('proModal').classList.add('show');
      }
    }

    function closeProModal() {
      document.getElementById('proModal').classList.remove('show');
    }

    function closeProThanksModal() {
      document.getElementById('proThanksModal').classList.remove('show');
    }

    // ‰∫àÂÆöÊ¨ÑÂÖ•ÂäõÊôÇ„ÅÆPRO„Ç≥„Éº„Éâ„ÉÅ„Çß„ÉÉ„ÇØ
    async function checkProCode(key, value) {
      if (value === PRO_CODE) {
        // ÂÖ•Âäõ„Çí„ÇØ„É™„Ç¢
        setTimeout(() => {
          if (memoData[key]) {
            const idx = memoData[key].indexOf(PRO_CODE);
            if (idx >= 0) {
              memoData[key][idx] = '';
              saveData();
              renderSchedule();
            }
          }
        }, 100);

        // PROÊúâÂäπÂåñ
        isPro = true;
        localStorage.setItem('ntrr_pro_code', value);
        saveData();
        updateProUI();
        showToast('üéâ „ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ');
        addDebugLog('PROÁâàË™çË®ºÊàêÂäü');
        
        // FirebaseÈÄ£Êê∫‰∏≠„Å™„Çâ„ÇØ„É©„Ç¶„Éâ„Å´„ÇÇPROÁä∂ÊÖã„Çí‰øùÂ≠ò
        if (FirebaseSync.user) {
          try {
            await FirebaseSync.setProStatus(true);
            addDebugLog('PROÁä∂ÊÖã„Çí„ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò');
          } catch (e) {
            addDebugLog('PROÁä∂ÊÖã„ÅÆ„ÇØ„É©„Ç¶„Éâ‰øùÂ≠òÂ§±Êïó: ' + e.message);
          }
        }
        return true;
      }
      return false;
    }

    // Ëµ∑ÂãïÊôÇ„Å´PROÁä∂ÊÖã„ÇíÂÜçÁ¢∫Ë™ç
    async function recheckProStatus() {
      // FirebaseÈÄ£Êê∫‰∏≠„ÅØ„ÇØ„É©„Ç¶„Éâ„ÅÆPROÁä∂ÊÖã„ÇíÂÑ™ÂÖà
      if (FirebaseSync.user) {
        addDebugLog('PROÁä∂ÊÖã„ÅØFirebase„Åã„ÇâÂèñÂæóÊ∏à„Åø');
        return;
      }
      
      // „Ç™„Éï„É©„Ç§„É≥ÊôÇ„ÅØ„É≠„Éº„Ç´„É´„ÅÆ„Ç≥„Éº„Éâ„ÇíÁ¢∫Ë™ç
      const savedCode = localStorage.getItem('ntrr_pro_code');
      if (savedCode === PRO_CODE) {
        isPro = true;
        updateProUI();
        addDebugLog('PROÁä∂ÊÖã„Çí„É≠„Éº„Ç´„É´„Åã„ÇâÂæ©ÂÖÉ');
      }
    }

    // ========== „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ ==========
    const ERROR_KEYWORDS = ['Â§±Êïó', '„Ç®„É©„Éº', 'Error', 'error', 'failed', 'Failed'];
    
    function addDebugLog(message) {
      const timestamp = new Date().toLocaleTimeString();
      const fullMessage = `[${timestamp}] ${message}`;
      debugLog.push(fullMessage);
      // ÊúÄÊñ∞100‰ª∂„ÅÆ„Åø‰øùÊåÅÔºà„É°„É¢„É™Ôºâ
      if (debugLog.length > 100) {
        debugLog = debugLog.slice(-100);
      }
      
      // „Ç®„É©„Éº„Å£„ÅΩ„ÅÑ„É≠„Ç∞„ÅØIndexedDB„Å´„ÇÇÊ∞∏Á∂ö‰øùÂ≠ò
      if (ERROR_KEYWORDS.some(kw => message.includes(kw))) {
        saveErrorLog(fullMessage);
      }
    }
    
    // „Ç®„É©„Éº„É≠„Ç∞„ÇíIndexedDB„Å´‰øùÂ≠ò
    async function saveErrorLog(message) {
      try {
        let errorLogs = await loadFromDB('error_logs') || [];
        errorLogs.push({
          time: new Date().toISOString(),
          message: message
        });
        // ÊúÄÊñ∞10‰ª∂„ÅÆ„Åø‰øùÊåÅ
        if (errorLogs.length > 10) {
          errorLogs = errorLogs.slice(-10);
        }
        await saveToDB('error_logs', errorLogs);
      } catch (e) {
        console.error('„Ç®„É©„Éº„É≠„Ç∞‰øùÂ≠òÂ§±Êïó:', e);
      }
    }
    
    // „Ç∞„É≠„Éº„Éê„É´„Ç®„É©„Éº„Éè„É≥„Éâ„É©
    window.onerror = (msg, url, line, col, error) => {
      const errorMsg = `JS Error: ${msg} (${line}:${col})`;
      addDebugLog(errorMsg);
      return false; // „Éá„Éï„Ç©„É´„Éà„ÅÆ„Ç®„É©„ÉºÂá¶ÁêÜ„ÇÇÂÆüË°å
    };
    
    // Promise „ÅÆunhandled rejection
    window.onunhandledrejection = (event) => {
      const errorMsg = `Promise Error: ${event.reason}`;
      addDebugLog(errorMsg);
    };

    function checkDebugCode(key, value) {
      // ÈñãÁô∫ËÄÖÁî®„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ
      if (value === DEBUG_CODE) {
        openDebugModal();
        // ÂÖ•Âäõ„Çí„ÇØ„É™„Ç¢
        setTimeout(() => {
          if (memoData[key] && memoData[key].includes(DEBUG_CODE)) {
            const idx = memoData[key].indexOf(DEBUG_CODE);
            memoData[key][idx] = '';
            saveData();
            renderSchedule();
          }
        }, 100);
        return true;
      }
      // „É¶„Éº„Ç∂„ÉºÁî®„Çµ„Éù„Éº„Éà„É¢„Éº„Éâ
      if (value === SUPPORT_CODE) {
        openSupportModal();
        // ÂÖ•Âäõ„Çí„ÇØ„É™„Ç¢
        setTimeout(() => {
          if (memoData[key] && memoData[key].includes(SUPPORT_CODE)) {
            const idx = memoData[key].indexOf(SUPPORT_CODE);
            memoData[key][idx] = '';
            saveData();
            renderSchedule();
          }
        }, 100);
        return true;
      }
      return false;
    }

    function openDebugModal() {
      addDebugLog('„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâËµ∑Âãï');
      updateDebugDisplay();
      document.getElementById('debugModal').classList.add('show');
    }

    function closeDebugModal() {
      document.getElementById('debugModal').classList.remove('show');
    }

    // ========== „É¶„Éº„Ç∂„ÉºÁî®„Çµ„Éù„Éº„ÉàÊ©üËÉΩ ==========
    function openSupportModal() {
      generateSupportInfo();
      document.getElementById('supportModal').classList.add('show');
    }

    function closeSupportModal() {
      document.getElementById('supportModal').classList.remove('show');
    }

    async function generateSupportInfo() {
      const info = [];
      const now = new Date();
      
      // Âü∫Êú¨ÊÉÖÂ†±
      info.push('=== „Çµ„Éù„Éº„ÉàË®∫Êñ≠ÊÉÖÂ†± ===');
      info.push(`ÁîüÊàêÊó•ÊôÇ: ${now.toLocaleString()}`);
      info.push(`„Ç¢„Éó„É™Ver: ${APP_VERSION}`);
      info.push('');
      
      // Áí∞Â¢ÉÊÉÖÂ†±
      info.push('[Áí∞Â¢É]');
      info.push(`ÁîªÈù¢: ${window.innerWidth}x${window.innerHeight}`);
      info.push(`„Ç™„É≥„É©„Ç§„É≥: ${navigator.onLine ? 'Yes' : 'No'}`);
      info.push(`„Çø„ÉÉ„ÉÅ: ${('ontouchstart' in window) ? 'Yes' : 'No'}`);
      info.push(`Ë®ÄË™û: ${navigator.language}`);
      info.push('');
      
      // „Éñ„É©„Ç¶„Ç∂ÊÉÖÂ†±ÔºàÁü≠Á∏ÆÔºâ
      info.push('[„Éñ„É©„Ç¶„Ç∂]');
      const ua = navigator.userAgent;
      if (ua.includes('Chrome')) info.push('Chrome');
      else if (ua.includes('Safari')) info.push('Safari');
      else if (ua.includes('Firefox')) info.push('Firefox');
      else info.push('Other');
      info.push(`„É¢„Éê„Ç§„É´: ${/Mobile|Android|iPhone/.test(ua) ? 'Yes' : 'No'}`);
      info.push('');
      
      // „Éá„Éº„ÇøÁä∂ÊÖã
      info.push('[„Éá„Éº„ÇøÁä∂ÊÖã]');
      info.push(`„Ç∑„Éï„Éà„É°„É¢: ${Object.keys(memoData).length}‰ª∂`);
      info.push(`„Éë„Çø„Éº„É≥: ${shiftPatterns.length}‰ª∂`);
      
      try {
        const kakeiboList = await Kakeibo.getDataList();
        info.push(`ÂÆ∂Ë®àÁ∞ø: ${kakeiboList.length}‰ª∂`);
      } catch (e) {
        info.push(`ÂÆ∂Ë®àÁ∞ø: ÂèñÂæó„Ç®„É©„Éº`);
      }
      
      try {
        const memoList = await Memo.getDataList();
        info.push(`„É°„É¢: ${memoList.length}‰ª∂`);
      } catch (e) {
        info.push(`„É°„É¢: ÂèñÂæó„Ç®„É©„Éº`);
      }
      info.push('');
      
      // ÂêåÊúüÁä∂ÊÖã
      info.push('[ÂêåÊúüÁä∂ÊÖã]');
      info.push(`„É≠„Ç∞„Ç§„É≥: ${FirebaseSync.user ? 'Yes' : 'No'}`);
      info.push(`ÊúÄÁµÇÂêåÊúü: ${FirebaseSync.lastSyncTime ? FirebaseSync.lastSyncTime.toLocaleString() : 'Êú™ÂêåÊúü'}`);
      info.push(`PRO: ${isPro ? 'Yes' : 'No'}`);
      info.push('');
      
      // „Çπ„Éà„É¨„Éº„Ç∏Áä∂ÊÖã
      info.push('[„Çπ„Éà„É¨„Éº„Ç∏]');
      info.push(`IndexedDB: ${db ? 'OK' : 'NG'}`);
      if (navigator.storage && navigator.storage.estimate) {
        try {
          const estimate = await navigator.storage.estimate();
          const usedMB = (estimate.usage / 1024 / 1024).toFixed(2);
          const quotaMB = (estimate.quota / 1024 / 1024).toFixed(0);
          info.push(`‰ΩøÁî®Èáè: ${usedMB}MB / ${quotaMB}MB`);
        } catch (e) {
          info.push(`‰ΩøÁî®Èáè: ÂèñÂæó„Ç®„É©„Éº`);
        }
      }
      info.push('');
      
      // ÊúÄËøë„ÅÆ„Ç®„É©„ÉºÔºàIndexedDB„Åã„ÇâÂèñÂæóÔºâ
      try {
        const errorLogs = await loadFromDB('error_logs') || [];
        if (errorLogs.length > 0) {
          info.push('[ÊúÄËøë„ÅÆ„Ç®„É©„Éº]');
          errorLogs.slice(-5).forEach(e => {
            const time = new Date(e.time).toLocaleString();
            info.push(`${time}: ${e.message.slice(0, 60)}`);
          });
        }
      } catch (e) {
        // „É°„É¢„É™‰∏ä„ÅÆ„É≠„Ç∞„Å´„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
        if (debugLog && debugLog.length > 0) {
          const errors = debugLog.filter(log => log.includes('Â§±Êïó') || log.includes('„Ç®„É©„Éº')).slice(-5);
          if (errors.length > 0) {
            info.push('[ÊúÄËøë„ÅÆ„Ç®„É©„Éº]');
            errors.forEach(e => info.push(e.slice(0, 60)));
          }
        }
      }
      
      document.getElementById('supportInfoText').value = info.join('\n');
    }

    function copySupportInfo() {
      const text = document.getElementById('supportInfoText').value;
      navigator.clipboard.writeText(text).then(() => {
        alert('„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ\n„Çµ„Éù„Éº„Éà„Å´Ë≤º„Çä‰ªò„Åë„Å¶„ÅäÈÄÅ„Çä„Åè„Å†„Åï„ÅÑ„ÄÇ');
      }).catch(() => {
        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
        document.getElementById('supportInfoText').select();
        document.execCommand('copy');
        alert('„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ');
      });
    }

    function shareSupportInfo() {
      const text = document.getElementById('supportInfoText').value;
      if (navigator.share) {
        navigator.share({
          title: '„Çµ„Éù„Éº„ÉàË®∫Êñ≠ÊÉÖÂ†±',
          text: text
        }).catch(() => {});
      } else {
        copySupportInfo();
      }
    }

    function updateDebugDisplay() {
      // PROÁä∂ÊÖã
      const proDisplay = document.getElementById('proStatusDisplay');
      proDisplay.innerHTML = `
        ÁèæÂú®: ${isPro ? '‚úÖ PROÁâà' : '‚ùå ÈÄöÂ∏∏Áâà'}<br>
        Ë™çË®ºÊñπÊ≥ï: ${FirebaseSync.user ? '„ÇØ„É©„Ç¶„Éâ' : '„É≠„Éº„Ç´„É´'}
      `;
      
      // „Ç∑„Çπ„ÉÜ„É†ÊÉÖÂ†±
      const sysInfo = document.getElementById('debugSystemInfo');
      const memUsage = performance.memory ? `${Math.round(performance.memory.usedJSHeapSize / 1024 / 1024)}MB` : 'ÂèñÂæó‰∏çÂèØ';
      sysInfo.innerHTML = `
        „Ç¢„Éó„É™Ver: ${APP_VERSION}<br>
        Ë°®Á§∫Âπ¥: ${currentYear}<br>
        „ÉÜ„Éº„Éû: ${designSettings.theme}<br>
        ÊñáÂ≠ó„Çµ„Ç§„Ç∫: ${designSettings.size} / Ë°åÈ´ò: ${designSettings.height}<br>
        „É°„É¢‰ª∂Êï∞: ${Object.keys(memoData).length}<br>
        ÁîªÈù¢: ${window.innerWidth}x${window.innerHeight}<br>
        „Çø„ÉÉ„ÉÅ: ${('ontouchstart' in window) ? '‚úÖ' : '‚ùå'}<br>
        „Ç™„É≥„É©„Ç§„É≥: ${navigator.onLine ? '‚úÖ' : '‚ùå'}<br>
        „É°„É¢„É™: ${memUsage}<br>
        UA: ${navigator.userAgent.slice(0, 50)}...
      `;
      
      // FirebaseÊÉÖÂ†±
      const fbInfo = document.getElementById('debugFirebaseInfo');
      fbInfo.innerHTML = `
        Êé•Á∂ö: ${FirebaseSync.firestore ? '‚úÖ' : '‚ùå'}<br>
        „É≠„Ç∞„Ç§„É≥: ${FirebaseSync.user ? '‚úÖ ' + (FirebaseSync.user.email || 'Anonymous') : '‚ùå Êú™„É≠„Ç∞„Ç§„É≥'}<br>
        UID: ${FirebaseSync.user ? FirebaseSync.user.uid.slice(0, 12) + '...' : '-'}<br>
        ÊúÄÁµÇÂêåÊúü: ${FirebaseSync.lastSyncTime ? FirebaseSync.lastSyncTime.toLocaleString() : 'Êú™ÂêåÊúü'}
      `;
      
      // „Çπ„Éà„É¨„Éº„Ç∏ÊÉÖÂ†±
      const storageInfo = document.getElementById('debugStorageInfo');
      const lsKeys = Object.keys(localStorage).length;
      const lsSize = new Blob(Object.values(localStorage)).size;
      storageInfo.innerHTML = `
        IndexedDB: ${db ? '‚úÖ Êé•Á∂ö‰∏≠' : '‚ùå'}<br>
        localStorage: ${lsKeys}„Ç≠„Éº / ${(lsSize / 1024).toFixed(1)}KB<br>
        „Ç∑„Éï„Éà„Éë„Çø„Éº„É≥: ${shiftPatterns.map((p, i) => `${i+1}:${p.length}‰ª∂`).join(', ')}
      `;
      
      // PWAÊÉÖÂ†±
      const pwaInfo = document.getElementById('debugPWAInfo');
      const swStatus = navigator.serviceWorker?.controller ? '‚úÖ ÊúâÂäπ' : '‚ùå ÁÑ°Âäπ';
      pwaInfo.innerHTML = `
        Service Worker: ${swStatus}<br>
        „Çπ„Çø„É≥„Éâ„Ç¢„É≠„É≥: ${window.matchMedia('(display-mode: standalone)').matches ? '‚úÖ' : '‚ùå'}<br>
        „Éó„É≠„Éà„Ç≥„É´: ${location.protocol}
      `;
      
      // Êìç‰Ωú„É≠„Ç∞
      const logOutput = document.getElementById('debugLogOutput');
      logOutput.value = debugLog.slice(-30).join('\n');
    }

    // „Éá„Éê„ÉÉ„Ç∞Áî®ÔºöÂº∑Âà∂ÂêåÊúü
    async function debugForceSync() {
      if (!FirebaseSync.user) {
        showToast('„É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì');
        return;
      }
      addDebugLog('Âº∑Âà∂ÂêåÊúüÈñãÂßã...');
      await FirebaseSync.backupToCloud();
      updateDebugDisplay();
    }

    // „Éá„Éê„ÉÉ„Ç∞Áî®Ôºö„ÇØ„É©„Ç¶„Éâ„Éá„Éº„ÇøÁ¢∫Ë™ç
    async function debugShowCloudData() {
      if (!FirebaseSync.user || !FirebaseSync.firestore) {
        showToast('„É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì');
        return;
      }
      try {
        const docRef = FirebaseSync.firestore.collection('users').doc(FirebaseSync.user.uid);
        const doc = await docRef.get();
        if (doc.exists) {
          const data = doc.data();
          const info = `=== „ÇØ„É©„Ç¶„Éâ„Éá„Éº„Çø ===
Êõ¥Êñ∞Êó•ÊôÇ: ${data.updatedAt?.toDate?.().toLocaleString() || '‰∏çÊòé'}
PROÁä∂ÊÖã: ${data.isPro ? '‚úÖ' : '‚ùå'}
„Ç∑„Éï„Éà„Éá„Éº„Çø: ${data.shift ? '‚úÖ' : '‚ùå'}
ÂÆ∂Ë®àÁ∞ø„Éá„Éº„Çø: ${data.kakeibo ? '‚úÖ' : '‚ùå'}
„É°„É¢„Éá„Éº„Çø: ${data.memo ? '‚úÖ' : '‚ùå'}`;
          alert(info);
          addDebugLog('„ÇØ„É©„Ç¶„Éâ„Éá„Éº„ÇøÁ¢∫Ë™çÂÆå‰∫Ü');
        } else {
          alert('„ÇØ„É©„Ç¶„Éâ„Å´„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
        }
      } catch (e) {
        alert('ÂèñÂæóÂ§±Êïó: ' + e.message);
        addDebugLog('„ÇØ„É©„Ç¶„Éâ„Éá„Éº„ÇøÂèñÂæóÂ§±Êïó: ' + e.message);
      }
    }

    // „Éá„Éê„ÉÉ„Ç∞Áî®ÔºöÁîü„Éá„Éº„ÇøÂá∫Âäõ
    async function debugExportRawData() {
      try {
        const rawData = {
          exportDate: new Date().toISOString(),
          isPro: isPro,
          currentYear: currentYear,
          memoData: memoData,
          shiftPatterns: shiftPatterns,
          designSettings: designSettings,
          statusColorSettings: statusColorSettings,
          dayStatusColors: dayStatusColors,
          localStorage: {...localStorage},
          firebaseUser: FirebaseSync.user ? { uid: FirebaseSync.user.uid, email: FirebaseSync.user.email } : null
        };
        
        const blob = new Blob([JSON.stringify(rawData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `debug_export_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
        addDebugLog('Áîü„Éá„Éº„ÇøÂá∫ÂäõÂÆå‰∫Ü');
        showToast('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„Åü');
      } catch (e) {
        addDebugLog('Áîü„Éá„Éº„ÇøÂá∫ÂäõÂ§±Êïó: ' + e.message);
        showToast('„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÂ§±Êïó');
      }
    }

    // „Éá„Éê„ÉÉ„Ç∞Áî®Ôºö„Çπ„Éà„É¨„Éº„Ç∏„Ç≠„Éº‰∏ÄË¶ß
    function debugShowStorageKeys() {
      const lsKeys = Object.keys(localStorage).sort();
      const info = `=== localStorage (${lsKeys.length}„Ç≠„Éº) ===\n${lsKeys.map(k => `${k}: ${localStorage[k].length}ÊñáÂ≠ó`).join('\n')}`;
      alert(info);
      addDebugLog('„Çπ„Éà„É¨„Éº„Ç∏„Ç≠„Éº‰∏ÄË¶ßË°®Á§∫');
    }

    // „Éá„Éê„ÉÉ„Ç∞Áî®ÔºöSWÂÜçÁôªÈå≤
    async function debugReloadSW() {
      if ('serviceWorker' in navigator) {
        try {
          const registrations = await navigator.serviceWorker.getRegistrations();
          for (const reg of registrations) {
            await reg.unregister();
          }
          addDebugLog('SWÁôªÈå≤Ëß£Èô§ÂÆå‰∫Ü');
          showToast('Service WorkerÂÜçÁôªÈå≤‰∏≠... „É™„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        } catch (e) {
          addDebugLog('SWÂÜçÁôªÈå≤Â§±Êïó: ' + e.message);
        }
      }
    }

    // „Éá„Éê„ÉÉ„Ç∞Áî®ÔºöPROÁä∂ÊÖãÂÆåÂÖ®„É™„Çª„ÉÉ„Éà
    async function debugResetPro() {
      if (confirm('PROÁä∂ÊÖã„ÇíÂÆåÂÖ®„Å´„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü\nÔºà„É≠„Éº„Ç´„É´„Éª„ÇØ„É©„Ç¶„Éâ‰∏°ÊñπÔºâ')) {
        isPro = false;
        localStorage.removeItem('ntrr_pro_code');
        saveData();
        updateProUI();
        
        if (FirebaseSync.user) {
          try {
            await FirebaseSync.setProStatus(false);
            addDebugLog('PROÁä∂ÊÖã„É™„Çª„ÉÉ„ÉàÔºà„ÇØ„É©„Ç¶„ÉâÂê´„ÇÄÔºâ');
          } catch (e) {
            addDebugLog('PROÁä∂ÊÖã„É™„Çª„ÉÉ„ÉàÔºà„É≠„Éº„Ç´„É´„ÅÆ„ÅøÔºâ');
          }
        } else {
          addDebugLog('PROÁä∂ÊÖã„É™„Çª„ÉÉ„ÉàÔºà„É≠„Éº„Ç´„É´Ôºâ');
        }
        
        updateDebugDisplay();
        showToast('PROÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü');
      }
    }

    // „Éá„Éê„ÉÉ„Ç∞Áî®Ôºö„É≠„Ç∞„ÇØ„É™„Ç¢
    function debugClearLog() {
      debugLog = [];
      addDebugLog('„É≠„Ç∞„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü');
      updateDebugDisplay();
    }

    async function toggleProStatus(status) {
      isPro = status;
      saveData();
      updateProUI();
      updateDebugDisplay();
      addDebugLog(`PROÁâà„Çí${status ? 'ON' : 'OFF'}„Å´Â§âÊõ¥`);
      
      // FirebaseÈÄ£Êê∫‰∏≠„Å™„Çâ„ÇØ„É©„Ç¶„Éâ„Å´„ÇÇ‰øùÂ≠ò
      if (FirebaseSync.user) {
        try {
          await FirebaseSync.setProStatus(status);
          showToast(`PROÁâà„Çí${status ? 'ÊúâÂäπ' : 'ÁÑ°Âäπ'}„Å´„Åó„Åæ„Åó„ÅüÔºà„ÇØ„É©„Ç¶„ÉâÂêåÊúüÊ∏à„ÅøÔºâ`);
        } catch (e) {
          showToast(`PROÁâà„Çí${status ? 'ÊúâÂäπ' : 'ÁÑ°Âäπ'}„Å´„Åó„Åæ„Åó„ÅüÔºà„É≠„Éº„Ç´„É´„ÅÆ„ÅøÔºâ`);
        }
      } else {
        showToast(`PROÁâà„Çí${status ? 'ÊúâÂäπ' : 'ÁÑ°Âäπ'}„Å´„Åó„Åæ„Åó„Åü`);
      }
    }

    function copyDebugLog() {
      const logOutput = document.getElementById('debugLogOutput');
      navigator.clipboard.writeText(logOutput.value).then(() => {
        showToast('„É≠„Ç∞„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
      });
    }

    // Service Worker„Ç≠„É£„ÉÉ„Ç∑„É•ÂâäÈô§
    async function clearServiceWorkerCache() {
      if (confirm('Service Worker„ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\nÊ¨°ÂõûË™≠„ÅøËæº„ÅøÊôÇ„Å´ÂÜçÂèñÂæó„Åï„Çå„Åæ„Åô„ÄÇ')) {
        try {
          const cacheNames = await caches.keys();
          await Promise.all(cacheNames.map(name => caches.delete(name)));
          addDebugLog('SW„Ç≠„É£„ÉÉ„Ç∑„É•ÂâäÈô§ÂÆå‰∫Ü: ' + cacheNames.join(', '));
          showToast('„Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
          updateDebugDisplay();
        } catch (err) {
          addDebugLog('SW„Ç≠„É£„ÉÉ„Ç∑„É•ÂâäÈô§Â§±Êïó: ' + err.message);
          showToast('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
        }
      }
    }

    // ÂÖ®„Éá„Éº„ÇøÂâäÈô§
    async function clearAllData() {
      if (confirm('ÂÖ®„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n\n‚ö†Ô∏è ‰∫àÂÆö„ÄÅ„Ç∑„Éï„Éà„Éë„Çø„Éº„É≥„ÄÅË®≠ÂÆö„ÅåÂÖ®„Å¶Ê∂à„Åà„Åæ„Åô„ÄÇ\n„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ')) {
        if (confirm('Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
          try {
            // IndexedDBÂâäÈô§
            if (db) {
              const transaction = db.transaction([STORE_NAME], 'readwrite');
              const store = transaction.objectStore(STORE_NAME);
              await new Promise((resolve, reject) => {
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
              });
            }
            // LocalStorage„ÇÇÂâäÈô§
            localStorage.removeItem('scheduleData_v5');
            localStorage.removeItem('holidaysCache');
            localStorage.removeItem('ntrr_pro_code');
            addDebugLog('ÂÖ®„Éá„Éº„ÇøÂâäÈô§ÂÆå‰∫Ü');
            showToast('ÂÖ®„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ„É™„É≠„Éº„Éâ„Åó„Åæ„Åô...');
            setTimeout(() => location.reload(), 1500);
          } catch (e) {
            addDebugLog('ÂâäÈô§„Ç®„É©„Éº: ' + e.message);
            showToast('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
          }
        }
      }
    }

    // ========== „Éà„Éº„Çπ„Éà ==========
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.remove('show');
      void toast.offsetWidth; // reflow
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }

    // ========== „É°„Éã„É•„Éº ==========
    function toggleOptionsMenu() {
      const menu = document.getElementById('optionsMenu');
      menu.classList.toggle('show');
    }
    window.toggleOptionsMenu = toggleOptionsMenu;

    function closeOptionsMenu() {
      document.getElementById('optionsMenu').classList.remove('show');
    }

    function closeAllMenus() {
      document.getElementById('floatingMenu').classList.remove('show');
      document.getElementById('optionsMenu').classList.remove('show');
      activeMenuTarget = null;
    }

    function changeYear(delta) {
      currentYear += delta;
      document.getElementById('yearDisplay').textContent = currentYear + 'Âπ¥';
      holidays = getHolidays(currentYear);
      renderSchedule();
      window.scrollTo(0, 0);
      saveData();
    }

    function goToToday() {
      const today = new Date();
      if (currentYear !== today.getFullYear()) {
        currentYear = today.getFullYear();
        document.getElementById('yearDisplay').textContent = currentYear + 'Âπ¥';
        holidays = getHolidays(currentYear);
        renderSchedule();
      }
      const todayEl = document.querySelector('.day-row.today');
      if (todayEl) {
        todayEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    function toggleEditMode() {
      editMode = !editMode;
      const btn = document.getElementById('editModeBtn');
      const banner = document.getElementById('editBanner');
      const container = document.getElementById('container');
      const patternFloatBtn = document.getElementById('patternFloatBtn');
      
      if (editMode) {
        btn.classList.add('active');
        btn.textContent = 'ÂÆå‰∫Ü';
        banner.classList.add('show');
        container.classList.add('edit-mode');
        patternFloatBtn.classList.add('show');
      } else {
        btn.classList.remove('active');
        btn.textContent = '„Ç∑„Éï„Éà';
        banner.classList.remove('show');
        container.classList.remove('edit-mode');
        patternFloatBtn.classList.remove('show');
      }
    }

    // ========== „Éö„Éº„Ç∏Âàá„ÇäÊõø„Åà ==========
    function openSettingsPage() {
      document.getElementById('mainPage').classList.remove('active');
      document.getElementById('settingsPage').classList.add('active');
      renderPatternSettings();
    }

    function closeSettingsPage() {
      document.getElementById('settingsPage').classList.remove('active');
      document.getElementById('mainPage').classList.add('active');
    }

    // ========== „Éë„Çø„Éº„É≥Ë®≠ÂÆö„Éö„Éº„Ç∏ ==========
    function renderPatternSettings() {
      const list = document.getElementById('patternList');
      list.innerHTML = '';

      shiftPatterns.forEach((pattern, index) => {
        const card = document.createElement('div');
        card.className = 'pattern-card';
        card.innerHTML = `
          <div class="pattern-card-header" style="border-left: 4px solid ${PATTERN_COLORS[index]}">
            <span class="pattern-name">${PATTERN_NAMES[index]}</span>
          </div>
          <div class="pattern-card-body">
            <textarea id="patternInput${index}" placeholder="1Ë°å„Å´1„Å§ÂÖ•Âäõ">${pattern.join('\n')}</textarea>
            <div class="pattern-hint">‰∏ä„Åã„ÇâÈ†Ü„Å´Áπ∞„ÇäËøî„Åï„Çå„Åæ„ÅôÔºàÊúÄÂ§ß90È†ÖÁõÆÔºâ</div>
            <div class="pattern-preview" id="preview${index}">
              „Éó„É¨„Éì„É•„Éº: ${pattern.map(p => `<span>${p}</span>`).join('')}
            </div>
          </div>
        `;
        list.appendChild(card);

        const textarea = document.getElementById(`patternInput${index}`);
        textarea.addEventListener('input', () => {
          const lines = textarea.value.split('\n').map(s => s.trim()).filter(s => s !== '');
          const preview = document.getElementById(`preview${index}`);
          if (lines.length > 0) {
            // XSSÂØæÁ≠ñ: textContent„ÅßÂÆâÂÖ®„Å´„Ç®„Çπ„Ç±„Éº„Éó
            const spans = lines.slice(0, 20).map(p => {
              const span = document.createElement('span');
              span.textContent = p;
              return span.outerHTML;
            }).join('');
            preview.innerHTML = '„Éó„É¨„Éì„É•„Éº: ' + spans + (lines.length > 20 ? '...' : '');
          } else {
            preview.innerHTML = '„Éó„É¨„Éì„É•„Éº: (Êú™Ë®≠ÂÆö)';
          }
        });
      });
    }

    function saveAllPatterns() {
      for (let i = 0; i < 4; i++) {
        const textarea = document.getElementById(`patternInput${i}`);
        let lines = textarea.value.split('\n').map(s => s.trim()).filter(s => s !== '');
        if (lines.length > MAX_PATTERN_ITEMS) {
          lines = lines.slice(0, MAX_PATTERN_ITEMS);
          showToast(`„Éë„Çø„Éº„É≥${['A','B','C','D'][i]}„ÅØ${MAX_PATTERN_ITEMS}È†ÖÁõÆ„Å´Âà∂Èôê„Åï„Çå„Åæ„Åó„Åü`);
        }
        if (lines.length > 0) {
          shiftPatterns[i] = lines;
        }
      }
      saveData();
      closeSettingsPage();
    }

    // ========== „Ç∑„Éï„ÉàÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ ==========
    function updateStartPositionOptions() {
      const patternIndex = parseInt(document.getElementById('patternSelect').value);
      const pattern = shiftPatterns[patternIndex];
      const select = document.getElementById('startPosition');
      select.innerHTML = '';
      
      pattern.forEach((item, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = `${index + 1}Áï™ÁõÆ: ${item}`;
        select.appendChild(option);
      });
    }

    function openShiftSelectModal(key) {
      pendingShiftStart = key;
      document.getElementById('patternSelect').value = '0';
      document.getElementById('repeatCount').value = '1';
      updateStartPositionOptions();
      document.getElementById('shiftSelectModal').classList.add('show');
    }

    function closeShiftSelectModal() {
      document.getElementById('shiftSelectModal').classList.remove('show');
    }

    function confirmShiftSettings() {
      selectedPatternIndex = parseInt(document.getElementById('patternSelect').value);
      selectedRepeatCount = parseInt(document.getElementById('repeatCount').value) || 1;
      selectedStartPosition = parseInt(document.getElementById('startPosition').value) || 0;
      closeShiftSelectModal();
      openConfirmModal();
    }

    // ========== Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´ ==========
    function openConfirmModal() {
      const [year, month, day] = pendingShiftStart.split('-').map(Number);
      const pattern = shiftPatterns[selectedPatternIndex];
      const totalDays = pattern.length * selectedRepeatCount;

      document.getElementById('confirmDate').textContent = `${year}Âπ¥${month}Êúà${day}Êó•`;
      document.getElementById('confirmPattern').textContent = PATTERN_NAMES[selectedPatternIndex];
      document.getElementById('confirmStartPos').textContent = `${selectedStartPosition + 1}Áï™ÁõÆ (${pattern[selectedStartPosition]})`;
      document.getElementById('confirmRepeat').textContent = selectedRepeatCount;
      document.getElementById('confirmDays').textContent = totalDays;
      document.getElementById('confirmModal').classList.add('show');
    }

    function closeConfirmModal() {
      document.getElementById('confirmModal').classList.remove('show');
      pendingShiftStart = null;
    }

    // ========== „Ç∑„Éï„ÉàÊåøÂÖ•ÂÆüË°å ==========
    async function executeShiftInsert() {
      if (!pendingShiftStart) {
        closeConfirmModal();
        return;
      }
      
      // ÊåøÂÖ•Ââç„ÅÆÁä∂ÊÖã„Çí‰øùÂ≠ò
      await ShiftHistory.addHistory('input');

      const [year, month, day] = pendingShiftStart.split('-').map(Number);
      const pattern = shiftPatterns[selectedPatternIndex];
      let totalDays = pattern.length * selectedRepeatCount;
      
      // 365Êó•„ÅßÊâì„Å°Âàá„Çä
      if (totalDays > 365) {
        totalDays = 365;
        showToast('‚ö†Ô∏è 365Êó•„ÇíË∂Ö„Åà„Çã„Åü„ÇÅÊâì„Å°Âàá„Çä„Åæ„Åó„Åü');
      }

      let currentDate = new Date(year, month - 1, day);
      let patternIndex = selectedStartPosition;
      
      for (let i = 0; i < totalDays; i++) {
        const y = currentDate.getFullYear();
        const m = currentDate.getMonth() + 1;
        const d = currentDate.getDate();
        const key = `${y}-${m}-${d}`;

        if (!memoData[key]) {
          memoData[key] = [];
        }
        memoData[key][0] = pattern[patternIndex % pattern.length];

        patternIndex++;
        currentDate.setDate(currentDate.getDate() + 1);
      }

      saveData(true); // ÈÄöÂ∏∏„ÅÆÂ±•Ê≠¥„Çπ„Ç±„Ç∏„É•„Éº„É´„ÅØ„Çπ„Ç≠„ÉÉ„Éó
      ShiftHistory.addHistory('shift'); // „Ç∑„Éï„ÉàÊåøÂÖ•„Å®„Åó„Å¶Âç≥Â∫ß„Å´Â±•Ê≠¥‰øùÂ≠ò
      closeConfirmModal();
      renderSchedule();
      showToast(`${totalDays}Êó•ÂàÜ„ÅÆ„Ç∑„Éï„Éà„ÇíÊåøÂÖ•„Åó„Åæ„Åó„Åü`);
    }

    function onFirstMemoClick(key, event) {
      if (editMode) {
        event.preventDefault();
        event.stopPropagation();
        openShiftSelectModal(key);
      }
    }

    function getDaysInMonth(year, month) {
      return new Date(year, month + 1, 0).getDate();
    }

    function getWeekday(year, month, day) {
      return new Date(year, month, day).getDay();
    }

    function isToday(year, month, day) {
      const today = new Date();
      return today.getFullYear() === year && 
             today.getMonth() === month && 
             today.getDate() === day;
    }

    function getMemos(key) {
      if (!memoData[key]) {
        memoData[key] = [''];
      }
      return memoData[key];
    }

    function updateMemo(key, index, value) {
      if (!memoData[key]) {
        memoData[key] = [''];
      }
      memoData[key][index] = value;
      saveData();
      
      // „Éá„Éê„ÉÉ„Ç∞„Ç≥„Éº„Éâ„ÉÅ„Çß„ÉÉ„ÇØ
      checkDebugCode(key, value);
      
      // PRO„Ç≥„Éº„Éâ„ÉÅ„Çß„ÉÉ„ÇØ
      checkProCode(key, value);
    }

    function showMenu(key, index, event) {
      if (editMode) return;
      
      const btn = event.currentTarget;
      const rect = btn.getBoundingClientRect();
      const menu = document.getElementById('floatingMenu');
      
      activeMenuTarget = { key, index };
      
      menu.style.top = rect.top + 'px';
      menu.classList.add('show');
    }

    function closeMenu() {
      document.getElementById('floatingMenu').classList.remove('show');
      activeMenuTarget = null;
    }

    function addMemo() {
      if (!activeMenuTarget) return;
      const { key, index } = activeMenuTarget;
      if (!memoData[key]) {
        memoData[key] = [''];
      }
      memoData[key].splice(index + 1, 0, '');
      saveData();
      closeAllMenus();
      renderSchedule();
    }

    function copyMemo() {
      if (!activeMenuTarget) return;
      const { key, index } = activeMenuTarget;
      const text = memoData[key]?.[index] || '';
      if (text) {
        navigator.clipboard.writeText(text).then(() => {
          showToast('„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
        }).catch(() => {
          showToast('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
        });
      } else {
        showToast('„Ç≥„Éî„Éº„Åô„ÇãÂÜÖÂÆπ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
      }
      closeAllMenus();
    }

    function deleteMemo() {
      if (!activeMenuTarget) return;
      const { key, index } = activeMenuTarget;
      if (memoData[key] && memoData[key].length > 1) {
        memoData[key].splice(index, 1);
      } else {
        memoData[key] = [''];
      }
      saveData();
      closeAllMenus();
      renderSchedule();
    }

    function renderSchedule() {
      const container = document.getElementById('container');
      const wasEditMode = container.classList.contains('edit-mode');
      container.innerHTML = '';
      if (wasEditMode) {
        container.classList.add('edit-mode');
      }

      for (let month = 0; month < 12; month++) {
        const monthHeader = document.createElement('div');
        monthHeader.className = 'month-header';
        monthHeader.textContent = (month + 1) + 'Êúà';
        container.appendChild(monthHeader);

        const daysInMonth = getDaysInMonth(currentYear, month);
        for (let day = 1; day <= daysInMonth; day++) {
          const weekdayIndex = getWeekday(currentYear, month, day);
          const weekdayName = WEEKDAYS[weekdayIndex];
          const key = `${currentYear}-${month + 1}-${day}`;
          
          // Á•ùÊó•„ÉÅ„Çß„ÉÉ„ÇØÔºàAPI„ÅØ YYYY-MM-DD ÂΩ¢ÂºèÔºâ
          const keyPadded = `${currentYear}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const holidayName = holidays[keyPadded] || holidays[key];

          // „Çπ„ÉÜ„Éº„Çø„Çπ„Ç´„É©„Éº
          const statusColor = getStatusColorForDay(key);

          const row = document.createElement('div');
          row.className = 'day-row';
          if (weekdayIndex === 0) row.classList.add('sunday');
          if (weekdayIndex === 6) row.classList.add('saturday');
          if (holidayName) row.classList.add('holiday');
          if (isToday(currentYear, month, day)) row.classList.add('today');

          const dateDiv = document.createElement('div');
          dateDiv.className = 'day-date';
          dateDiv.textContent = day;
          dateDiv.onclick = () => cycleStatusColor(key);

          const weekdayDiv = document.createElement('div');
          weekdayDiv.className = 'day-weekday';
          weekdayDiv.textContent = weekdayName;
          weekdayDiv.onclick = () => cycleStatusColor(key);

          const memosContainer = document.createElement('div');
          memosContainer.className = 'memos-container';
          // „Çπ„ÉÜ„Éº„Çø„Çπ„Ç´„É©„Éº„ÇíÈÅ©Áî®
          if (statusColor !== 'transparent') {
            memosContainer.style.backgroundColor = statusColor;
            // ËñÑ„ÅÑËÉåÊôØËâ≤„Å™„ÅÆ„ÅßÊñáÂ≠ó„ÅØÊöó„ÅÑËâ≤„Å´
            memosContainer.style.setProperty('--memo-text-color', '#333');
          }

          let memos = getMemos(key);
          
          if (holidayName && (!memos[0] || memos[0] === '')) {
            memos[0] = holidayName;
            memoData[key] = memos;
          }

          memos.forEach((memo, index) => {
            const memoItem = document.createElement('div');
            memoItem.className = 'memo-item';

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'memo-input';
            input.maxLength = 5000;
            if (index === 0 && holidayName && memo === holidayName) {
              input.classList.add('holiday-auto');
            }
            input.value = memo;
            input.placeholder = '„Çø„ÉÉ„Éó„Åó„Å¶ÂÖ•Âäõ';
            input.oninput = (e) => updateMemo(key, index, e.target.value);
            
            if (index === 0) {
              input.onclick = (e) => onFirstMemoClick(key, e);
            }

            const menuBtn = document.createElement('button');
            menuBtn.className = 'memo-menu-btn';
            menuBtn.textContent = '‚ãÆ';
            menuBtn.onclick = (e) => showMenu(key, index, e);

            memoItem.appendChild(input);
            memoItem.appendChild(menuBtn);
            memosContainer.appendChild(memoItem);
          });

          row.appendChild(dateDiv);
          row.appendChild(weekdayDiv);
          row.appendChild(memosContainer);
          container.appendChild(row);
        }
      }
    }

    let scrollTimer;
    window.addEventListener('scroll', () => {
      clearTimeout(scrollTimer);
      scrollTimer = setTimeout(saveScroll, 200);
    });

    // ÂàùÊúüÂåñÔºàÈùûÂêåÊúüÔºâ
    async function init() {
      await loadData();
      await ShiftHistory.load();
      document.getElementById('yearDisplay').textContent = currentYear + 'Âπ¥';
      
      // Service WorkerÁôªÈå≤
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
          .then((reg) => {
            addDebugLog('Service WorkerÁôªÈå≤ÊàêÂäü');
          })
          .catch((err) => {
            addDebugLog('Service WorkerÁôªÈå≤Â§±Êïó: ' + err.message);
          });
      }
      
      // Ëµ∑ÂãïÊôÇ„Å´API„Åã„ÇâÁ•ùÊó•„ÇíÂèñÂæóÔºà„Ç™„É≥„É©„Ç§„É≥„Å™„ÇâÔºâ
      await fetchHolidaysFromAPI();
      holidays = getHolidays(currentYear);
      renderSchedule();
      restoreScroll();
      
      // PROÁä∂ÊÖã„ÇíÂÜçÁ¢∫Ë™çÔºà„Ç™„É≥„É©„Ç§„É≥„Å™„ÇâÔºâ
      recheckProStatus();
    }
    
    init();
  </script>
  </div><!-- /shift-tab -->

  <!-- ========== ÂÆ∂Ë®àÁ∞ø„Çø„Éñ ========== -->
  <div id="kakeibo-tab" class="main-tab-content">
    <div class="kakeibo-app">
      <div class="kakeibo-container">
        <!-- 1Ë°åÁõÆ: ÂêçÂâçÂÖ•Âäõ + ‰ªäÊúà + Êñ∞Ë¶èÁôªÈå≤ -->
        <div class="kakeibo-row">
          <input type="text" class="kakeibo-name-input" id="kakeiboNameInput" placeholder="2026Âπ¥1Êúà / „É≠„Éº„É≥ËøîÊ∏àË°®„Å™„Å©" maxlength="50">
          <button class="kakeibo-btn" onclick="Kakeibo.setThisMonth()">‰ªäÊúà</button>
          <button class="kakeibo-btn kakeibo-btn-primary" onclick="Kakeibo.registerNew()">Êñ∞Ë¶èÁôªÈå≤</button>
        </div>
        <!-- 2Ë°åÁõÆ: ‰∏ÄË¶ß + Êìç‰Ωú -->
        <div class="kakeibo-row">
          <select id="kakeiboListSelect" class="kakeibo-select-wide" onchange="Kakeibo.onListSelect()">
            <option value="">-- ‰øùÂ≠ò„Éá„Éº„Çø‰∏ÄË¶ß --</option>
          </select>
          <select id="kakeiboActionSelect" class="kakeibo-select">
            <option value="">Êìç‰Ωú</option>
            <option value="load">Âëº„Å≥Âá∫„Åó</option>
            <option value="delete">ÂâäÈô§</option>
          </select>
          <button class="kakeibo-btn" onclick="Kakeibo.executeAction()">ÂÆüË°å</button>
          <input type="file" id="kakeiboImportFile" accept=".json" style="display:none" onchange="Kakeibo.importData(this)">
        </div>
        <!-- Â±•Ê≠¥„Çπ„É©„Ç§„ÉÄ„ÉºÔºà„Éà„Ç∞„É´Ë°®Á§∫Ôºâ -->
        <div class="kakeibo-history-slider" id="kakeiboHistorySlider" style="display:none;">
          <div class="kakeibo-history-header">
            <span>Êõ¥Êñ∞Â±•Ê≠¥Ôºà50‰ª∂„Åæ„ÅßÔºâ</span>
            <button class="kakeibo-btn-small" onclick="Kakeibo.toggleHistory()">Èñâ„Åò„Çã</button>
          </div>
          <div class="kakeibo-history-scroll" id="kakeiboHistoryScroll"></div>
        </div>
        
        <!-- ÂèéÊîØË°®Á§∫ -->
        <div class="balance" id="kakeiboBalanceSection" onclick="Kakeibo.copyBalance()" title="„ÇØ„É™„ÉÉ„ÇØ„Åß„Ç≥„Éî„Éº">
          <span id="kakeiboBalanceAmount">¬•0</span>
        </div>
        <div class="section">
          <h3>ÂâçÊúàÁπ∞Ë∂ä</h3>
          <input type="text" id="kakeiboCarryOver" maxlength="50" style="width:100%;padding:8px;font-size:14px;border:1px solid #ccc;border-radius:4px;">
          <div class="total" id="kakeiboCarryOverTotal">¬•0</div>
        </div>
        <div class="section">
          <h3>ÂèéÂÖ•</h3>
          <textarea class="income-area" id="kakeiboIncomeArea" maxlength="5000"></textarea>
          <div class="total" id="kakeiboIncomeTotal">¬•0</div>
        </div>
        <div class="section">
          <h3>ÊîØÂá∫</h3>
          <textarea class="expense-area" id="kakeiboExpenseArea" maxlength="5000"></textarea>
          <div class="total" id="kakeiboExpenseTotal">¬•0</div>
        </div>
        <div class="section">
          <h3>„ÉÜ„É≥„Éó„É¨„Éº„Éà</h3>
          <textarea class="template-area" id="kakeiboTemplateArea" maxlength="5000"></textarea>
          <div class="template-buttons">
            <button onclick="Kakeibo.pasteTemplate()">ÊîØÂá∫„Å´Ë≤º‰ªò</button>
            <button onclick="Kakeibo.copyTemplate()">„Ç≥„Éî„Éº</button>
          </div>
        </div>
        <div class="help-section">
          <h4>‰Ωø„ÅÑÊñπ</h4>
          <ul>
            <li><strong>Êï∞Â≠ó„ÇíËá™ÂãïË™çË≠ò</strong>ÔºöÂçäËßí„ÉªÂÖ®Ëßí„Å©„Å°„Çâ„ÇÇOK</li>
            <li><strong>Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó</strong>ÔºöÂÖ•ÂäõÂæå2Áßí„ÅßÂ±•Ê≠¥„Å´‰øùÂ≠ò</li>
            <li><strong>ÊñáÂ≠ó„Çà„ÇäÂè≥„ÅÆÊï∞Â≠ó„ÅØÁÑ°Ë¶ñ</strong>Ôºö„Ç≥„É°„É≥„Éà„Å®„Åó„Å¶‰Ωø„Åà„Åæ„Åô</li>
          </ul>
        </div>
      </div>
    </div>
  </div><!-- /kakeibo-tab -->

  <!-- ========== „É°„É¢„Çø„Éñ ========== -->
  <div id="memo-tab" class="main-tab-content">
    <div class="memo-app-new">
      <div class="memo-container-new">
        <!-- 1Ë°åÁõÆ: ÂêçÂâçÂÖ•Âäõ + Êñ∞Ë¶èÁôªÈå≤ -->
        <div class="memo-row">
          <input type="text" class="memo-name-input" id="memoNameInput" placeholder="„É°„É¢„ÅÆÂêçÂâç" maxlength="100">
          <button class="memo-btn memo-btn-primary" onclick="Memo.registerNew()">Êñ∞Ë¶èÁôªÈå≤</button>
        </div>
        <!-- 2Ë°åÁõÆ: ‰∏ÄË¶ß + Êìç‰Ωú -->
        <div class="memo-row">
          <select id="memoListSelect" class="memo-select-wide">
            <option value="">-- ‰øùÂ≠ò„É°„É¢‰∏ÄË¶ß --</option>
          </select>
          <select id="memoActionSelect" class="memo-select">
            <option value="">Êìç‰Ωú</option>
            <option value="load">Âëº„Å≥Âá∫„Åó</option>
            <option value="rename">ÂêçÂâçÂ§âÊõ¥</option>
            <option value="delete">ÂâäÈô§</option>
          </select>
          <button class="memo-btn" onclick="Memo.executeAction()">ÂÆüË°å</button>
          <input type="file" id="memoImportFile" accept=".json" style="display:none" onchange="Memo.importData(this)">
        </div>
        <!-- Â±•Ê≠¥„Çπ„É©„Ç§„ÉÄ„Éº -->
        <div class="memo-history-slider" id="memoHistorySlider" style="display:none;">
          <div class="memo-history-header">
            <span>Êõ¥Êñ∞Â±•Ê≠¥Ôºà50‰ª∂„Åæ„ÅßÔºâ</span>
            <button class="memo-btn-small" onclick="Memo.toggleHistory()">Èñâ„Åò„Çã</button>
          </div>
          <div class="memo-history-scroll" id="memoHistoryScroll"></div>
        </div>
        <!-- Ëâ≤Â§âÊõ¥„Éú„Çø„É≥ -->
        <div class="memo-row memo-color-row">
          <span class="memo-color-label">ÊñáÂ≠óËâ≤:</span>
          <button class="memo-color-btn memo-color-red" onclick="Memo.setColor('#dc2626')">Ëµ§</button>
          <button class="memo-color-btn memo-color-blue" onclick="Memo.setColor('#2563eb')">Èùí</button>
          <button class="memo-color-btn memo-color-green" onclick="Memo.setColor('#16a34a')">Á∑ë</button>
          <button class="memo-color-btn memo-color-black active" onclick="Memo.setColor(null)">Èªí</button>
          <button class="memo-btn memo-btn-clear" onclick="Memo.clearMemo()">„ÇØ„É™„Ç¢</button>
          <span class="memo-save-status" id="memoSaveStatus"></span>
        </div>
        <!-- „Ç®„Éá„Ç£„Çø -->
        <div class="memo-editor-wrapper">
          <div id="memoEditor" class="memo-editor" contenteditable="true" data-empty="true"></div>
        </div>
      </div>
    </div>
  </div><!-- /memo-tab -->

  <!-- ========== „Çø„ÉñÂàá„ÇäÊõø„Åà„ÉªÂÆ∂Ë®àÁ∞ø„Éª„É°„É¢„ÅÆJS ========== -->
  <script>
    // ========== „Çø„ÉñÂàá„ÇäÊõø„Åà ==========
    function switchMainTab(tab) {
      document.querySelectorAll('.main-tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.main-tab-content').forEach(content => content.classList.remove('active'));
      document.querySelector(`.main-tab-btn.${tab}-tab`).classList.add('active');
      document.getElementById(`${tab}-tab`).classList.add('active');
      localStorage.setItem('currentMainTab', tab);
      
      // „É°„Éã„É•„ÉºË°®Á§∫Âàá„ÇäÊõø„ÅàÁî®„ÅÆbody„ÇØ„É©„Çπ„ÇíÊõ¥Êñ∞
      document.body.classList.remove('current-tab-shift', 'current-tab-kakeibo', 'current-tab-memo');
      document.body.classList.add(`current-tab-${tab}`);
    }

    // ========== ÂÆ∂Ë®àÁ∞ø„É¢„Ç∏„É•„Éº„É´ÔºàÊñ∞‰ªïÊßòÔºâ==========
    const Kakeibo = {
      currentKey: null,          // ÁèæÂú®Á∑®ÈõÜ‰∏≠„ÅÆ„Ç≠„Éº
      history: [],               // Â±•Ê≠¥Ôºà50‰ª∂Ôºâ
      saveTimeout: null,         // debounceÁî®
      historyVisible: false,     // Â±•Ê≠¥Ë°®Á§∫Áä∂ÊÖã
      
      // ========== Â±•Ê≠¥ÁÆ°ÁêÜ ==========
      async loadHistory() {
        this.history = await loadFromDB('kakeibo_history') || [];
        this.updateHistoryCount();
      },
      async saveHistoryToDB() {
        while (this.history.length > 50) this.history.pop();
        await saveToDB('kakeibo_history', this.history);
        this.updateHistoryCount();
        if (this.historyVisible) this.renderHistory();
      },
      updateHistoryCount() {
        const el = document.getElementById('kakeiboHistoryCount');
        if (el) el.textContent = `(${this.history.length})`;
      },
      async addHistory(type) {
        const data = this.getCurrentData();
        if (!data.carryOver && !data.income && !data.expense) return;
        this.history.unshift({
          date: new Date().toISOString(),
          type: type, // 'input', 'paste', 'load', 'load-before'
          name: this.currentKey || '(Êú™‰øùÂ≠ò)',
          data: JSON.parse(JSON.stringify(data))
        });
        await this.saveHistoryToDB();
      },
      getCurrentData() {
        return {
          carryOver: document.getElementById('kakeiboCarryOver').value,
          income: document.getElementById('kakeiboIncomeArea').value,
          expense: document.getElementById('kakeiboExpenseArea').value,
          template: document.getElementById('kakeiboTemplateArea').value
        };
      },
      setCurrentData(data) {
        document.getElementById('kakeiboCarryOver').value = data.carryOver || '';
        document.getElementById('kakeiboIncomeArea').value = data.income || '';
        document.getElementById('kakeiboExpenseArea').value = data.expense || '';
        document.getElementById('kakeiboTemplateArea').value = data.template || '';
        this.updateBalanceDisplay();
      },
      
      // ========== Â±•Ê≠¥Ë°®Á§∫ ==========
      toggleHistory() {
        this.historyVisible = !this.historyVisible;
        const slider = document.getElementById('kakeiboHistorySlider');
        slider.style.display = this.historyVisible ? 'block' : 'none';
        if (this.historyVisible) this.renderHistory();
      },
      renderHistory() {
        const scroll = document.getElementById('kakeiboHistoryScroll');
        if (this.history.length === 0) {
          scroll.innerHTML = '<div style="padding:20px;color:#888;text-align:center;">Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
          return;
        }
        scroll.innerHTML = this.history.map((item, idx) => {
          const d = new Date(item.date);
          const dateStr = d.toLocaleString('ja-JP', { month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit' });
          const balance = this.calculateTotal(item.data.carryOver||'') + this.calculateTotal(item.data.income||'') - this.calculateTotal(item.data.expense||'');
          const typeClass = 'type-' + item.type;
          const itemClass = item.type === 'load' ? 'is-load' : (item.type === 'load-before' ? 'is-load-before' : '');
          const typeLabel = {input:'‚úèÔ∏èÂÖ•Âäõ', paste:'üìã„Éö„Éº„Çπ„Éà', load:'üì•ÂëºÂá∫Âæå', 'load-before':'üì§ÂëºÂá∫Ââç'}[item.type] || item.type;
          return `<div class="kakeibo-history-item ${itemClass}" onclick="Kakeibo.restoreFromHistory(${idx})">
            <div class="kakeibo-history-date">${dateStr}</div>
            <div class="kakeibo-history-type ${typeClass}">${typeLabel}</div>
            <div class="kakeibo-history-balance">${this.formatAmount(balance)}</div>
            <div class="kakeibo-history-name">${item.name}</div>
          </div>`;
        }).join('');
      },
      async restoreFromHistory(idx) {
        if (!this.history[idx]) return;
        // Âæ©ÂÖÉ
        this.setCurrentData(this.history[idx].data);
      },
      
      // ========== ÂÖ•ÂäõÊ§úÁü•„ÉªËá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó ==========
      onInput(e) {
        this.updateBalanceDisplay();
        this.saveCurrentData();
        // debounce: 1ÁßíÂæå„Å´„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó
        clearTimeout(this.saveTimeout);
        this.saveTimeout = setTimeout(() => this.addHistory('input'), 1000);
      },
      onPaste(e) {
        // „Éö„Éº„Çπ„ÉàÊôÇ„ÅØÂç≥Â∫ß„Å´„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰∫àÁ¥ÑÔºàÂÖ•Âäõ„Ç§„Éô„É≥„Éà„ÅÆÂæå„Å´Áô∫ÁÅ´Ôºâ
        setTimeout(() => this.addHistory('paste'), 100);
      },
      
      // ========== „Éá„Éº„Çø‰øùÂ≠ò„ÉªË™≠Ëæº ==========
      async saveCurrentData() {
        if (!this.currentKey) return;
        await saveToDB('kakeibo_data_' + this.currentKey, this.getCurrentData());
        await this.saveLastEdited();
        // FirebaseÂêåÊúü„Çí„Çπ„Ç±„Ç∏„É•„Éº„É´
        FirebaseSync.scheduleBackup();
      },
      async loadDataByKey(key) {
        const data = await loadFromDB('kakeibo_data_' + key);
        return data;
      },
      
      // ========== ‰∏ÄË¶ßÁÆ°ÁêÜ ==========
      async getDataList() {
        const list = await loadFromDB('kakeibo_list') || [];
        return list;
      },
      async saveDataList(list) {
        await saveToDB('kakeibo_list', list);
      },
      async updateListSelect() {
        const list = await this.getDataList();
        const select = document.getElementById('kakeiboListSelect');
        select.innerHTML = '<option value="">-- ‰øùÂ≠ò„Éá„Éº„Çø‰∏ÄË¶ß --</option>';
        list.forEach(item => {
          const opt = document.createElement('option');
          opt.value = item.key;
          opt.textContent = item.name;
          select.appendChild(opt);
        });
      },
      onListSelect() {
        // ÈÅ∏ÊäûÊôÇ„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºàÂÆüË°å„Éú„Çø„É≥„ÅßÊìç‰ΩúÔºâ
      },
      
      // ========== UIÊìç‰Ωú ==========
      setThisMonth() {
        const now = new Date();
        const str = `${now.getFullYear()}Âπ¥${now.getMonth()+1}Êúà`;
        document.getElementById('kakeiboNameInput').value = str;
      },
      async registerNew() {
        const name = document.getElementById('kakeiboNameInput').value.trim();
        if (!name) { alert('ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
        const list = await this.getDataList();
        const existing = list.find(item => item.name === name);
        if (existing) {
          if (!confirm(`„Äå${name}„Äç„ÅØÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô„ÄÇ‰∏äÊõ∏„Åç„Åó„Åæ„Åô„ÅãÔºü`)) return;
          this.currentKey = existing.key;
        } else {
          const key = 'k_' + Date.now();
          list.push({ key, name });
          await this.saveDataList(list);
          this.currentKey = key;
        }
        await this.saveCurrentData();
        await this.updateListSelect();
        alert(`„Äå${name}„Äç„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü`);
      },
      async executeAction() {
        const listSelect = document.getElementById('kakeiboListSelect');
        const actionSelect = document.getElementById('kakeiboActionSelect');
        const selectedKey = listSelect.value;
        const action = actionSelect.value;
        
        if (!selectedKey) { alert('‰∏ÄË¶ß„Åã„ÇâÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
        if (!action) { alert('Êìç‰Ωú„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
        
        const list = await this.getDataList();
        const item = list.find(i => i.key === selectedKey);
        if (!item) { alert('„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì'); return; }
        
        if (action === 'load') {
          // „Éá„Éº„ÇøË™≠„ÅøËæº„Åø
          const data = await this.loadDataByKey(selectedKey);
          if (data) {
            this.setCurrentData(data);
            this.currentKey = selectedKey;
            document.getElementById('kakeiboNameInput').value = item.name;
          } else {
            alert('„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
          }
        } else if (action === 'delete') {
          if (!confirm(`„Äå${item.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) return;
          await deleteFromDB('kakeibo_data_' + selectedKey);
          const newList = list.filter(i => i.key !== selectedKey);
          await this.saveDataList(newList);
          await this.updateListSelect();
          if (this.currentKey === selectedKey) {
            this.currentKey = null;
            document.getElementById('kakeiboNameInput').value = '';
          }
          alert('ÂâäÈô§„Åó„Åæ„Åó„Åü');
        }
        actionSelect.value = '';
      },
      
      // ========== Ë®àÁÆó ==========
      calculateTotal(text) {
        let total = 0;
        text.split('\n').forEach(line => {
          let numStr = '';
          for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (/[\dÔºê-Ôºô.,\s]/.test(char)) numStr += char;
            else break;
          }
          numStr = numStr.replace(/[Ôºê-Ôºô]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)).replace(/,/g, '');
          const numbers = numStr.match(/\d+(\.\d+)?/g);
          if (numbers) numbers.forEach(num => total += parseFloat(num));
        });
        return total;
      },
      formatAmount(amount) { return '¬•' + amount.toLocaleString('ja-JP'); },
      updateBalanceDisplay() {
        const carryOver = this.calculateTotal(document.getElementById('kakeiboCarryOver').value);
        const income = this.calculateTotal(document.getElementById('kakeiboIncomeArea').value);
        const expense = this.calculateTotal(document.getElementById('kakeiboExpenseArea').value);
        const balance = carryOver + income - expense;
        document.getElementById('kakeiboBalanceAmount').textContent = this.formatAmount(balance);
        document.getElementById('kakeiboBalanceSection').classList.toggle('positive', balance >= 0);
        document.getElementById('kakeiboCarryOverTotal').textContent = this.formatAmount(carryOver);
        document.getElementById('kakeiboIncomeTotal').textContent = this.formatAmount(income);
        document.getElementById('kakeiboExpenseTotal').textContent = this.formatAmount(expense);
      },
      
      // ========== „ÉÜ„É≥„Éó„É¨„Éº„Éà ==========
      async pasteTemplate() {
        const template = document.getElementById('kakeiboTemplateArea').value;
        const expenseArea = document.getElementById('kakeiboExpenseArea');
        if (template.trim()) {
          expenseArea.value = expenseArea.value.trim() ? expenseArea.value + '\n' + template : template;
          this.updateBalanceDisplay();
          await this.saveCurrentData();
          await this.addHistory('paste');
        }
      },
      copyTemplate() {
        navigator.clipboard.writeText(document.getElementById('kakeiboTemplateArea').value).then(() => alert('„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü'));
      },
      copyBalance() {
        navigator.clipboard.writeText(document.getElementById('kakeiboBalanceAmount').textContent).then(() => alert('„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü'));
      },
      
      // ========== „Ç§„É≥„Éù„Éº„Éà/„Ç®„ÇØ„Çπ„Éù„Éº„Éà ==========
      async exportData() {
        const list = await this.getDataList();
        const exportObj = { list: [], data: {}, history: this.history };
        for (const item of list) {
          exportObj.list.push(item);
          const data = await this.loadDataByKey(item.key);
          if (data) exportObj.data[item.key] = data;
        }
        if (exportObj.list.length === 0) { alert('„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'); return; }
        const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `kakeibo_export_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
      },
      async importData(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const importObj = JSON.parse(e.target.result);
            if (!importObj.list || !importObj.data) { alert('ÁÑ°Âäπ„Å™„Éï„Ç°„Ç§„É´„Åß„Åô'); return; }
            if (!confirm('ÂÖ®‰∏äÊõ∏„Åç„Åß„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åô„ÄÇÊó¢Â≠ò„Éá„Éº„Çø„ÅØÂ±•Ê≠¥„Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) {
              input.value = '';
              return;
            }
            // Êó¢Â≠ò„Éá„Éº„Çø„ÇíÂ±•Ê≠¥„Å´„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó
            const currentList = await this.getDataList();
            for (const item of currentList) {
              const data = await this.loadDataByKey(item.key);
              if (data) {
                this.history.unshift({
                  date: new Date().toISOString(),
                  type: 'import-backup',
                  name: item.name + ' („Ç§„É≥„Éù„Éº„ÉàÂâç)',
                  data: data
                });
              }
              await deleteFromDB('kakeibo_data_' + item.key);
            }
            // Êñ∞„Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà
            await this.saveDataList(importObj.list);
            for (const item of importObj.list) {
              if (importObj.data[item.key]) {
                await saveToDB('kakeibo_data_' + item.key, importObj.data[item.key]);
              }
            }
            // Â±•Ê≠¥„ÇÇ„Ç§„É≥„Éù„Éº„ÉàÔºà„ÅÇ„Çå„Å∞Ôºâ
            if (importObj.history && Array.isArray(importObj.history)) {
              this.history = [...importObj.history, ...this.history];
            }
            await this.saveHistoryToDB();
            await this.updateListSelect();
            this.currentKey = null;
            document.getElementById('kakeiboNameInput').value = '';
            this.setCurrentData({ carryOver:'', income:'', expense:'', template:'' });
            alert('„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü');
          } catch (error) { alert('Ë™≠„ÅøËæº„ÅøÂ§±Êïó: ' + error.message); }
          input.value = '';
        };
        reader.readAsText(file);
      },
      
      // ========== ÂàùÊúüÂåñ ==========
      async init() {
        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        const inputs = ['kakeiboCarryOver', 'kakeiboIncomeArea', 'kakeiboExpenseArea', 'kakeiboTemplateArea'];
        inputs.forEach(id => {
          const el = document.getElementById(id);
          el.addEventListener('input', (e) => this.onInput(e));
          el.addEventListener('paste', (e) => this.onPaste(e));
        });
        // Â±•Ê≠¥Ë™≠„ÅøËæº„Åø
        await this.loadHistory();
        // ‰∏ÄË¶ßÊõ¥Êñ∞
        await this.updateListSelect();
        // LocalStorage„Åã„ÇâÁßªË°å
        await this.migrateFromLocalStorage();
        // ÊúÄÂæå„Å´Á∑®ÈõÜ„Åó„Åü„Éá„Éº„Çø„ÇíËá™ÂãïÂëº„Å≥Âá∫„Åó
        await this.loadLastEdited();
      },
      async loadLastEdited() {
        const lastKey = await loadFromDB('kakeibo_last_edited');
        if (lastKey) {
          const list = await this.getDataList();
          const item = list.find(i => i.key === lastKey);
          if (item) {
            const data = await this.loadDataByKey(lastKey);
            if (data) {
              this.currentKey = lastKey;
              this.setCurrentData(data);
              document.getElementById('kakeiboNameInput').value = item.name;
              // ‰∏ÄË¶ß„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„ÇÇÊõ¥Êñ∞
              document.getElementById('kakeiboListSelect').value = lastKey;
            }
          }
        }
      },
      async saveLastEdited() {
        if (this.currentKey) {
          await saveToDB('kakeibo_last_edited', this.currentKey);
        }
      },
      async migrateFromLocalStorage() {
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith('kakeibo_')) {
            keysToRemove.push(key);
          }
        }
        for (const key of keysToRemove) {
          localStorage.removeItem(key);
        }
      }
    };

    // ========== „É°„É¢„É¢„Ç∏„É•„Éº„É´ÔºàÊñ∞‰ªïÊßòÔºâ==========
    const Memo = {
      currentKey: null,          // ÁèæÂú®Á∑®ÈõÜ‰∏≠„ÅÆ„Ç≠„Éº
      history: [],               // Â±•Ê≠¥Ôºà50‰ª∂Ôºâ
      saveTimeout: null,         // debounceÁî®
      historyVisible: false,     // Â±•Ê≠¥Ë°®Á§∫Áä∂ÊÖã
      currentColor: null,        // ÁèæÂú®„ÅÆÊñáÂ≠óËâ≤
      editor: null,
      saveStatus: null,
      
      // ========== Â±•Ê≠¥ÁÆ°ÁêÜ ==========
      async loadHistory() {
        this.history = await loadFromDB('memo_history') || [];
        this.updateHistoryCount();
      },
      async saveHistoryToDB() {
        while (this.history.length > 50) this.history.pop();
        await saveToDB('memo_history', this.history);
        this.updateHistoryCount();
        if (this.historyVisible) this.renderHistory();
      },
      updateHistoryCount() {
        const el = document.getElementById('memoHistoryCount');
        if (el) el.textContent = `(${this.history.length})`;
      },
      async addHistory(type) {
        const content = this.editor.innerHTML;
        if (!content.trim()) return;
        this.history.unshift({
          date: new Date().toISOString(),
          type: type, // 'input', 'paste'
          name: this.currentKey ? (await this.getNameByKey(this.currentKey)) : '(Êú™‰øùÂ≠ò)',
          content: content.slice(0, 50000) // Â±•Ê≠¥„ÅØ5‰∏áÊñáÂ≠ó„Åæ„Åß
        });
        await this.saveHistoryToDB();
      },
      async getNameByKey(key) {
        const list = await this.getDataList();
        const item = list.find(i => i.key === key);
        return item ? item.name : '(‰∏çÊòé)';
      },
      
      // ========== Â±•Ê≠¥Ë°®Á§∫ ==========
      toggleHistory() {
        this.historyVisible = !this.historyVisible;
        const slider = document.getElementById('memoHistorySlider');
        slider.style.display = this.historyVisible ? 'block' : 'none';
        if (this.historyVisible) this.renderHistory();
      },
      renderHistory() {
        const scroll = document.getElementById('memoHistoryScroll');
        if (this.history.length === 0) {
          scroll.innerHTML = '<div style="padding:20px;color:#888;text-align:center;">Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
          return;
        }
        scroll.innerHTML = this.history.map((item, idx) => {
          const d = new Date(item.date);
          const dateStr = d.toLocaleString('ja-JP', { month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit' });
          const preview = item.content.replace(/<[^>]*>/g, '').substring(0, 30);
          const typeLabel = {input:'‚úèÔ∏èÂÖ•Âäõ', paste:'üìã„Éö„Éº„Çπ„Éà'}[item.type] || item.type;
          return `<div class="memo-history-item" onclick="Memo.restoreFromHistory(${idx})">
            <div class="memo-history-date">${dateStr}</div>
            <div class="memo-history-type">${typeLabel}</div>
            <div class="memo-history-preview">${preview}${preview.length >= 30 ? '...' : ''}</div>
            <div class="memo-history-name">${item.name}</div>
          </div>`;
        }).join('');
      },
      async restoreFromHistory(idx) {
        if (!this.history[idx]) return;
        this.editor.innerHTML = this.history[idx].content;
        this.updatePlaceholder();
        await this.saveCurrentData();
      },
      
      // ========== ÂÖ•ÂäõÊ§úÁü•„ÉªËá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó ==========
      onInput(e) {
        // 10‰∏áÊñáÂ≠óÂà∂Èôê
        const text = this.editor.innerText || '';
        if (text.length > 100000) {
          // Ë∂ÖÈÅéÂàÜ„Çí„Ç´„ÉÉ„Éà
          const selection = window.getSelection();
          const range = selection.getRangeAt(0);
          this.editor.innerText = text.slice(0, 100000);
          // „Ç´„Éº„ÇΩ„É´„ÇíÊú´Â∞æ„Å´
          range.selectNodeContents(this.editor);
          range.collapse(false);
          selection.removeAllRanges();
          selection.addRange(range);
        }
        this.updatePlaceholder();
        this.saveCurrentData();
        this.showSaving();
        // debounce: 1ÁßíÂæå„Å´„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó
        clearTimeout(this.saveTimeout);
        this.saveTimeout = setTimeout(() => {
          this.addHistory('input');
          this.showSaved();
        }, 1000);
      },
      onPaste(e) {
        e.preventDefault();
        document.execCommand('insertText', false, e.clipboardData.getData('text/plain'));
        setTimeout(() => this.addHistory('paste'), 100);
      },
      showSaving() {
        this.saveStatus.textContent = '‰øùÂ≠ò‰∏≠...';
        this.saveStatus.className = 'memo-save-status saving';
      },
      showSaved() {
        this.saveStatus.textContent = '‰øùÂ≠òÊ∏à„Åø';
        this.saveStatus.className = 'memo-save-status saved';
        setTimeout(() => { this.saveStatus.textContent = ''; }, 2000);
      },
      
      // ========== „Éá„Éº„Çø‰øùÂ≠ò„ÉªË™≠Ëæº ==========
      async saveCurrentData() {
        if (!this.currentKey) return;
        await saveToDB('memo_data_' + this.currentKey, this.editor.innerHTML);
        await this.saveLastEdited();
        // FirebaseÂêåÊúü„Çí„Çπ„Ç±„Ç∏„É•„Éº„É´
        FirebaseSync.scheduleBackup();
      },
      async loadDataByKey(key) {
        return await loadFromDB('memo_data_' + key);
      },
      
      // ========== ‰∏ÄË¶ßÁÆ°ÁêÜ ==========
      async getDataList() {
        return await loadFromDB('memo_list') || [];
      },
      async saveDataList(list) {
        await saveToDB('memo_list', list);
      },
      async updateListSelect() {
        const list = await this.getDataList();
        const select = document.getElementById('memoListSelect');
        select.innerHTML = '<option value="">-- ‰øùÂ≠ò„É°„É¢‰∏ÄË¶ß --</option>';
        list.forEach(item => {
          const opt = document.createElement('option');
          opt.value = item.key;
          opt.textContent = item.name;
          select.appendChild(opt);
        });
      },
      
      // ========== UIÊìç‰Ωú ==========
      async registerNew() {
        const name = document.getElementById('memoNameInput').value.trim();
        if (!name) { alert('ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
        const list = await this.getDataList();
        const existing = list.find(item => item.name === name);
        if (existing) {
          if (!confirm(`„Äå${name}„Äç„ÅØÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô„ÄÇ‰∏äÊõ∏„Åç„Åó„Åæ„Åô„ÅãÔºü`)) return;
          this.currentKey = existing.key;
        } else {
          const key = 'm_' + Date.now();
          list.push({ key, name });
          await this.saveDataList(list);
          this.currentKey = key;
        }
        await this.saveCurrentData();
        await this.updateListSelect();
        alert(`„Äå${name}„Äç„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü`);
      },
      async executeAction() {
        const listSelect = document.getElementById('memoListSelect');
        const actionSelect = document.getElementById('memoActionSelect');
        const selectedKey = listSelect.value;
        const action = actionSelect.value;
        
        if (!selectedKey) { alert('‰∏ÄË¶ß„Åã„ÇâÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
        if (!action) { alert('Êìç‰Ωú„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
        
        const list = await this.getDataList();
        const item = list.find(i => i.key === selectedKey);
        if (!item) { alert('„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì'); return; }
        
        if (action === 'load') {
          const data = await this.loadDataByKey(selectedKey);
          this.editor.innerHTML = data || '';
          this.currentKey = selectedKey;
          document.getElementById('memoNameInput').value = item.name;
          this.updatePlaceholder();
        } else if (action === 'rename') {
          const newName = prompt('Êñ∞„Åó„ÅÑÂêçÂâç:', item.name);
          if (newName && newName.trim()) {
            item.name = newName.trim();
            await this.saveDataList(list);
            await this.updateListSelect();
            if (this.currentKey === selectedKey) {
              document.getElementById('memoNameInput').value = newName.trim();
            }
          }
        } else if (action === 'delete') {
          if (!confirm(`„Äå${item.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) return;
          await deleteFromDB('memo_data_' + selectedKey);
          const newList = list.filter(i => i.key !== selectedKey);
          await this.saveDataList(newList);
          await this.updateListSelect();
          if (this.currentKey === selectedKey) {
            this.currentKey = null;
            this.editor.innerHTML = '';
            document.getElementById('memoNameInput').value = '';
            this.updatePlaceholder();
          }
          alert('ÂâäÈô§„Åó„Åæ„Åó„Åü');
        }
        actionSelect.value = '';
      },
      setColor(color) {
        this.currentColor = color;
        document.querySelectorAll('.memo-color-btn').forEach(btn => btn.classList.remove('active'));
        if (color === '#dc2626') document.querySelector('.memo-color-red').classList.add('active');
        else if (color === '#2563eb') document.querySelector('.memo-color-blue').classList.add('active');
        else if (color === '#16a34a') document.querySelector('.memo-color-green').classList.add('active');
        else document.querySelector('.memo-color-black').classList.add('active');
        // Ëâ≤„ÇíÂç≥Â∫ß„Å´Ë®≠ÂÆö„Åó„Å¶„Ç®„Éá„Ç£„Çø„Å´„Éï„Ç©„Éº„Ç´„Çπ
        this.editor.focus();
        document.execCommand('styleWithCSS', false, true);
        if (color) {
          document.execCommand('foreColor', false, color);
        } else {
          document.execCommand('foreColor', false, '#222222');
        }
      },
      async clearMemo() {
        if (!this.editor.textContent.trim()) return;
        if (!confirm('„É°„É¢„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü')) return;
        await this.addHistory('input');
        this.editor.innerHTML = '';
        await this.saveCurrentData();
        this.updatePlaceholder();
      },
      updatePlaceholder() {
        const isEmpty = !this.editor.textContent.trim();
        this.editor.setAttribute('data-empty', isEmpty);
      },
      
      // ========== „Ç§„É≥„Éù„Éº„Éà/„Ç®„ÇØ„Çπ„Éù„Éº„Éà ==========
      async exportData() {
        const list = await this.getDataList();
        const exportObj = { list: [], data: {}, history: this.history };
        for (const item of list) {
          exportObj.list.push(item);
          const data = await this.loadDataByKey(item.key);
          if (data) exportObj.data[item.key] = data;
        }
        if (exportObj.list.length === 0) { alert('„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'); return; }
        const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `memo_export_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
      },
      async importData(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const importObj = JSON.parse(e.target.result);
            if (!importObj.list || !importObj.data) { alert('ÁÑ°Âäπ„Å™„Éï„Ç°„Ç§„É´„Åß„Åô'); return; }
            if (!confirm('ÂÖ®‰∏äÊõ∏„Åç„Åß„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åô„ÄÇÊó¢Â≠ò„Éá„Éº„Çø„ÅØÂ±•Ê≠¥„Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) {
              input.value = '';
              return;
            }
            // Êó¢Â≠ò„Éá„Éº„Çø„ÇíÂ±•Ê≠¥„Å´„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó
            const currentList = await this.getDataList();
            for (const item of currentList) {
              const data = await this.loadDataByKey(item.key);
              if (data) {
                this.history.unshift({
                  date: new Date().toISOString(),
                  type: 'import-backup',
                  name: item.name + ' („Ç§„É≥„Éù„Éº„ÉàÂâç)',
                  content: data
                });
              }
              await deleteFromDB('memo_data_' + item.key);
            }
            // Êñ∞„Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà
            await this.saveDataList(importObj.list);
            for (const item of importObj.list) {
              if (importObj.data[item.key]) {
                await saveToDB('memo_data_' + item.key, importObj.data[item.key]);
              }
            }
            // Â±•Ê≠¥„ÇÇ„Ç§„É≥„Éù„Éº„ÉàÔºà„ÅÇ„Çå„Å∞Ôºâ
            if (importObj.history && Array.isArray(importObj.history)) {
              this.history = [...importObj.history, ...this.history];
            }
            await this.saveHistoryToDB();
            await this.updateListSelect();
            this.currentKey = null;
            this.editor.innerHTML = '';
            document.getElementById('memoNameInput').value = '';
            this.updatePlaceholder();
            alert('„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü');
          } catch (error) { alert('Ë™≠„ÅøËæº„ÅøÂ§±Êïó: ' + error.message); }
          input.value = '';
        };
        reader.readAsText(file);
      },
      
      // ========== ÂàùÊúüÂåñ ==========
      async init() {
        this.editor = document.getElementById('memoEditor');
        this.saveStatus = document.getElementById('memoSaveStatus');
        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        this.editor.addEventListener('input', (e) => this.onInput(e));
        this.editor.addEventListener('paste', (e) => this.onPaste(e));
        // Ëâ≤Â§âÊõ¥ÔºöÂÖ•ÂäõÂâç„Å´Ëâ≤„ÇíË®≠ÂÆö
        this.editor.addEventListener('keydown', (e) => {
          if (this.currentColor && !e.ctrlKey && !e.metaKey && e.key.length === 1) {
            document.execCommand('styleWithCSS', false, true);
            document.execCommand('foreColor', false, this.currentColor);
          }
        });
        // Â±•Ê≠¥Ë™≠„ÅøËæº„Åø
        await this.loadHistory();
        // ‰∏ÄË¶ßÊõ¥Êñ∞
        await this.updateListSelect();
        // LocalStorage„Åã„ÇâÁßªË°å
        await this.migrateFromLocalStorage();
        // ÊúÄÂæå„Å´Á∑®ÈõÜ„Åó„Åü„Éá„Éº„Çø„ÇíËá™ÂãïÂëº„Å≥Âá∫„Åó
        await this.loadLastEdited();
        this.updatePlaceholder();
      },
      async loadLastEdited() {
        const lastKey = await loadFromDB('memo_last_edited');
        if (lastKey) {
          const list = await this.getDataList();
          const item = list.find(i => i.key === lastKey);
          if (item) {
            const data = await this.loadDataByKey(lastKey);
            if (data !== null) {
              this.currentKey = lastKey;
              this.editor.innerHTML = data;
              document.getElementById('memoNameInput').value = item.name;
              document.getElementById('memoListSelect').value = lastKey;
            }
          }
        }
      },
      async saveLastEdited() {
        if (this.currentKey) {
          await saveToDB('memo_last_edited', this.currentKey);
        }
      },
      async migrateFromLocalStorage() {
        // ÊóßmemoListÁßªË°å
        const oldList = localStorage.getItem('memoList');
        if (oldList) {
          const existingList = await loadFromDB('memo_list');
          if (!existingList || existingList.length === 0) {
            try {
              const list = JSON.parse(oldList);
              const newList = [];
              for (const memo of list) {
                const newKey = 'm_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                newList.push({ key: newKey, name: memo.name });
                const content = localStorage.getItem(memo.id);
                if (content) await saveToDB('memo_data_' + newKey, content);
                localStorage.removeItem(memo.id);
                localStorage.removeItem(memo.id + '_history');
              }
              await this.saveDataList(newList);
            } catch (e) { /* ignore */ }
          }
          localStorage.removeItem('memoList');
          localStorage.removeItem('currentMemoId');
        }
      }
    };

    // ========== „Éê„Éº„Ç∏„Éß„É≥ÁÆ°ÁêÜ ==========
    async function checkAndMigrateVersion() {
      try {
        const savedVersion = await loadFromDB('app_version');
        
        if (!savedVersion) {
          // ÂàùÂõûËµ∑Âãï„Åæ„Åü„ÅØÊó¢Â≠ò„É¶„Éº„Ç∂„ÉºÔºà„Éê„Éº„Ç∏„Éß„É≥ÁÆ°ÁêÜÂ∞éÂÖ•ÂâçÔºâ
          addDebugLog(`ÂàùÂõû„Éê„Éº„Ç∏„Éß„É≥Ë®òÈå≤: ${APP_VERSION}`);
          await saveToDB('app_version', APP_VERSION);
          return;
        }
        
        if (savedVersion === APP_VERSION) {
          // „Éê„Éº„Ç∏„Éß„É≥Âêå„Åò„ÄÅ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
          return;
        }
        
        // „Éê„Éº„Ç∏„Éß„É≥„ÅåÈÅï„ÅÜ ‚Üí „Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥ÂÆüË°å
        addDebugLog(`„Éê„Éº„Ç∏„Éß„É≥Êõ¥Êñ∞Ê§úÂá∫: ${savedVersion} ‚Üí ${APP_VERSION}`);
        await migrateData(savedVersion, APP_VERSION);
        await saveToDB('app_version', APP_VERSION);
        
      } catch (e) {
        addDebugLog('„Éê„Éº„Ç∏„Éß„É≥„ÉÅ„Çß„ÉÉ„ÇØ„Ç®„É©„Éº: ' + e.message);
      }
    }
    
    async function migrateData(fromVersion, toVersion) {
      // „Éê„Éº„Ç∏„Éß„É≥Áï™Âè∑„ÇíÊï∞ÂÄ§ÈÖçÂàó„Å´Â§âÊèõ (‰æã: "1.0.0" ‚Üí [1, 0, 0])
      const parseVersion = (v) => v.split('.').map(Number);
      const from = parseVersion(fromVersion);
      const to = parseVersion(toVersion);
      
      addDebugLog(`„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥ÈñãÂßã: ${fromVersion} ‚Üí ${toVersion}`);
      
      // ÂêÑ„Éê„Éº„Ç∏„Éß„É≥„ÅÆ„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥Âá¶ÁêÜ
      // Â∞ÜÊù•„ÅÆ„Ç¢„ÉÉ„Éó„Éá„Éº„ÉàÊôÇ„Å´„Åì„Åì„Å´ËøΩÂä†„Åó„Å¶„ÅÑ„Åè
      
      /*
      // ‰æã: 1.0.0 ‚Üí 1.1.0 „ÅÆ„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥
      if (compareVersion(from, [1, 0, 0]) <= 0 && compareVersion(to, [1, 1, 0]) >= 0) {
        // 1.1.0 „ÅßËøΩÂä†„Åï„Çå„ÅüÊñ∞„Åó„ÅÑ„Éá„Éº„ÇøÊßãÈÄ†„Å∏„ÅÆÂ§âÊèõ
        addDebugLog('1.1.0 „Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥ÂÆüË°å');
        // ... ÂÖ∑‰ΩìÁöÑ„Å™Âá¶ÁêÜ ...
      }
      
      // ‰æã: 1.1.0 ‚Üí 1.2.0 „ÅÆ„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥
      if (compareVersion(from, [1, 1, 0]) <= 0 && compareVersion(to, [1, 2, 0]) >= 0) {
        addDebugLog('1.2.0 „Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥ÂÆüË°å');
        // ... ÂÖ∑‰ΩìÁöÑ„Å™Âá¶ÁêÜ ...
      }
      */
      
      addDebugLog('„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥ÂÆå‰∫Ü');
    }
    
    // „Éê„Éº„Ç∏„Éß„É≥ÊØîËºÉ (a < b: -1, a == b: 0, a > b: 1)
    function compareVersion(a, b) {
      for (let i = 0; i < 3; i++) {
        if (a[i] < b[i]) return -1;
        if (a[i] > b[i]) return 1;
      }
      return 0;
    }

    // ========== FirebaseÂêåÊúü„É¢„Ç∏„É•„Éº„É´ ==========
    const FirebaseSync = {
      user: null,
      firestore: null,
      syncTimeout: null,
      lastSyncTime: null,
      syncing: false,  // ÂêåÊúü‰∏≠„Éï„É©„Ç∞
      restoring: false, // Âæ©ÂÖÉ‰∏≠„Éï„É©„Ç∞
      
      // „É™„Éà„É©„Ç§‰ªò„ÅçÂÆüË°åÔºàÊåáÊï∞„Éê„ÉÉ„ÇØ„Ç™„Éï„ÄÅÊúÄÂ§ß3ÂõûÔºâ
      async withRetry(fn, maxRetries = 3) {
        for (let i = 0; i < maxRetries; i++) {
          try {
            return await fn();
          } catch (e) {
            if (i === maxRetries - 1) throw e;
            // 1Áßí ‚Üí 2Áßí ‚Üí 4Áßí „Å®ÂæÖÊ©ü
            await new Promise(r => setTimeout(r, 1000 * Math.pow(2, i)));
            addDebugLog(`„É™„Éà„É©„Ç§ ${i + 1}/${maxRetries - 1}...`);
          }
        }
      },
      
      // FirebaseË®≠ÂÆö
      config: {
        apiKey: "AIzaSyDBG_r1boPvLrl-wVSIIv-CgCUk0EJrqSw",
        authDomain: "pmake-e037a.firebaseapp.com",
        projectId: "pmake-e037a",
        storageBucket: "pmake-e037a.firebasestorage.app",
        messagingSenderId: "716873851866",
        appId: "1:716873851866:web:4a892b109a83de3aec96e3"
      },
      
      // ÂàùÊúüÂåñ
      async init() {
        try {
          // FirebaseÂàùÊúüÂåñ
          if (!firebase.apps.length) {
            firebase.initializeApp(this.config);
          }
          this.firestore = firebase.firestore();
          
          // Ë™çË®ºÁä∂ÊÖã„ÅÆÁõ£Ë¶ñ
          firebase.auth().onAuthStateChanged((user) => {
            this.user = user;
            this.updateAuthUI();
            if (user) {
              // „É≠„Ç∞„Ç§„É≥ÊôÇÔºö„ÇØ„É©„Ç¶„Éâ„Åã„Çâ„Éá„Éº„ÇøÂæ©ÂÖÉ„ÇíË©¶„Åø„Çã
              this.restoreFromCloud();
            }
          });
          
          addDebugLog('FirebaseÂàùÊúüÂåñÊàêÂäü');
        } catch (e) {
          addDebugLog('FirebaseÂàùÊúüÂåñÂ§±Êïó: ' + e.message);
        }
      },
      
      // Ë™çË®ºUIÊõ¥Êñ∞Ôºà„É°„Éã„É•„ÉºÂÜÖÔºâ
      updateAuthUI() {
        const section = document.getElementById('menuAuthSection');
        const statusText = document.getElementById('menuAuthStatusText');
        const emailEl = document.getElementById('menuAuthEmail');
        const button = document.getElementById('menuAuthButton');
        const proBadge = document.getElementById('menuProBadge');
        const bottomNotice = document.getElementById('bottomNotice');
        const bottomNoticeText = document.getElementById('bottomNoticeText');
        
        // PROÁä∂ÊÖãË°®Á§∫
        if (proBadge) {
          proBadge.style.display = isPro ? 'block' : 'none';
        }
        
        if (this.user) {
          section.classList.remove('not-logged-in');
          section.classList.add('logged-in');
          statusText.textContent = '‚úì „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÊúâÂäπ';
          emailEl.textContent = this.user.email || this.user.displayName || '';
          emailEl.style.display = 'block';
          button.innerHTML = '„É≠„Ç∞„Ç¢„Ç¶„Éà';
          button.classList.remove('google');
          button.classList.add('logout');
          // ‰∏ãÈÉ®ÈÄöÁü•„ÇÇÊõ¥Êñ∞
          bottomNotice.classList.remove('warning');
          bottomNotice.classList.add('success');
          bottomNoticeText.textContent = isPro ? 'üéâ ÊîØÊè¥Ê∏à„Åø ‚úì „ÇØ„É©„Ç¶„ÉâÂêåÊúü‰∏≠' : '‚úì „ÇØ„É©„Ç¶„Éâ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÊúâÂäπ';
        } else {
          section.classList.add('not-logged-in');
          section.classList.remove('logged-in');
          statusText.textContent = '‚ö†Ô∏è „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÊú™Ë®≠ÂÆö';
          emailEl.style.display = 'none';
          button.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg> Google„Åß„É≠„Ç∞„Ç§„É≥`;
          button.classList.add('google');
          button.classList.remove('logout');
          // ‰∏ãÈÉ®ÈÄöÁü•„ÇÇÊõ¥Êñ∞
          bottomNotice.classList.add('warning');
          bottomNotice.classList.remove('success');
          bottomNoticeText.textContent = isPro ? 'üéâ ÊîØÊè¥Ê∏à„Åø ‚ò∞„Åß„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóË®≠ÂÆö„Çí' : '‚ö†Ô∏è ‚ò∞„É°„Éã„É•„Éº„Åã„Çâ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóË®≠ÂÆö„Çí„Åä„Åô„Åô„ÇÅ„Åó„Åæ„Åô';
        }
      },
      
      // ÂêåÊúü„Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫
      setSyncStatus(msg, isError = false) {
        const el = document.getElementById('menuSyncStatus');
        const bottomNoticeText = document.getElementById('bottomNoticeText');
        if (el) {
          el.textContent = msg;
          el.style.color = isError ? '#c00' : '#888';
        }
        // ‰∏ãÈÉ®„Å´„ÇÇË°®Á§∫
        if (msg && bottomNoticeText) {
          bottomNoticeText.textContent = msg;
          const notice = document.getElementById('bottomNotice');
          if (isError) {
            notice.classList.add('error');
            notice.classList.remove('success', 'warning');
          }
        }
        if (!isError && msg) {
          setTimeout(() => { 
            if (el) el.textContent = ''; 
            this.updateAuthUI(); // ÂÖÉ„ÅÆÁä∂ÊÖã„Å´Êàª„Åô
          }, 3000);
        }
      },
      
      // „É≠„Ç∞„Ç§„É≥/„É≠„Ç∞„Ç¢„Ç¶„ÉàÂàá„ÇäÊõø„Åà
      async toggleAuth() {
        if (this.user) {
          if (confirm('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü\nÔºà„É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÅØÊÆã„Çä„Åæ„ÅôÔºâ')) {
            await firebase.auth().signOut();
            this.setSyncStatus('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü');
          }
        } else {
          try {
            const provider = new firebase.auth.GoogleAuthProvider();
            await firebase.auth().signInWithPopup(provider);
            this.setSyncStatus('„É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åó„Åü');
          } catch (e) {
            if (e.code !== 'auth/popup-closed-by-user') {
              this.setSyncStatus('„É≠„Ç∞„Ç§„É≥Â§±Êïó', true);
              addDebugLog('„É≠„Ç∞„Ç§„É≥Â§±Êïó: ' + e.message);
            }
          }
        }
      },
      
      // „ÇØ„É©„Ç¶„Éâ„Å´„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÔºàdebounce‰ªò„ÅçÔºâ
      scheduleBackup() {
        if (!this.user) return;
        clearTimeout(this.syncTimeout);
        this.syncTimeout = setTimeout(() => this.backupToCloud(), 5000);
      },
      
      // „ÇØ„É©„Ç¶„Éâ„Å´„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÂÆüË°å
      async backupToCloud() {
        if (!this.user || !this.firestore) return;
        if (this.syncing) return; // ‰∫åÈáçÂÆüË°åÈò≤Ê≠¢
        
        this.syncing = true;
        try {
          this.setSyncStatus('„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰∏≠...');
          
          // ÂêÑ„Éá„Éº„Çø„ÇíÂèéÈõÜÔºà„É≠„Éº„Ç´„É´„Åã„ÇâË™≠„ÇÄ„Å†„Åë„Å™„ÅÆ„Åß„É™„Éà„É©„Ç§‰∏çË¶ÅÔºâ
          const shiftData = {
            memoData: memoData,
            shiftPatterns: shiftPatterns,
            designSettings: designSettings,
            statusColorSettings: statusColorSettings,
            dayStatusColors: dayStatusColors
          };
          
          const kakeiboList = await Kakeibo.getDataList();
          const kakeiboData = {};
          for (const item of kakeiboList) {
            const data = await Kakeibo.loadDataByKey(item.key);
            if (data) kakeiboData[item.key] = data;
          }
          
          const memoList = await Memo.getDataList();
          const memoDataCloud = {};
          for (const item of memoList) {
            const data = await Memo.loadDataByKey(item.key);
            if (data) memoDataCloud[item.key] = data;
          }
          
          // Firestore„Å´‰øùÂ≠òÔºà„É™„Éà„É©„Ç§‰ªò„ÅçÔºâ
          await this.withRetry(async () => {
            const docRef = this.firestore.collection('users').doc(this.user.uid);
            await docRef.set({
              shift: shiftData,
              kakeibo: { list: kakeiboList, data: kakeiboData },
              memo: { list: memoList, data: memoDataCloud },
              isPro: isPro,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
          });
          
          this.lastSyncTime = new Date();
          this.setSyncStatus('‚úì „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü');
          addDebugLog('Firebase„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü');
        } catch (e) {
          this.setSyncStatus('„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÂ§±Êïó', true);
          addDebugLog('Firebase„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÂ§±Êïó: ' + e.message);
        } finally {
          this.syncing = false;
        }
      },
      
      // PROÁä∂ÊÖã„Çí„ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò
      async setProStatus(status) {
        if (!this.user || !this.firestore) return;
        
        try {
          const docRef = this.firestore.collection('users').doc(this.user.uid);
          await docRef.set({
            isPro: status,
            proUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
          addDebugLog('PROÁä∂ÊÖã„ÇíFirestore„Å´‰øùÂ≠ò: ' + (status ? 'PRO' : 'ÈÄöÂ∏∏'));
        } catch (e) {
          addDebugLog('PROÁä∂ÊÖã„ÅÆ‰øùÂ≠òÂ§±Êïó: ' + e.message);
          throw e;
        }
      },
      
      // „ÇØ„É©„Ç¶„Éâ„Åã„ÇâÂæ©ÂÖÉ
      async restoreFromCloud() {
        if (!this.user || !this.firestore) return;
        if (this.restoring) return; // ‰∫åÈáçÂÆüË°åÈò≤Ê≠¢
        
        this.restoring = true;
        try {
          this.setSyncStatus('„Éá„Éº„ÇøÁ¢∫Ë™ç‰∏≠...');
          
          // „ÇØ„É©„Ç¶„Éâ„Åã„Çâ„Éá„Éº„ÇøÂèñÂæóÔºà„É™„Éà„É©„Ç§‰ªò„ÅçÔºâ
          const cloudData = await this.withRetry(async () => {
            const docRef = this.firestore.collection('users').doc(this.user.uid);
            const doc = await docRef.get();
            return doc.exists ? doc.data() : null;
          });
          
          if (!cloudData) {
            this.setSyncStatus('Êñ∞Ë¶è„É¶„Éº„Ç∂„ÉºÔºàÂàùÂõû„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÂæÖÊ©üÔºâ');
            // ÂàùÂõû„ÅØÁèæÂú®„ÅÆ„É≠„Éº„Ç´„É´„Éá„Éº„Çø„Çí„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó
            setTimeout(() => this.backupToCloud(), 2000);
            return;
          }
          
          const cloudTime = cloudData.updatedAt?.toDate?.() || new Date(0);
          
          // „ÇØ„É©„Ç¶„Éâ„ÅÆPROÁä∂ÊÖã„ÇíÁ¢∫Ë™çÔºàÂ∏∏„Å´ÂèçÊò†Ôºâ
          if (cloudData.isPro !== undefined) {
            isPro = cloudData.isPro;
            updateProUI();
            addDebugLog('PROÁä∂ÊÖã„Çí„ÇØ„É©„Ç¶„Éâ„Åã„ÇâÂæ©ÂÖÉ: ' + (isPro ? 'PRO' : 'ÈÄöÂ∏∏'));
          }
          
          // „É≠„Éº„Ç´„É´„ÅÆÊúÄÁµÇÊõ¥Êñ∞ÊôÇÂàª„ÇíÂèñÂæó
          const localTime = await loadFromDB('lastSyncTime');
          const localDate = localTime ? new Date(localTime) : new Date(0);
          
          // „ÇØ„É©„Ç¶„Éâ„ÅåÊñ∞„Åó„ÅÑÂ†¥Âêà„ÅÆ„ÅøÂæ©ÂÖÉ„ÇíÊèêÊ°à
          if (cloudTime > localDate) {
            const confirmRestore = confirm(
              `„ÇØ„É©„Ç¶„Éâ„Å´Êñ∞„Åó„ÅÑ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ\n` +
              `„ÇØ„É©„Ç¶„Éâ: ${cloudTime.toLocaleString()}\n` +
              `„É≠„Éº„Ç´„É´: ${localDate.getTime() ? localDate.toLocaleString() : '‰∏çÊòé'}\n\n` +
              `„ÇØ„É©„Ç¶„Éâ„Åã„ÇâÂæ©ÂÖÉ„Åó„Åæ„Åô„ÅãÔºü\nÔºà„ÅÑ„ÅÑ„Åà„ÇíÈÅ∏„Å∂„Å®„É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇíÁ∂≠ÊåÅÔºâ`
            );
            
            if (confirmRestore) {
              await this.applyCloudData(cloudData);
              this.setSyncStatus('‚úì Âæ©ÂÖÉÂÆå‰∫Ü');
            } else {
              this.setSyncStatus('„É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇíÁ∂≠ÊåÅ');
              // „É≠„Éº„Ç´„É´„ÇíÂÑ™ÂÖà„Åó„ÅüÂ†¥Âêà„ÄÅÂæå„Åß„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó
              setTimeout(() => this.backupToCloud(), 3000);
            }
          } else {
            this.setSyncStatus('‚úì ÂêåÊúüÊ∏à„Åø');
          }
          
          // ÂêåÊúüÊôÇÂàª„Çí‰øùÂ≠ò
          await saveToDB('lastSyncTime', new Date().toISOString());
          
        } catch (e) {
          this.setSyncStatus('Âæ©ÂÖÉÁ¢∫Ë™çÂ§±Êïó', true);
          addDebugLog('FirebaseÂæ©ÂÖÉÁ¢∫Ë™çÂ§±Êïó: ' + e.message);
        } finally {
          this.restoring = false;
        }
      },
      
      // „ÇØ„É©„Ç¶„Éâ„Éá„Éº„Çø„ÇíÈÅ©Áî®Ôºà„Éà„É©„É≥„Ç∂„ÇØ„Ç∑„Éß„É≥ÁöÑ„Å´Âá¶ÁêÜÔºâ
      async applyCloudData(cloudData) {
        // 1. „Åæ„ÅöÂÖ®„Éá„Éº„Çø„Çí„É°„É¢„É™„Å´Ê∫ñÂÇôÔºà„Åì„ÅÆÊÆµÈöé„Åß„ÅØDB„Å´Êõ∏„ÅçËæº„Åæ„Å™„ÅÑÔºâ
        const writes = [];
        
        // „Ç∑„Éï„Éà„Éá„Éº„ÇøÊ∫ñÂÇô
        if (cloudData.shift) {
          if (cloudData.shift.memoData) {
            writes.push({ key: 'memoData', value: cloudData.shift.memoData, apply: () => { memoData = cloudData.shift.memoData; } });
          }
          if (cloudData.shift.shiftPatterns) {
            writes.push({ key: 'shiftPatterns', value: cloudData.shift.shiftPatterns, apply: () => { shiftPatterns = cloudData.shift.shiftPatterns; } });
          }
          if (cloudData.shift.designSettings) {
            writes.push({ key: 'designSettings', value: cloudData.shift.designSettings, apply: () => { designSettings = cloudData.shift.designSettings; } });
          }
          if (cloudData.shift.statusColorSettings) {
            writes.push({ key: 'statusColorSettings', value: cloudData.shift.statusColorSettings, apply: () => { statusColorSettings = cloudData.shift.statusColorSettings; } });
          }
          if (cloudData.shift.dayStatusColors) {
            writes.push({ key: 'dayStatusColors', value: cloudData.shift.dayStatusColors, apply: () => { dayStatusColors = cloudData.shift.dayStatusColors; } });
          }
        }
        
        // ÂÆ∂Ë®àÁ∞ø„Éá„Éº„ÇøÊ∫ñÂÇô
        if (cloudData.kakeibo && cloudData.kakeibo.list) {
          writes.push({ key: 'kakeibo_list', value: cloudData.kakeibo.list });
          for (const item of cloudData.kakeibo.list) {
            if (cloudData.kakeibo.data[item.key]) {
              writes.push({ key: 'kakeibo_data_' + item.key, value: cloudData.kakeibo.data[item.key] });
            }
          }
        }
        
        // „É°„É¢„Éá„Éº„ÇøÊ∫ñÂÇô
        if (cloudData.memo && cloudData.memo.list) {
          writes.push({ key: 'memo_list', value: cloudData.memo.list });
          for (const item of cloudData.memo.list) {
            if (cloudData.memo.data[item.key]) {
              writes.push({ key: 'memo_data_' + item.key, value: cloudData.memo.data[item.key] });
            }
          }
        }
        
        // 2. ÂÖ®„Éá„Éº„Çø„Çí‰∏ÄÊ∞ó„Å´DB„Å´Êõ∏„ÅçËæº„ÇÄ
        try {
          for (const write of writes) {
            await saveToDB(write.key, write.value);
            if (write.apply) write.apply(); // „É°„É¢„É™‰∏ä„ÅÆÂ§âÊï∞„ÇÇÊõ¥Êñ∞
          }
          
          // 3. UIÊõ¥Êñ∞ÔºàÂÖ®Êõ∏„ÅçËæº„ÅøÊàêÂäüÂæå„ÅÆ„ÅøÔºâ
          if (cloudData.shift) {
            applyTheme();
            renderSchedule();
          }
          if (cloudData.kakeibo) {
            await Kakeibo.updateListSelect();
            await Kakeibo.loadLastEdited();
          }
          if (cloudData.memo) {
            await Memo.updateListSelect();
            await Memo.loadLastEdited();
          }
          
          addDebugLog('„ÇØ„É©„Ç¶„Éâ„Éá„Éº„ÇøÂæ©ÂÖÉÂÆå‰∫Ü');
        } catch (e) {
          addDebugLog('Âæ©ÂÖÉ‰∏≠„Å´„Ç®„É©„Éº: ' + e.message);
          throw e; // „Ç®„É©„Éº„Çí‰∏ä‰Ωç„Å´‰ºùÊí≠
        }
      }
    };

    // ========== Áµ±ÂêàÂàùÊúüÂåñ ==========
    document.addEventListener('DOMContentLoaded', async () => {
      // DB„ÅåÂàùÊúüÂåñ„Åï„Çå„Çã„Åæ„ÅßÂæÖ„Å§
      await new Promise(resolve => {
        const checkDB = () => {
          if (db) resolve();
          else setTimeout(checkDB, 50);
        };
        checkDB();
      });
      
      // „Éê„Éº„Ç∏„Éß„É≥„ÉÅ„Çß„ÉÉ„ÇØ & „Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥
      await checkAndMigrateVersion();
      
      await Kakeibo.init();
      await Memo.init();
      // FirebaseÂàùÊúüÂåñ
      await FirebaseSync.init();
      // ÂâçÂõû„ÅÆ„Çø„Éñ„ÇíÂæ©ÂÖÉÔºà„Éá„Éï„Ç©„É´„Éà„ÅØshiftÔºâ
      const savedTab = localStorage.getItem('currentMainTab') || 'shift';
      switchMainTab(savedTab);
      
      // „É°„Éã„É•„Éº„Å´„Éê„Éº„Ç∏„Éß„É≥Ë°®Á§∫
      const versionDisplay = document.getElementById('menuVersionDisplay');
      if (versionDisplay) versionDisplay.textContent = `v${APP_VERSION}`;
    });

    // ========== „Éö„Éº„Ç∏Èõ¢ËÑ±ÊôÇ„Å´Âç≥‰øùÂ≠ò ==========
    document.addEventListener('visibilitychange', async () => {
      if (document.visibilityState === 'hidden') {
        // ‰øùÁïô‰∏≠„ÅÆ„Çø„Ç§„Éû„Éº„Çí„Ç≠„É£„É≥„Çª„É´„Åó„Å¶Âç≥‰øùÂ≠ò
        clearTimeout(ShiftHistory.saveTimeout);
        clearTimeout(Kakeibo.saveTimeout);
        clearTimeout(Memo.saveTimeout);
        clearTimeout(FirebaseSync.syncTimeout);
        // „Ç∑„Éï„Éà„Éá„Éº„Çø‰øùÂ≠ò
        await saveData(true);
        // ÂÆ∂Ë®àÁ∞ø„Éª„É°„É¢„ÅØÊó¢„Å´saveCurrentData„Åß‰øùÂ≠òÊ∏à„Åø„Å†„ÅåÂøµ„ÅÆ„Åü„ÇÅ
        if (Kakeibo.currentKey) await Kakeibo.saveCurrentData();
        if (Memo.currentKey) await Memo.saveCurrentData();
        // Firebase„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÔºà„É≠„Ç∞„Ç§„É≥‰∏≠„Å™„ÇâÔºâ
        if (FirebaseSync.user) {
          await FirebaseSync.backupToCloud();
        }
      }
    });
  </script>

  <!-- ========== ‰∏ãÈÉ®ÈÄöÁü•„ÉªÂ∫ÉÂëä„Éê„Éº ========== -->
  <div class="bottom-bar" id="bottomBar">
    <div class="bottom-bar-notice" id="bottomNotice">
      <span id="bottomNoticeText">„Çà„ÅÜ„Åì„ÅùÔºÅ ‚ò∞„É°„Éã„É•„Éº„Åã„Çâ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóË®≠ÂÆö„Åå„Åß„Åç„Åæ„Åô</span>
    </div>
    <div class="bottom-bar-ad" id="bottomAd">
      <!-- Â∫ÉÂëä„Çπ„Éö„Éº„Çπ -->
    </div>
  </div>

  <!-- ========== ÂÖ±ÈÄö„É¢„Éº„ÉÄ„É´ÔºàÂÖ®„Çø„ÉñÂÖ±ÈÄöÔºâ ========== -->
  
  <!-- „Éá„Ç∂„Ç§„É≥Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
  <div class="modal-overlay" id="designModal">
    <div class="modal">
      <div class="modal-header">„Éá„Ç∂„Ç§„É≥Â§âÊõ¥</div>
      <div class="modal-body">
        <div class="design-section">
          <label>„ÉÜ„Éº„Éû</label>
          <div class="theme-options" id="themeOptions"></div>
        </div>

        <div class="design-section">
          <label>ÊñáÂ≠ó„Çµ„Ç§„Ç∫</label>
          <div class="size-options">
            <div class="size-option" data-size="small" onclick="selectSize(this)">Â∞è</div>
            <div class="size-option" data-size="medium" onclick="selectSize(this)">‰∏≠</div>
            <div class="size-option" data-size="large" onclick="selectSize(this)">Â§ß</div>
          </div>
        </div>

        <div class="design-section">
          <label>Ë°å„ÅÆÈ´ò„Åï</label>
          <div class="size-options">
            <div class="size-option" data-height="compact" onclick="selectHeight(this)">Áã≠„ÅÑ</div>
            <div class="size-option" data-height="normal" onclick="selectHeight(this)">ÊôÆÈÄö</div>
            <div class="size-option" data-height="relaxed" onclick="selectHeight(this)">Â∫É„ÅÑ</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn cancel" onclick="closeDesignModal()">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="modal-btn primary" onclick="saveDesign()">‰øùÂ≠ò</button>
      </div>
    </div>
  </div>

  <!-- „ÅäÂïè„ÅÑÂêà„Çè„Åõ„É¢„Éº„ÉÄ„É´ -->
  <div class="modal-overlay" id="contactModal">
    <div class="modal">
      <div class="modal-header">„ÅäÂïè„ÅÑÂêà„Çè„Åõ</div>
      <div class="modal-body">
        <div class="contact-options">
          <a class="contact-btn" id="contactEmail" href="#">
            <span class="icon">‚úâÔ∏è</span>
            <span>„É°„Éº„É´„ÅßÈÄ£Áµ°</span>
          </a>
          <a class="contact-btn" id="contactForm" href="#" target="_blank">
            <span class="icon">üìù</span>
            <span>„Éï„Ç©„Éº„É†„ÅßÈÄ£Áµ°</span>
          </a>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn cancel" onclick="closeContactModal()">Èñâ„Åò„Çã</button>
      </div>
    </div>
  </div>

  <!-- PROÁâà„É¢„Éº„ÉÄ„É´ÔºàÊú™Ë™çË®ºÊôÇÔºâ -->
  <div class="modal-overlay" id="proModal">
    <div class="modal">
      <div class="modal-header">‚ú® ÊîØÊè¥„ÅÆ„ÅäÈ°ò„ÅÑ</div>
      <div class="modal-body">
        <p style="font-size: 14px; color: #333; line-height: 1.8; text-align: center; margin-bottom: 20px;">
          Á∂ôÁ∂ö„Åó„ÅüÈñãÁô∫„ÅÆ„Åü„ÇÅ<br>Ê∞ó„Å´ÂÖ•„Çä„Åæ„Åó„Åü„ÇâPROÁâà„ÅÆ<br>„ÅîË≥ºÂÖ•„Çí„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ
        </p>
        <p style="font-size: 13px; color: #888; text-align: center; margin-bottom: 20px;">
          ‚ÄªÊ©üËÉΩÁöÑ„Å™Â§âÊõ¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì
        </p>
        <div style="text-align: center;">
          <a href="https://play.google.com/store/apps/details?id=com.kusenokimera.hkkey" target="_blank" class="pro-purchase-btn">
            Ë≤∑„ÅÑÂàá„Çä 300ÂÜÜ
          </a>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn cancel" onclick="closeProModal()">Èñâ„Åò„Çã</button>
      </div>
    </div>
  </div>

  <!-- ÊîØÊè¥Ê∏à„Åø„É¢„Éº„ÉÄ„É´ -->
  <div class="modal-overlay" id="proThanksModal">
    <div class="modal">
      <div class="modal-header">üéâ „ÅîÊîØÊè¥„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô</div>
      <div class="modal-body" style="text-align: center;">
        <div style="font-size: 48px; margin-bottom: 16px;">üíñ</div>
        <p style="font-size: 14px; color: #666; line-height: 1.8;">
          ‰ªäÂæå„ÇÇ„Çà„ÇäËâØ„ÅÑ„Ç¢„Éó„É™„ÇíÁõÆÊåá„Åó„Å¶<br>ÈñãÁô∫„ÇíÁ∂ö„Åë„Å¶„Åæ„ÅÑ„Çä„Åæ„Åô„ÄÇ
        </p>
      </div>
      <div class="modal-footer">
        <button class="modal-btn primary" onclick="closeProThanksModal()">Èñâ„Åò„Çã</button>
      </div>
    </div>
  </div>

  <!-- „Ç™„Éó„Ç∑„Éß„É≥„É°„Éã„É•„ÉºÔºà„Çπ„É©„Ç§„ÉâÂºè„ÉªÂÖ®„Çø„ÉñÂÖ±ÈÄöÔºâ -->
  <div class="options-menu" id="optionsMenu">
    <div class="options-menu-header" onclick="toggleOptionsMenu()" style="cursor: pointer;">
      <h2>„É°„Éã„É•„Éº</h2>
      <span style="font-size: 11px; opacity: 0.7; margin-top: 2px;" id="menuVersionDisplay"></span>
    </div>
    <!-- Ë™çË®º„Çª„ÇØ„Ç∑„Éß„É≥ -->
    <div class="menu-auth-section not-logged-in" id="menuAuthSection">
      <div class="menu-auth-status"><span>‚ö†Ô∏è</span><span id="menuAuthStatusText">„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÊú™Ë®≠ÂÆö</span></div>
      <div class="menu-auth-email" id="menuAuthEmail" style="display:none;"></div>
      <div class="menu-pro-badge" id="menuProBadge" style="display:none; font-size: 12px; color: #f39c12; margin-bottom: 8px;">üéâ ÊîØÊè¥Ê∏à„Åø</div>
      <button class="menu-auth-btn google" id="menuAuthButton" onclick="FirebaseSync.toggleAuth()">
        <svg width="16" height="16" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        Google„Åß„É≠„Ç∞„Ç§„É≥
      </button>
      <div class="menu-sync-status" id="menuSyncStatus"></div>
    </div>
    <div class="options-menu-list">
      <!-- ÂÖ±ÈÄö„É°„Éã„É•„Éº -->
      <div class="menu-section-label">ÂÖ±ÈÄö</div>
      <button onclick="openDesignModal(); toggleOptionsMenu();"><span class="icon">üé®</span>„Éá„Ç∂„Ç§„É≥Â§âÊõ¥</button>
      <button onclick="openContactModal(); toggleOptionsMenu();"><span class="icon">‚úâÔ∏è</span>„ÅäÂïè„ÅÑÂêà„Çè„Åõ</button>
      <button id="proMenuItem" onclick="openProModal(); toggleOptionsMenu();"><span class="icon">‚ú®</span>ÊîØÊè¥</button>
      
      <!-- „Ç∑„Éï„ÉàÂ∞ÇÁî®„É°„Éã„É•„Éº -->
      <div class="menu-section-label menu-shift-only">üìÖ „Ç∑„Éï„Éà</div>
      <button class="menu-shift-only" onclick="openStatusColorModal(); toggleOptionsMenu();"><span class="icon">üéØ</span>„Çπ„ÉÜ„Éº„Çø„ÇπËâ≤Ë®≠ÂÆö</button>
      <button class="menu-shift-only" onclick="triggerImport(); toggleOptionsMenu();"><span class="icon">üìÅ</span>„Ç§„É≥„Éù„Éº„Éà</button>
      <button class="menu-shift-only" onclick="exportData(); toggleOptionsMenu();"><span class="icon">üì§</span>„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
      <button class="menu-shift-only" onclick="updateHolidays(); toggleOptionsMenu();"><span class="icon">üîÑ</span>Á•ùÊó•„ÇíÊõ¥Êñ∞</button>
      
      <!-- ÂÆ∂Ë®àÁ∞øÂ∞ÇÁî®„É°„Éã„É•„Éº -->
      <div class="menu-section-label menu-kakeibo-only">üí∞ ÂÆ∂Ë®àÁ∞ø</div>
      <button class="menu-kakeibo-only" onclick="document.getElementById('kakeiboImportFile').click(); toggleOptionsMenu();"><span class="icon">üìÅ</span>„Ç§„É≥„Éù„Éº„Éà</button>
      <button class="menu-kakeibo-only" onclick="Kakeibo.exportData(); toggleOptionsMenu();"><span class="icon">üì§</span>„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
      <button class="menu-kakeibo-only" onclick="Kakeibo.toggleHistory(); toggleOptionsMenu();"><span class="icon">üìú</span>Â±•Ê≠¥</button>
      
      <!-- „É°„É¢Â∞ÇÁî®„É°„Éã„É•„Éº -->
      <div class="menu-section-label menu-memo-only">üìù „É°„É¢</div>
      <button class="menu-memo-only" onclick="document.getElementById('memoImportFile').click(); toggleOptionsMenu();"><span class="icon">üìÅ</span>„Ç§„É≥„Éù„Éº„Éà</button>
      <button class="menu-memo-only" onclick="Memo.exportData(); toggleOptionsMenu();"><span class="icon">üì§</span>„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
      <button class="menu-memo-only" onclick="Memo.toggleHistory(); toggleOptionsMenu();"><span class="icon">üìú</span>Â±•Ê≠¥</button>
    </div>
  </div>
</body>
</html>
